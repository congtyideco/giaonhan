<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đóng hàng & Giao hàng - KPI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        h1, h2, h3 {
            margin: 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .section-divider {
            margin: 20px 0;
            border-top: 1px solid #ddd;
        }
        
        /* Trạng thái đóng gói */
        .packing-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .packed {
            background-color: var(--success-color);
            color: white;
        }
        
        .not-packed {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Input groups */
        .address-group, .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .address-group input, .input-group input {
            flex: 1;
        }
        
        .map-btn, .add-btn {
            padding: 10px 12px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-btn {
            background-color: #34a853;
        }
        .map-btn:hover {
            background-color: #2d8e47;
        }
        .add-btn {
            background-color: var(--success-color);
        }
        .add-btn:hover {
             background-color: #27ae60;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .address-group {
                flex-direction: column;
                gap: 5px;
            }
            
            .map-btn, .add-btn {
                width: 100%;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Help button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        /* Help content */
        .help-content {
            line-height: 1.8;
        }
        
        .help-content h3 {
            margin-top: 15px;
            color: var(--primary-color);
        }
        
        .help-content ul {
            padding-left: 20px;
        }
        
        /* Autocomplete */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        
        .autocomplete-active {
            background-color: var(--primary-color) !important;
            color: #ffffff;
        }
        
        /* File upload */
        .file-upload-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
        }
        
        .file-upload-container p {
            margin-bottom: 10px;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .file-upload-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .customer-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>Quản lý Đóng hàng & Giao hàng - KPI kho vận (IDECO)</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="packing">Đóng hàng</div>
            <div class="tab" data-tab="delivery">Giao hàng</div>
            <div class="tab" data-tab="reports">Báo cáo</div>
            <div class="tab" data-tab="management">Quản lý</div>
            <div class="tab" data-tab="customer-data">Dữ liệu KH</div>
        </div>
        
        <div class="tab-content active" id="packing-tab">
            <div class="card">
                <h2>Nhập thông tin đóng hàng</h2>
                <div class="form-group">
                    <label for="packingOrderId">Mã đơn hàng:</label>
                    <input type="text" id="packingOrderId" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="form-group autocomplete">
                    <label for="packingCustomerName">Tên khách hàng:</label>
                    <input type="text" id="packingCustomerName" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="packingAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="packingAddress" required>
                        <button class="map-btn" onclick="viewOnMap('packingAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="packingDate">Ngày đóng hàng:</label>
                    <input type="date" id="packingDate" required>
                </div>
                <button class="btn btn-primary" onclick="savePacking()">
                    <i class="fas fa-box"></i> Xác nhận đơn đã đóng hàng xong
                </button>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayPackedCount">0</div>
                    <p>đơn đã đóng hàng</p>
                </div>
                <div class="stat-card">
                    <h3>Chờ giao</h3>
                    <div class="stat-value" id="waitingDeliveryCount">0</div>
                    <p>đơn sẵn sàng giao</p>
                </div>
                <div class="stat-card">
                    <h3>Đã giao</h3>
                    <div class="stat-value" id="deliveredCount">0</div>
                    <p>đơn đã giao</p>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="card">
                <h2>Danh sách đơn hàng đã đóng hôm nay</h2>
                <table id="packingTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="packingTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="delivery-tab">
            <div class="card">
                <h2>Nhập thông tin giao hàng</h2>
                <div class="form-group">
                    <label for="orderId">Mã đơn hàng:</label>
                    <input type="text" id="orderId" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="form-group">
                    <label for="deliveryDate">Ngày giao hàng:</label>
                    <input type="date" id="deliveryDate" required>
                </div>
                <div class="form-group autocomplete">
                    <label for="delivererName">Tên người giao:</label>
                    <div class="input-group">
                         <input type="text" id="delivererName" placeholder="Ví dụ: Anh A, Chị B" required autocomplete="off">
                         <button class="add-btn" onclick="showAddDelivererModal()" title="Thêm người giao mới">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group autocomplete">
                    <label for="customerName">Tên khách hàng:</label>
                    <input type="text" id="customerName" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="deliveryAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="deliveryAddress" required>
                        <button class="map-btn" onclick="viewOnMap('deliveryAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveDelivery()">
                    <i class="fas fa-save"></i> Giao xong - hay phải giao mới bấm lưu dữ liệu
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tuần này</h3>
                    <div class="stat-value" id="weeklyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tháng này</h3>
                    <div class="stat-value" id="monthlyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
            </div>
            
            <div class="card">
                <h2>Danh sách giao hàng hôm nay</h2>
                <table id="deliveryTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="reports-tab">
            <div class="card">
                <h2>Báo cáo giao hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="reportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="reportDate" class="form-control">
                        <input type="week" id="reportWeek" class="form-control" style="display: none;">
                        <input type="month" id="reportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="deliveryFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="deliveryToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generateDeliveryReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportDeliveryToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearDeliveryReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="reportSpinner"></div>
                
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        </tbody>
                </table>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h2>Báo cáo đóng hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="packingReportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="packingReportDate" class="form-control">
                        <input type="week" id="packingReportWeek" class="form-control" style="display: none;">
                        <input type="month" id="packingReportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="packingFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="packingToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generatePackingReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportPackingToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearPackingReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="packingReportSpinner"></div>
                
                <table id="packingReportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày đóng</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                            <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="packingReportTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="management-tab">
            <div class="card">
                <h2>Quản lý đơn hàng</h2>
                
                <div class="form-group">
                    <label for="searchOrder">Tìm kiếm đơn hàng:</label>
                    <div style="display: flex;">
                        <input type="text" id="searchOrder" placeholder="Nhập mã đơn hoặc tên KH">
                        <button class="btn btn-primary" onclick="searchOrders()" style="margin-left: 10px;">
                            <i class="fas fa-search"></i> Tìm
                        </button>
                    </div>
                </div>
                
                <table id="managementTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="managementTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="customer-data-tab">
            <div class="card">
                <h2>Quản lý dữ liệu khách hàng</h2>
                
                <div class="file-upload-container">
                    <p>Tải lên file Excel chứa dữ liệu khách hàng</p>
                    <p><small>File Excel cần có các cột: TênKhachHang, DiaChi (hoặc tên cột tương tự)</small></p>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls">
                    <label for="excelFile" class="file-upload-btn">
                        <i class="fas fa-upload"></i> Chọn file Excel
                    </label>
                    <button class="btn btn-primary" onclick="uploadExcel()" style="margin-left: 10px;">
                        <i class="fas fa-cloud-upload-alt"></i> Tải lên
                    </button>
                </div>
                
                <div class="customer-table-container">
                    <table id="customerTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên khách hàng</th>
                                <th>Địa chỉ</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">×</span>
            <h2>Chỉnh sửa đơn hàng</h2>
            <input type="hidden" id="editKey">
            <div class="form-group">
                <label for="editOrderId">Mã đơn hàng:</label>
                <input type="text" id="editOrderId" required oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="form-group">
                <label for="editDeliveryDate">Ngày giao hàng:</label>
                <input type="date" id="editDeliveryDate" required>
            </div>
            <div class="form-group autocomplete">
                <label for="editDelivererName">Tên người giao:</label>
                 <div class="input-group">
                    <input type="text" id="editDelivererName" required autocomplete="off">
                     <button class="add-btn" onclick="showAddDelivererModal()" title="Thêm người giao mới">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="form-group autocomplete">
                <label for="editCustomerName">Tên khách hàng:</label>
                <input type="text" id="editCustomerName" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="editDeliveryAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editDeliveryAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editDeliveryAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="updateDelivery()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeleteDelivery(currentEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <div id="editPackingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePackingModal()">×</span>
            <h2>Chỉnh sửa đơn đóng hàng</h2>
            <input type="hidden" id="editPackingKey">
            <div class="form-group">
                <label for="editPackingOrderId">Mã đơn hàng:</label>
                <input type="text" id="editPackingOrderId" required oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="form-group autocomplete">
                <label for="editPackingCustomerName">Tên khách hàng:</label>
                <input type="text" id="editPackingCustomerName" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="editPackingAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editPackingAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editPackingAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="editPackingDate">Ngày đóng hàng:</label>
                <input type="date" id="editPackingDate" required>
            </div>
            <div class="form-group">
                <label for="editPackingStatus">Trạng thái giao hàng:</label>
                <select id="editPackingStatus" class="form-control">
                    <option value="false">Chờ giao</option>
                    <option value="true">Đã giao</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="updatePacking()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeletePacking(currentPackingEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <div id="transferConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeTransferConfirmModal()">×</span>
             <h2>EM NÊN ĐỌC NỘI DUNG SAU CẨN THẬN !</h2>
            <p style="margin-top:10px; white-space: pre-line;">
Em đã sẵn sàng mang đi giao hàng hay đơn vị giao đến nhận ngay chưa ? kiểm tra lại lộ trình chưa ?báo nhiêu kiện cho đơn này?
Khi giao hàng đảm bảo thùng hàng có tem nhãn ghi chính xác không? có hóa đơn, đơn hàng kèm  theo thùng chưa? phải đảm bảo đầy dủ
Nếu đã bấm chuyển giao hàng thì phải hoàn thành giao hàng ngay tránh đơn hàng khai báo bị trôi tin, sót đơn trên ứng dụng
Hàng giao phải xem lại thông tin giao, thanh toán. Dù bất cứ nhân viên nào đang thu lý giao phải khai thông tin giao mới được giao hàng.
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTransferConfirmModal()">Hủy</button>
                <button class="btn btn-primary" id="confirmTransferBtn">Đồng ý</button>
            </div>
        </div>
    </div>

    <div id="addDelivererModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddDelivererModal()">×</span>
            <h2>Thêm người giao hàng mới</h2>
            <div class="form-group">
                <label for="newDelivererName">Tên người giao:</label>
                <input type="text" id="newDelivererName" placeholder="Nhập tên người giao" required>
            </div>
            <div class="modal-actions">
                 <button class="btn" onclick="closeAddDelivererModal()" style="background-color: #ccc;">Hủy</button>
                <button class="btn btn-primary" onclick="saveDeliverer()">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>
    
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHelpModal()">×</span>
            <h2>Hướng dẫn sử dụng</h2>
            <div class="help-content">
                <h3>1. Phần này do: Điều phối kho đảm nhận khai báo - ngoài ra Quản lý kho vận cũng được tham gia </h3>
                <ul>
                    <li>Sau khi mọi đơn hàng đã được đóng xong sẵn sàng giao ra kho thì phải khai báo ngay trước khi ra khỏi kho</li>
                    <li>Mã đơn hàng từ đơn hàng ERP in ra và nhập đúng chính xác</li>
                    <li>Thông tin tên khách hàng- địa chỉ giao hàng phải điền đủ hay chỉnh lại đúng sau đó</li>
                    <li>Khi đóng hàng đơn hàng này thì xử lý xong rồi bấm đã xong đóng gói</li>
                    <li>Trạng thái báo: đang chờ màu đỏ tức là tình trạnh đơn chưa được giao đang tạm lưu kho</li>
                </ul>
                
                <h3>2. Giao hàng -Phần này do phụ trách điều phối vận chuyển- giao hàng hay người hỗ trợ giao hàng thực hiện</h3>
                <ul>
                    <li>Nhập: Mã đơn, ngày giao, <b>tên người giao</b>, tên khách hàng và địa chỉ</li>
                    <li>Nhấn nút "+" bên cạnh ô "Tên người giao" để thêm người giao hàng mới vào danh sách.</li>
                    <li>Khi gõ tên người giao, hệ thống sẽ gợi ý các tên đã lưu.</li>
                    <li>Nhấn nút bản đồ để kiểm tra địa chỉ giao hàng trên Google Maps</li>
                    <li>Chỉ nhấn "Giao xong" khi đơn hàng đã được giao thành công</li>
                    <li>Đảm bảo thông tin chính xác trước khi lưu</li>
                </ul>
                
                <h3>3. Báo cáo</h3>
                <ul>
                    <li>Chọn loại báo cáo (ngày/tuần/tháng) hoặc khoảng thời gian cụ thể</li>
                    <li>Nhấn "Tạo báo cáo" để xem dữ liệu</li>
                    <li>Xuất Excel để tải báo cáo về máy tính</li>
                    <li>Xóa báo cáo để xóa dữ liệu đã chọn</li>
                </ul>
                
                <h3>4. Quản lý</h3>
                <ul>
                    <li>Tìm kiếm đơn hàng theo mã đơn hoặc tên khách hàng</li>
                    <li>Chỉnh sửa hoặc xóa đơn hàng nếu có sai sót</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="help-btn" onclick="showHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <script>
          const firebaseConfig = { 
  apiKey : "AIzaSyA2Xa3zF8CCOccQhq7nvqooUTabnq5N4qM" , 
  authDomain : "quanlykho-21f95.firebaseapp.com" , 
  projectId : "quanlykho-21f95" , 
  storageBucket : "quanlykho-21f95.appspot.com" , 
  messagingSenderId : "1082567127195" , 
  appId : "1:1082567127195:web:dfec69dab7d492c095563e" , 
  measurementId : "G-RCXEM8VP68" 
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Biến toàn cục
        let currentEditKey = null;
        let currentPackingEditKey = null;
        let customerData = [];
        let delivererData = []; // NEW: To store deliverer names
        
        // Khởi tạo khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            // Thiết lập ngày hiện tại cho các trường ngày
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').value = today;
            document.getElementById('packingDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('packingReportDate').value = today;
            
            // Tải dữ liệu
            loadDeliveryData();
            loadPackingData();
            loadCustomerData();
            loadDelivererData(); // NEW: Load deliverer data
            
            // Thiết lập sự kiện cho các tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Thiết lập sự kiện cho loại báo cáo
            document.getElementById('reportType').addEventListener('change', function() {
                toggleReportInputs(this.value, 'report');
            });
            
            document.getElementById('packingReportType').addEventListener('change', function() {
                toggleReportInputs(this.value, 'packingReport');
            });
            
            // Thiết lập autocomplete
            initCustomerAutocomplete();
            initDelivererAutocomplete(); // NEW: Init deliverer autocomplete
        });
        
        // Chuyển đổi tab
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabId}-tab`).classList.add('active');
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) tab.classList.add('active');
            });
        }
        
        // Tự động chuyển đổi mã đơn hàng thành chữ HOA
        function autoUppercaseOrderId() {
            ['orderId', 'packingOrderId', 'editOrderId', 'editPackingOrderId'].forEach(id => {
                 const input = document.getElementById(id);
                 if(input) {
                    input.addEventListener('input', function() { this.value = this.value.toUpperCase(); });
                 }
            });
        }
        
        // Lưu dữ liệu giao hàng
        function saveDelivery() {
            const orderId = document.getElementById('orderId').value.toUpperCase();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const delivererName = document.getElementById('delivererName').value;
            const customerName = document.getElementById('customerName').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            showTransferConfirmModal(() => {
                const deliveryData = {
                    orderId, deliveryDate, delivererName, customerName, deliveryAddress,
                    timestamp: new Date().toISOString()
                };
                
                database.ref('deliveries').push().set(deliveryData)
                    .then(() => {
                        alert('Đã lưu thông tin giao hàng thành công!');
                        document.getElementById('orderId').value = '';
                        document.getElementById('customerName').value = '';
                        document.getElementById('deliveryAddress').value = '';
                        document.getElementById('delivererName').value = '';
                        loadDeliveryData();
                    })
                    .catch(error => alert('Có lỗi xảy ra khi lưu dữ liệu: ' + error.message));
            });
        }
        
        // Lưu dữ liệu đóng hàng
        function savePacking() {
            const orderId = document.getElementById('packingOrderId').value.toUpperCase();
            const customerName = document.getElementById('packingCustomerName').value;
            const address = document.getElementById('packingAddress').value;
            const packingDate = document.getElementById('packingDate').value;
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const packingData = {
                orderId, customerName, address, packingDate,
                isDelivered: false,
                timestamp: new Date().toISOString()
            };
            
            database.ref('packings').push().set(packingData)
                .then(() => {
                    alert('Đã lưu thông tin đóng hàng thành công!');
                    document.getElementById('packingOrderId').value = '';
                    document.getElementById('packingCustomerName').value = '';
                    document.getElementById('packingAddress').value = '';
                    loadPackingData();
                })
                .catch(error => alert('Có lỗi xảy ra khi lưu dữ liệu: ' + error.message));
        }
        
        // Tải dữ liệu giao hàng
        function loadDeliveryData() {
            const today = new Date().toISOString().split('T')[0];
            const deliveryTableBody = document.getElementById('deliveryTableBody');
            deliveryTableBody.innerHTML = '';
            
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let todayCount = 0, weeklyCount = 0, monthlyCount = 0;
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                    startOfWeek.setHours(0,0,0,0);
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        const deliveryDate = new Date(delivery.deliveryDate);
                        
                        if (delivery.deliveryDate === today) todayCount++;
                        if (deliveryDate >= startOfWeek) weeklyCount++;
                        if (deliveryDate >= startOfMonth) monthlyCount++;
                        
                        if (delivery.deliveryDate === today) {
                            const row = deliveryTableBody.insertRow();
                            row.innerHTML = `
                                <td>${delivery.orderId}</td>
                                <td>${delivery.delivererName}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td class="action-btns">
                                    <button class="btn btn-sm btn-warning" onclick="editDelivery('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                </td>`;
                        }
                    });
                    
                    document.getElementById('todayCount').textContent = todayCount;
                    document.getElementById('weeklyCount').textContent = weeklyCount;
                    document.getElementById('monthlyCount').textContent = monthlyCount;
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu giao hàng:', error));
        }
        
        // Tải dữ liệu đóng hàng
        function loadPackingData() {
            const today = new Date().toISOString().split('T')[0];
            const packingTableBody = document.getElementById('packingTableBody');
            packingTableBody.innerHTML = '';
            
            database.ref('packings').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let todayPackedCount = 0, waitingDeliveryCount = 0, deliveredCount = 0;
                    
                    snapshot.forEach(childSnapshot => {
                        const packing = childSnapshot.val();
                        if (packing.packingDate === today) todayPackedCount++;
                        if (!packing.isDelivered) waitingDeliveryCount++; else deliveredCount++;
                        
                        if (packing.packingDate === today) {
                            const row = packingTableBody.insertRow();
                            const statusClass = packing.isDelivered ? 'packed' : 'not-packed';
                            const statusText = packing.isDelivered ? 'Đã giao' : 'Chờ giao';
                            row.innerHTML = `
                                <td>${packing.orderId}</td>
                                <td>${packing.customerName}</td>
                                <td>${packing.address}</td>
                                <td><span class="packing-status ${statusClass}">${statusText}</span></td>
                                <td class="action-btns">
                                    <button class="btn btn-sm btn-warning" onclick="editPacking('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                </td>`;
                        }
                    });
                    
                    document.getElementById('todayPackedCount').textContent = todayPackedCount;
                    document.getElementById('waitingDeliveryCount').textContent = waitingDeliveryCount;
                    document.getElementById('deliveredCount').textContent = deliveredCount;
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu đóng hàng:', error));
        }

        // NEW: Tải dữ liệu người giao hàng
        function loadDelivererData() {
            database.ref('deliverers').once('value')
                .then(snapshot => {
                    delivererData = [];
                    snapshot.forEach(childSnapshot => {
                        delivererData.push(childSnapshot.val());
                    });
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu người giao:', error));
        }
        
        // Chỉnh sửa giao hàng
        function editDelivery(key) {
            currentEditKey = key;
            database.ref('deliveries/' + key).once('value')
                .then(snapshot => {
                    const delivery = snapshot.val();
                    document.getElementById('editKey').value = key;
                    document.getElementById('editOrderId').value = delivery.orderId;
                    document.getElementById('editDeliveryDate').value = delivery.deliveryDate;
                    document.getElementById('editDelivererName').value = delivery.delivererName;
                    document.getElementById('editCustomerName').value = delivery.customerName;
                    document.getElementById('editDeliveryAddress').value = delivery.deliveryAddress;
                    document.getElementById('editModal').style.display = 'block';
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu chỉnh sửa:', error));
        }
        
        // Chỉnh sửa đóng hàng
        function editPacking(key) {
            currentPackingEditKey = key;
            database.ref('packings/' + key).once('value')
                .then(snapshot => {
                    const packing = snapshot.val();
                    document.getElementById('editPackingKey').value = key;
                    document.getElementById('editPackingOrderId').value = packing.orderId;
                    document.getElementById('editPackingCustomerName').value = packing.customerName;
                    document.getElementById('editPackingAddress').value = packing.address;
                    document.getElementById('editPackingDate').value = packing.packingDate;
                    document.getElementById('editPackingStatus').value = packing.isDelivered;
                    document.getElementById('editPackingModal').style.display = 'block';
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu chỉnh sửa:', error));
        }
        
        // Cập nhật giao hàng
        function updateDelivery() {
            const key = document.getElementById('editKey').value;
            const orderId = document.getElementById('editOrderId').value.toUpperCase();
            const deliveryDate = document.getElementById('editDeliveryDate').value;
            const delivererName = document.getElementById('editDelivererName').value;
            const customerName = document.getElementById('editCustomerName').value;
            const deliveryAddress = document.getElementById('editDeliveryAddress').value;
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const updatedData = {
                orderId, deliveryDate, delivererName, customerName, deliveryAddress,
                timestamp: new Date().toISOString()
            };
            
            database.ref('deliveries/' + key).update(updatedData)
                .then(() => {
                    alert('Đã cập nhật thông tin giao hàng thành công!');
                    closeModal();
                    loadDeliveryData();
                })
                .catch(error => alert('Có lỗi xảy ra khi cập nhật dữ liệu: ' + error.message));
        }
        
        // Cập nhật đóng hàng
        function updatePacking() {
            const key = document.getElementById('editPackingKey').value;
            const orderId = document.getElementById('editPackingOrderId').value.toUpperCase();
            const customerName = document.getElementById('editPackingCustomerName').value;
            const address = document.getElementById('editPackingAddress').value;
            const packingDate = document.getElementById('editPackingDate').value;
            const isDelivered = document.getElementById('editPackingStatus').value === 'true';
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const updatedData = {
                orderId, customerName, address, packingDate, isDelivered,
                timestamp: new Date().toISOString()
            };
            
            database.ref('packings/' + key).update(updatedData)
                .then(() => {
                    alert('Đã cập nhật thông tin đóng hàng thành công!');
                    closePackingModal();
                    loadPackingData();
                })
                .catch(error => alert('Có lỗi xảy ra khi cập nhật dữ liệu: ' + error.message));
        }
        
        // Xác nhận xóa & Xóa
        function confirmDeleteDelivery(key) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) deleteDelivery(key);
        }
        function deleteDelivery(key) {
            database.ref('deliveries/' + key).remove()
                .then(() => { alert('Đã xóa đơn hàng thành công!'); closeModal(); loadDeliveryData(); })
                .catch(error => alert('Có lỗi xảy ra khi xóa dữ liệu: ' + error.message));
        }

        function confirmDeletePacking(key) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) deletePacking(key);
        }
        function deletePacking(key) {
            database.ref('packings/' + key).remove()
                .then(() => { alert('Đã xóa đơn hàng thành công!'); closePackingModal(); loadPackingData(); })
                .catch(error => alert('Có lỗi xảy ra khi xóa dữ liệu: ' + error.message));
        }
        
        // Modal controls
        function closeModal() { document.getElementById('editModal').style.display = 'none'; }
        function closePackingModal() { document.getElementById('editPackingModal').style.display = 'none'; }
        function showTransferConfirmModal(callback) {
            const modal = document.getElementById('transferConfirmModal');
            modal.style.display = 'block';
            document.getElementById('confirmTransferBtn').onclick = () => { modal.style.display = 'none'; callback(); };
        }
        function closeTransferConfirmModal() { document.getElementById('transferConfirmModal').style.display = 'none'; }
        function showHelpModal() { document.getElementById('helpModal').style.display = 'block'; }
        function closeHelpModal() { document.getElementById('helpModal').style.display = 'none'; }
        
        // NEW: Modal controls for adding deliverer
        function showAddDelivererModal() { document.getElementById('addDelivererModal').style.display = 'block'; }
        function closeAddDelivererModal() { document.getElementById('addDelivererModal').style.display = 'none'; }

        // NEW: Save new deliverer
        function saveDeliverer() {
            const newNameInput = document.getElementById('newDelivererName');
            const newName = newNameInput.value.trim();

            if (!newName) {
                alert('Vui lòng nhập tên người giao!');
                return;
            }

            const isDuplicate = delivererData.some(d => d.name.toLowerCase() === newName.toLowerCase());
            if (isDuplicate) {
                alert('Tên người giao đã tồn tại!');
                return;
            }

            const deliverer = { name: newName, timestamp: new Date().toISOString() };
            database.ref('deliverers').push(deliverer)
                .then(() => {
                    alert('Đã thêm người giao mới thành công!');
                    newNameInput.value = '';
                    closeAddDelivererModal();
                    loadDelivererData();
                })
                .catch(error => alert('Lỗi khi lưu: ' + error.message));
        }

        // Xem địa chỉ trên bản đồ
        function viewOnMap(addressFieldId) {
            const address = document.getElementById(addressFieldId).value;
            if (!address) { alert('Vui lòng nhập địa chỉ trước!'); return; }
            window.open(`https://maps.google.com/?q=${encodeURIComponent(address)}`, '_blank');
        }
        
        // Báo cáo Giao hàng
        function generateDeliveryReport() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('deliveryFromDate').value;
            const toDate = document.getElementById('deliveryToDate').value;
            let startDate, endDate;

            if (fromDate && toDate) {
                startDate = new Date(fromDate);
                endDate = new Date(toDate);
            } else {
                const now = new Date();
                switch (reportType) {
                    case 'daily': startDate = new Date(document.getElementById('reportDate').value); endDate = new Date(startDate); break;
                    case 'weekly': const weekVal = document.getElementById('reportWeek').value; startDate = new Date(weekVal); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); break;
                    case 'monthly': const monthVal = document.getElementById('reportMonth').value; startDate = new Date(monthVal); endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0); break;
                }
            }
             endDate.setHours(23, 59, 59, 999);

            document.getElementById('reportSpinner').style.display = 'block';
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const reportTableBody = document.getElementById('reportTableBody');
                    reportTableBody.innerHTML = '';
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        const deliveryDate = new Date(delivery.deliveryDate);
                        if (deliveryDate >= startDate && deliveryDate <= endDate) {
                            count++;
                            const row = reportTableBody.insertRow();
                            row.innerHTML = `<td>${count}</td><td>${delivery.orderId}</td><td>${delivery.deliveryDate}</td><td>${delivery.delivererName}</td><td>${delivery.customerName}</td><td>${delivery.deliveryAddress}</td><td><button class="btn btn-sm btn-danger" onclick="confirmDeleteDelivery('${childSnapshot.key}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
                        }
                    });
                    if (count === 0) reportTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Không có dữ liệu</td></tr>';
                    document.getElementById('reportSpinner').style.display = 'none';
                })
                .catch(error => { console.error('Lỗi khi tạo báo cáo:', error); document.getElementById('reportSpinner').style.display = 'none'; });
        }
        
        // Báo cáo Đóng hàng
        function generatePackingReport() {
            const reportType = document.getElementById('packingReportType').value;
            const fromDate = document.getElementById('packingFromDate').value;
            const toDate = document.getElementById('packingToDate').value;
            let startDate, endDate;

            if (fromDate && toDate) {
                 startDate = new Date(fromDate);
                 endDate = new Date(toDate);
            } else {
                 const now = new Date();
                switch (reportType) {
                    case 'daily': startDate = new Date(document.getElementById('packingReportDate').value); endDate = new Date(startDate); break;
                    case 'weekly': const weekVal = document.getElementById('packingReportWeek').value; startDate = new Date(weekVal); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); break;
                    case 'monthly': const monthVal = document.getElementById('packingReportMonth').value; startDate = new Date(monthVal); endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0); break;
                }
            }
             endDate.setHours(23, 59, 59, 999);

            document.getElementById('packingReportSpinner').style.display = 'block';
            database.ref('packings').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const reportTableBody = document.getElementById('packingReportTableBody');
                    reportTableBody.innerHTML = '';
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const packing = childSnapshot.val();
                        const packingDate = new Date(packing.packingDate);
                        if (packingDate >= startDate && packingDate <= endDate) {
                            count++;
                            const row = reportTableBody.insertRow();
                            const statusClass = packing.isDelivered ? 'packed' : 'not-packed';
                            const statusText = packing.isDelivered ? 'Đã giao' : 'Chờ giao';
                            row.innerHTML = `<td>${count}</td><td>${packing.orderId}</td><td>${packing.packingDate}</td><td>${packing.customerName}</td><td>${packing.address}</td><td><span class="packing-status ${statusClass}">${statusText}</span></td><td><button class="btn btn-sm btn-danger" onclick="confirmDeletePacking('${childSnapshot.key}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
                        }
                    });
                     if (count === 0) reportTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Không có dữ liệu</td></tr>';
                    document.getElementById('packingReportSpinner').style.display = 'none';
                })
                .catch(error => { console.error('Lỗi khi tạo báo cáo:', error); document.getElementById('packingReportSpinner').style.display = 'none'; });
        }
        
        // Xóa báo cáo
        function clearDeliveryReport() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu giao hàng?')) {
                database.ref('deliveries').remove().then(() => { alert('Đã xóa tất cả dữ liệu giao hàng!'); loadDeliveryData(); document.getElementById('reportTableBody').innerHTML = ''; });
            }
        }
        function clearPackingReport() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu đóng hàng?')) {
                database.ref('packings').remove().then(() => { alert('Đã xóa tất cả dữ liệu đóng hàng!'); loadPackingData(); document.getElementById('packingReportTableBody').innerHTML = ''; });
            }
        }
        
        // Xuất Excel
        function exportDeliveryToExcel() {
            const table = document.getElementById('reportTable');
            if (table.rows.length <= 1) { alert('Không có dữ liệu để xuất!'); return; }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Báo cáo giao hàng');
            XLSX.writeFile(wb, 'bao_cao_giao_hang.xlsx');
        }
        function exportPackingToExcel() {
            const table = document.getElementById('packingReportTable');
            if (table.rows.length <= 1) { alert('Không có dữ liệu để xuất!'); return; }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Báo cáo đóng hàng');
            XLSX.writeFile(wb, 'bao_cao_dong_hang.xlsx');
        }
        
        // Tìm kiếm đơn hàng
        function searchOrders() {
            const searchTerm = document.getElementById('searchOrder').value.toLowerCase();
            const managementTableBody = document.getElementById('managementTableBody');
            managementTableBody.innerHTML = '';
            
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let found = false;
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        if (delivery.orderId.toLowerCase().includes(searchTerm) || delivery.customerName.toLowerCase().includes(searchTerm)) {
                            found = true;
                            const row = managementTableBody.insertRow();
                            row.innerHTML = `<td>${delivery.orderId}</td><td>${delivery.deliveryDate}</td><td>${delivery.delivererName}</td><td>${delivery.customerName}</td><td>${delivery.deliveryAddress}</td><td class="action-btns"><button class="btn btn-sm btn-warning" onclick="editDelivery('${childSnapshot.key}')"><i class="fas fa-edit"></i> Sửa</button><button class="btn btn-sm btn-danger" onclick="confirmDeleteDelivery('${childSnapshot.key}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
                        }
                    });
                    if (!found) managementTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Không tìm thấy đơn hàng</td></tr>';
                });
        }
        
        // Chuyển đổi hiển thị input báo cáo
        function toggleReportInputs(reportType, prefix) {
            document.getElementById(`${prefix}Date`).style.display = reportType === 'daily' ? 'block' : 'none';
            document.getElementById(`${prefix}Week`).style.display = reportType === 'weekly' ? 'block' : 'none';
            document.getElementById(`${prefix}Month`).style.display = reportType === 'monthly' ? 'block' : 'none';
        }
        
        // Dữ liệu khách hàng
        function loadCustomerData() {
            database.ref('customers').once('value')
                .then(snapshot => {
                    customerData = [];
                    const customerTableBody = document.getElementById('customerTableBody');
                    customerTableBody.innerHTML = '';
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const customer = childSnapshot.val();
                        customerData.push(customer);
                        count++;
                        const row = customerTableBody.insertRow();
                        row.innerHTML = `<td>${count}</td><td>${customer.name}</td><td>${customer.address}</td><td><button class="btn btn-sm btn-danger" onclick="deleteCustomer('${childSnapshot.key}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
                    });
                     if (count === 0) customerTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Chưa có dữ liệu khách hàng</td></tr>';
                });
        }
        
        function deleteCustomer(key) {
            if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                database.ref('customers/' + key).remove().then(() => { alert('Đã xóa khách hàng thành công!'); loadCustomerData(); });
            }
        }
        
        function uploadExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) { alert('Vui lòng chọn file Excel!'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length === 0) { alert('File Excel không có dữ liệu!'); return; }

                let nameKey, addressKey;
                for (let key in jsonData[0]) {
                    if (key.toLowerCase().includes('tên') || key.toLowerCase().includes('name')) nameKey = key;
                    if (key.toLowerCase().includes('địa chỉ') || key.toLowerCase().includes('address')) addressKey = key;
                }
                if (!nameKey || !addressKey) { alert('Không tìm thấy cột Tên và Địa chỉ trong file Excel!'); return; }
                
                let successCount = 0;
                jsonData.forEach((row, index) => {
                    if (row[nameKey] && row[addressKey]) {
                        database.ref('customers').push({ name: row[nameKey], address: row[addressKey], timestamp: new Date().toISOString() })
                            .then(() => successCount++)
                            .finally(() => {
                                if (index === jsonData.length - 1) {
                                    alert(`Đã tải lên ${successCount} khách hàng.`);
                                    loadCustomerData();
                                }
                            });
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Autocomplete
        function initCustomerAutocomplete() {
            const inputs = [
                document.getElementById('customerName'),
                document.getElementById('packingCustomerName'),
                document.getElementById('editCustomerName'),
                document.getElementById('editPackingCustomerName')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        const val = this.value;
                        closeAllLists();
                        if (!val) return false;

                        const list = document.createElement('div');
                        list.setAttribute('id', this.id + '-autocomplete-list');
                        list.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(list);
                        
                        customerData
                            .filter(c => c.name.toLowerCase().includes(val.toLowerCase()))
                            .forEach(customer => {
                                const item = document.createElement('div');
                                item.innerHTML = `<strong>${customer.name}</strong> - ${customer.address}<input type='hidden' value='${customer.name}'>`;
                                item.addEventListener('click', function() {
                                    input.value = this.getElementsByTagName('input')[0].value;
                                    const customerInfo = customerData.find(c => c.name === input.value);
                                    if(customerInfo) {
                                        let addressField;
                                        if (input.id.includes('packing')) {
                                            addressField = document.getElementById(input.id.replace('CustomerName', 'Address'));
                                        } else {
                                             addressField = document.getElementById(input.id.replace('customerName', 'deliveryAddress'));
                                        }
                                        if(addressField) addressField.value = customerInfo.address;
                                    }
                                    closeAllLists();
                                });
                                list.appendChild(item);
                            });
                    });
                }
            });
        }

        // NEW: Autocomplete for deliverers
        function initDelivererAutocomplete() {
            const inputs = [
                document.getElementById('delivererName'),
                document.getElementById('editDelivererName')
            ];

            inputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        const val = this.value;
                        closeAllLists();
                        if (!val) return false;

                        const list = document.createElement('div');
                        list.setAttribute('id', this.id + '-autocomplete-list');
                        list.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(list);

                        delivererData
                            .filter(d => d.name.toLowerCase().includes(val.toLowerCase()))
                            .forEach(deliverer => {
                                const item = document.createElement('div');
                                item.innerHTML = `<strong>${deliverer.name}</strong><input type='hidden' value='${deliverer.name}'>`;
                                item.addEventListener('click', function() {
                                    input.value = this.getElementsByTagName('input')[0].value;
                                    closeAllLists();
                                });
                                list.appendChild(item);
                            });
                    });
                }
            });
        }
        
        function closeAllLists(elmnt) {
            const items = document.getElementsByClassName('autocomplete-items');
            for (let i = 0; i < items.length; i++) {
                if (elmnt !== items[i] && elmnt !== items[i].parentNode.getElementsByTagName('input')[0]) {
                    items[i].parentNode.removeChild(items[i]);
                }
            }
        }
        document.addEventListener('click', (e) => closeAllLists(e.target));
        
        autoUppercaseOrderId();
    </script>
</body>
</html>
