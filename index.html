<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đóng hàng & Giao hàng - KPI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        h1, h2, h3 {
            margin: 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .section-divider {
            margin: 20px 0;
            border-top: 1px solid #ddd;
        }
        
        /* Trạng thái đóng gói */
        .packing-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .packed {
            background-color: var(--success-color);
            color: white;
        }
        
        .not-packed {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Địa chỉ với nút bản đồ */
        .address-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .address-group input {
            flex: 1;
        }
        
        .map-btn {
            padding: 10px 12px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-btn:hover {
            background-color: #2d8e47;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .address-group {
                flex-direction: column;
                gap: 5px;
            }
            
            .map-btn {
                width: 100%;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Help button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        /* Help content */
        .help-content {
            line-height: 1.8;
        }
        
        .help-content h3 {
            margin-top: 15px;
            color: var(--primary-color);
        }
        
        .help-content ul {
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>Quản lý Đóng hàng & Giao hàng - KPI kho vận (IDECO)</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="packing">Đóng hàng</div>
            <div class="tab" data-tab="delivery">Giao hàng</div>
            <div class="tab" data-tab="reports">Báo cáo</div>
            <div class="tab" data-tab="management">Quản lý</div>
        </div>
        
        <!-- Tab Đóng hàng -->
        <div class="tab-content active" id="packing-tab">
            <div class="card">
                <h2>Nhập thông tin đóng hàng</h2>
                <div class="form-group">
                    <label for="packingOrderId">Mã đơn hàng:</label>
                    <input type="text" id="packingOrderId" required>
                </div>
                <div class="form-group">
                    <label for="packingCustomerName">Tên khách hàng:</label>
                    <input type="text" id="packingCustomerName" required>
                </div>
                <div class="form-group">
                    <label for="packingAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="packingAddress" required>
                        <button class="map-btn" onclick="viewOnMap('packingAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="packingDate">Ngày đóng hàng:</label>
                    <input type="date" id="packingDate" required>
                </div>
                <button class="btn btn-primary" onclick="savePacking()">
                    <i class="fas fa-box"></i> Xác nhận đóng hàng
                </button>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayPackedCount">0</div>
                    <p>đơn đã đóng hàng</p>
                </div>
                <div class="stat-card">
                    <h3>Chờ giao</h3>
                    <div class="stat-value" id="waitingDeliveryCount">0</div>
                    <p>đơn sẵn sàng giao</p>
                </div>
                <div class="stat-card">
                    <h3>Đã giao</h3>
                    <div class="stat-value" id="deliveredCount">0</div>
                    <p>đơn đã giao</p>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="card">
                <h2>Danh sách đơn hàng đã đóng hôm nay</h2>
                <table id="packingTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="packingTableBody">
                        <!-- Dữ liệu sẽ được thêm tự động -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Giao hàng -->
        <div class="tab-content" id="delivery-tab">
            <div class="card">
                <h2>Nhập thông tin giao hàng</h2>
                <div class="form-group">
                    <label for="orderId">Mã đơn hàng:</label>
                    <input type="text" id="orderId" required>
                </div>
                <div class="form-group">
                    <label for="deliveryDate">Ngày giao hàng:</label>
                    <input type="date" id="deliveryDate" required>
                </div>
                <div class="form-group">
                    <label for="delivererName">Tên người giao:</label>
                    <input type="text" id="delivererName" placeholder="Ví dụ: Anh A, Chị B" required>
                </div>
                <div class="form-group">
                    <label for="customerName">Tên khách hàng:</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="deliveryAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="deliveryAddress" required>
                        <button class="map-btn" onclick="viewOnMap('deliveryAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveDelivery()">
                    <i class="fas fa-save"></i> Lưu thông tin
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tuần này</h3>
                    <div class="stat-value" id="weeklyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tháng này</h3>
                    <div class="stat-value" id="monthlyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
            </div>
            
            <div class="card">
                <h2>Danh sách giao hàng hôm nay</h2>
                <table id="deliveryTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryTableBody">
                        <!-- Dữ liệu sẽ được thêm tự động -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Báo cáo -->
        <div class="tab-content" id="reports-tab">
            <div class="card">
                <h2>Báo cáo giao hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="reportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="reportDate" class="form-control">
                        <input type="week" id="reportWeek" class="form-control" style="display: none;">
                        <input type="month" id="reportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="deliveryFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="deliveryToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generateDeliveryReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportDeliveryToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearDeliveryReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="reportSpinner"></div>
                
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Dữ liệu báo cáo sẽ được thêm ở đây -->
                    </tbody>
                </table>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h2>Báo cáo đóng hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="packingReportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="packingReportDate" class="form-control">
                        <input type="week" id="packingReportWeek" class="form-control" style="display: none;">
                        <input type="month" id="packingReportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="packingFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="packingToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generatePackingReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportPackingToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearPackingReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="packingReportSpinner"></div>
                
                <table id="packingReportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày đóng</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                        </tr>
                    </thead>
                    <tbody id="packingReportTableBody">
                        <!-- Dữ liệu báo cáo sẽ được thêm ở đây -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Quản lý -->
        <div class="tab-content" id="management-tab">
            <div class="card">
                <h2>Quản lý đơn hàng</h2>
                
                <div class="form-group">
                    <label for="searchOrder">Tìm kiếm đơn hàng:</label>
                    <div style="display: flex;">
                        <input type="text" id="searchOrder" placeholder="Nhập mã đơn hoặc tên KH">
                        <button class="btn btn-primary" onclick="searchOrders()" style="margin-left: 10px;">
                            <i class="fas fa-search"></i> Tìm
                        </button>
                    </div>
                </div>
                
                <table id="managementTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="managementTableBody">
                        <!-- Dữ liệu quản lý sẽ được thêm ở đây -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal chỉnh sửa giao hàng -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Chỉnh sửa đơn hàng</h2>
            <input type="hidden" id="editKey">
            <div class="form-group">
                <label for="editOrderId">Mã đơn hàng:</label>
                <input type="text" id="editOrderId" required>
            </div>
            <div class="form-group">
                <label for="editDeliveryDate">Ngày giao hàng:</label>
                <input type="date" id="editDeliveryDate" required>
            </div>
            <div class="form-group">
                <label for="editDelivererName">Tên người giao:</label>
                <input type="text" id="editDelivererName" required>
            </div>
            <div class="form-group">
                <label for="editCustomerName">Tên khách hàng:</label>
                <input type="text" id="editCustomerName" required>
            </div>
            <div class="form-group">
                <label for="editDeliveryAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editDeliveryAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editDeliveryAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="updateDelivery()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeleteDelivery(currentEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <!-- Modal chỉnh sửa đóng hàng -->
    <div id="editPackingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePackingModal()">&times;</span>
            <h2>Chỉnh sửa đơn đóng hàng</h2>
            <input type="hidden" id="editPackingKey">
            <div class="form-group">
                <label for="editPackingOrderId">Mã đơn hàng:</label>
                <input type="text" id="editPackingOrderId" required>
            </div>
            <div class="form-group">
                <label for="editPackingCustomerName">Tên khách hàng:</label>
                <input type="text" id="editPackingCustomerName" required>
            </div>
            <div class="form-group">
                <label for="editPackingAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editPackingAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editPackingAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="editPackingDate">Ngày đóng hàng:</label>
                <input type="date" id="editPackingDate" required>
            </div>
            <div class="form-group">
                <label for="editPackingStatus">Trạng thái giao hàng:</label>
                <select id="editPackingStatus" class="form-control">
                    <option value="false">Chờ giao</option>
                    <option value="true">Đã giao</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="updatePacking()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeletePacking(currentPackingEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <!-- Modal nhắc nhở chuyển giao hàng -->
    <div id="transferConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeTransferConfirmModal()">&times;</span>
            <h2>Nhắc nhở trước khi chuyển giao</h2>
            <p style="margin-top:10px; white-space: pre-line;">
Bạn đã kiểm tra lại số lượng theo đơn, quy cách, số lô, hạn dùng phải không?
Cần xem lại kỹ mã đơn hàng, lập phiếu xuất chưa? kiểm tra lại trên ERP.
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTransferConfirmModal()">Hủy</button>
                <button class="btn btn-primary" id="confirmTransferBtn">Đồng ý</button>
            </div>
        </div>
    </div>
    
    <!-- Modal hướng dẫn -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHelpModal()">&times;</span>
            <h2>Hướng dẫn sử dụng</h2>
            <div class="help-content">
                <h3>1. Đóng hàng</h3>
                <ul>
                    <li>Nhập thông tin đơn hàng: Mã đơn, tên khách hàng, địa chỉ và ngày đóng hàng</li>
                    <li>Nhấn nút bản đồ để kiểm tra địa chỉ trên Google Maps</li>
                    <li>Nhấn "Xác nhận đóng hàng" để lưu thông tin</li>
                    <li>Danh sách đơn hàng đã đóng sẽ hiển thị ở bảng bên dưới</li>
                    <li>Có thể sửa, xóa hoặc thay đổi trạng thái giao hàng từ bảng này</li>
                </ul>
                
                <h3>2. Giao hàng</h3>
                <ul>
                    <li>Nhập: Mã đơn, ngày giao, <b>tên người giao</b>, tên khách hàng và địa chỉ</li>
                    <li>Nhấn nút bản đồ để kiểm tra địa chỉ trên Google Maps</li>
                    <li>Nhấn "Lưu thông tin" để ghi nhận đơn giao hàng</li>
                    <li>Khi chuyển từ tab Đóng hàng sang, hệ thống sẽ <b>tự điền</b> Mã đơn, Tên KH, Địa chỉ</li>
                </ul>
                
                <h3>3. Báo cáo</h3>
                <ul>
                    <li>Chọn loại báo cáo: Theo ngày, tuần hoặc tháng</li>
                    <li>HOẶC dùng bộ lọc <b>Từ ngày</b> và <b>Đến ngày</b> để xem dữ liệu trong một khoảng thời gian bất kỳ</li>
                    <li>Nhấn "Tạo báo cáo" để xem dữ liệu, "Xuất Excel" để tải</li>
                    <li>Có 2 loại báo cáo: Báo cáo giao hàng và báo cáo đóng hàng</li>
                </ul>
                
                <h3>4. Quản lý</h3>
                <ul>
                    <li>Tìm kiếm đơn hàng theo mã đơn hoặc tên khách hàng</li>
                    <li>Có thể chỉnh sửa hoặc xóa đơn hàng từ kết quả tìm kiếm</li>
                </ul>
                
                <h3>Thống kê</h3>
                <ul>
                    <li>Hệ thống tự động cập nhật các thống kê quan trọng ở mỗi tab</li>
                    <li>Thống kê được reset hàng ngày vào lúc 00:00</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Nút trợ giúp -->
    <div class="help-btn" onclick="openHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <script>
        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEAbXHjh2OP-QaZxVA6p3UFl959CK0fHU",
            authDomain: "giaonhan-3d317.firebaseapp.com",
            projectId: "giaonhan-3d317",
            storageBucket: "giaonhan-3d317.firebasestorage.app",
            messagingSenderId: "148651915634",
            appId: "1:148651915634:web:0bca5d3b22c95caa62c5eb",
            measurementId: "G-GYX91BJ9TJ"
        };
        
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Biến toàn cục
        let currentEditKey = null;
        let currentPackingEditKey = null;
        
        // Biến để xử lý xác nhận chuyển giao
        let pendingTransfer = { key: null, targetStatus: null };
        
        // Hàm khởi tạo
        document.addEventListener('DOMContentLoaded', function() {
            // Đặt ngày mặc định
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('packingDate').value = today;
            const editPackingDateEl = document.getElementById('editPackingDate');
            if (editPackingDateEl) editPackingDateEl.value = today;
            document.getElementById('packingReportDate').value = today;
            document.getElementById('deliveryFromDate').value = today;
            document.getElementById('deliveryToDate').value = today;
            document.getElementById('packingFromDate').value = today;
            document.getElementById('packingToDate').value = today;
            
            // Load dữ liệu ban đầu
            loadStats();
            loadTodayDeliveries();
            loadPackingStats();
            loadTodayPackings();
            
            // Thiết lập sự kiện tab
            setupTabs();
            
            // Thiết lập sự kiện thay đổi loại báo cáo giao hàng
            document.getElementById('reportType').addEventListener('change', function() {
                const reportType = this.value;
                document.getElementById('reportDate').style.display = 'none';
                document.getElementById('reportWeek').style.display = 'none';
                document.getElementById('reportMonth').style.display = 'none';
                
                if (reportType === 'daily') {
                    document.getElementById('reportDate').style.display = 'block';
                } else if (reportType === 'weekly') {
                    document.getElementById('reportWeek').style.display = 'block';
                } else if (reportType === 'monthly') {
                    document.getElementById('reportMonth').style.display = 'block';
                }
            });
            
            // Thiết lập sự kiện thay đổi loại báo cáo đóng hàng
            document.getElementById('packingReportType').addEventListener('change', function() {
                const reportType = this.value;
                document.getElementById('packingReportDate').style.display = 'none';
                document.getElementById('packingReportWeek').style.display = 'none';
                document.getElementById('packingReportMonth').style.display = 'none';
                
                if (reportType === 'daily') {
                    document.getElementById('packingReportDate').style.display = 'block';
                } else if (reportType === 'weekly') {
                    document.getElementById('packingReportWeek').style.display = 'block';
                } else if (reportType === 'monthly') {
                    document.getElementById('packingReportMonth').style.display = 'block';
                }
            });
            
            // Kiểm tra reset thống kê hàng ngày
            checkDailyReset();
            
            // Tự động cập nhật dữ liệu khi có thay đổi
            database.ref('deliveries').on('value', () => {
                loadTodayDeliveries();
                loadStats();
            });
            
            database.ref('packings').on('value', () => {
                loadTodayPackings();
                loadPackingStats();
            });
            
            database.ref('packingStats').on('value', () => {
                loadPackingStats();
            });
            
            // Gắn sự kiện cho nút xác nhận chuyển giao
            const confirmBtn = document.getElementById('confirmTransferBtn');
            confirmBtn.addEventListener('click', function() {
                if (!pendingTransfer.key) return;
                // 1) Cập nhật trạng thái packings như trước
                proceedToggleDeliveryStatus(pendingTransfer.key, pendingTransfer.targetStatus);
                // 2) Chuyển dữ liệu sang form giao hàng
                prefillDeliveryFormFromPacking(pendingTransfer.key);
                // 3) Đóng popup & reset
                closeTransferConfirmModal();
                pendingTransfer = { key: null, targetStatus: null };
            });
        });
        
        // ========== CÁC HÀM CHUNG ==========
        
        // Xem địa chỉ trên bản đồ
        function viewOnMap(addressFieldId) {
            const address = document.getElementById(addressFieldId).value.trim();
            if (!address) {
                alert("Vui lòng nhập địa chỉ trước khi xem bản đồ");
                return;
            }
            
            // Mở Google Maps trong tab mới
            const encodedAddress = encodeURIComponent(address);
            window.open(`https://www.google.com/maps?q=${encodedAddress}`, '_blank');
        }
        
        // Thiết lập tab
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    activateTab(this.getAttribute('data-tab'));
                });
            });
        }
        
        // Kích hoạt tab theo id ("packing" | "delivery" | "reports" | "management")
        function activateTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            const targetTabButton = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (targetTabButton) targetTabButton.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById(`${tabId}-tab`);
            if (targetContent) targetContent.classList.add('active');
        }
        
        // Lấy số tuần trong năm
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        // Kiểm tra reset thống kê hàng ngày
        function checkDailyReset() {
            const now = new Date();
            const lastReset = localStorage.getItem('lastReset');
            const today = now.toISOString().split('T')[0];
            
            if (lastReset !== today && now.getHours() === 0 && now.getMinutes() < 1) {
                localStorage.setItem('lastReset', today);
                loadStats();
                loadTodayDeliveries();
                loadPackingStats();
                loadTodayPackings();
            }
            
            // Kiểm tra mỗi phút
            setTimeout(checkDailyReset, 60000);
        }
        
        // Đóng modal giao hàng
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditKey = null;
        }
        
        // Đóng modal đóng hàng
        function closePackingModal() {
            document.getElementById('editPackingModal').style.display = 'none';
            currentPackingEditKey = null;
        }
        
        // Mở modal hướng dẫn
        function openHelpModal() {
            document.getElementById('helpModal').style.display = 'block';
        }
        
        // Đóng modal hướng dẫn
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        // Đóng/Mở modal nhắc nhở chuyển giao
        function openTransferConfirmModal() {
            document.getElementById('transferConfirmModal').style.display = 'block';
        }
        function closeTransferConfirmModal() {
            document.getElementById('transferConfirmModal').style.display = 'none';
        }
        
        // ========== CÁC HÀM BỔ TRỢ MỚI ==========
        // Lấy dữ liệu đóng hàng và tự điền sang form giao hàng
        function prefillDeliveryFormFromPacking(packingKey) {
            database.ref(`packings/${packingKey}`).once('value')
                .then((snapshot) => {
                    const p = snapshot.val();
                    if (!p) return;
                    document.getElementById('orderId').value = p.orderId || '';
                    document.getElementById('customerName').value = p.customerName || '';
                    document.getElementById('deliveryAddress').value = p.address || '';
                    // Ngày giao mặc định hôm nay
                    document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
                    // Chuyển sang tab Giao hàng
                    activateTab('delivery');
                    alert("Đã chuyển thông tin sang tab Giao hàng.\nVui lòng nhập Tên người giao và nhấn Lưu.");
                });
        }
        
        // ========== CHỨC NĂNG ĐÓNG HÀNG ==========
        
        // Lưu thông tin đóng hàng
        function savePacking() {
            const orderId = document.getElementById('packingOrderId').value.trim();
            const customerName = document.getElementById('packingCustomerName').value.trim();
            const address = document.getElementById('packingAddress').value.trim();
            const packingDate = document.getElementById('packingDate').value;
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert("Vui lòng điền đầy đủ thông tin!");
                return;
            }
            
            const packingKey = database.ref().child('packings').push().key;
            
            const packingData = {
                orderId: orderId,
                customerName: customerName,
                address: address,
                packingDate: packingDate,
                isDelivered: false,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`/packings/${packingKey}`).set(packingData)
                .then(() => {
                    alert("Đã xác nhận đóng hàng thành công!");
                    // Reset form
                    document.getElementById('packingOrderId').value = '';
                    document.getElementById('packingCustomerName').value = '';
                    document.getElementById('packingAddress').value = '';
                })
                .catch((error) => {
                    alert("Lỗi khi lưu thông tin: " + error.message);
                });
        }
        
        // Load thống kê đóng hàng (tất cả đều tính theo *hôm nay* để khớp với bảng hiển thị)
        function loadPackingStats() {
            const today = new Date().toISOString().split('T')[0];
            database.ref('packings').orderByChild('packingDate').equalTo(today).once('value')
                .then((snapshot) => {
                    let todayTotal = 0, todayWaiting = 0, todayDelivered = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const v = child.val() || {};
                            todayTotal += 1;
                            if (v.isDelivered) todayDelivered += 1;
                            else todayWaiting += 1;
                        });
                    }
                    document.getElementById('todayPackedCount').textContent = todayTotal;
                    document.getElementById('waitingDeliveryCount').textContent = todayWaiting;
                    document.getElementById('deliveredCount').textContent = todayDelivered;
                })
                .catch((error) => {
                    console.error('Lỗi khi tải thống kê đóng hàng hôm nay:', error);
                    document.getElementById('todayPackedCount').textContent = '—';
                    document.getElementById('waitingDeliveryCount').textContent = '—';
                    document.getElementById('deliveredCount').textContent = '—';
                });
        }
        
        // Load danh sách đóng hàng hôm nay
        function loadTodayPackings() {
            const today = new Date().toISOString().split('T')[0];
            
            database.ref('packings').orderByChild('packingDate').equalTo(today).once('value')
                .then((snapshot) => {
                    const tableBody = document.getElementById('packingTableBody');
                    tableBody.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Không có đơn hàng nào hôm nay</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach((childSnapshot) => {
                        const packing = childSnapshot.val();
                        const row = document.createElement('tr');
                        
                        const status = packing.isDelivered ? 
                            '<span class="packing-status packed">Đã giao</span>' : 
                            '<span class="packing-status not-packed">Chờ giao</span>';
                        
                        const buttonText = packing.isDelivered ? 
                            '<i class="fas fa-undo"></i> Chuyển về chờ giao' : 
                            '<i class="fas fa-truck"></i> Chuyển giao hàng';
                        
                        const buttonClass = packing.isDelivered ? 'btn-warning' : 'btn-primary';
                        
                        row.innerHTML = `
                            <td>${packing.orderId}</td>
                            <td>${packing.customerName}</td>
                            <td>${packing.address}</td>
                            <td>${status}</td>
                            <td class="action-btns">
                                <button class="btn ${buttonClass} btn-sm" onclick="toggleDeliveryStatus('${childSnapshot.key}', ${packing.isDelivered})">
                                    ${buttonText}
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openEditPackingModal('${childSnapshot.key}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmDeletePacking('${childSnapshot.key}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                });
        }
        
        // Mở modal chỉnh sửa đóng hàng
        function openEditPackingModal(key) {
            currentPackingEditKey = key;
            const modal = document.getElementById('editPackingModal');
            
            database.ref(`packings/${key}`).once('value')
                .then((snapshot) => {
                    const packing = snapshot.val();
                    
                    document.getElementById('editPackingKey').value = key;
                    document.getElementById('editPackingOrderId').value = packing.orderId;
                    document.getElementById('editPackingCustomerName').value = packing.customerName;
                    document.getElementById('editPackingAddress').value = packing.address;
                    document.getElementById('editPackingDate').value = packing.packingDate;
                    document.getElementById('editPackingStatus').value = packing.isDelivered;
                    
                    modal.style.display = 'block';
                });
        }
        
        // Cập nhật thông tin đóng hàng
        function updatePacking() {
            const key = currentPackingEditKey;
            const orderId = document.getElementById('editPackingOrderId').value.trim();
            const customerName = document.getElementById('editPackingCustomerName').value.trim();
            const address = document.getElementById('editPackingAddress').value.trim();
            const packingDate = document.getElementById('editPackingDate').value;
            const isDelivered = document.getElementById('editPackingStatus').value === 'true';
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert("Vui lòng điền đầy đủ thông tin!");
                return;
            }
            
            const updatedData = {
                orderId: orderId,
                customerName: customerName,
                address: address,
                packingDate: packingDate,
                isDelivered: isDelivered,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`/packings/${key}`).update(updatedData)
                .then(() => {
                    alert("Cập nhật thông tin đóng hàng thành công!");
                    closePackingModal();
                    loadTodayPackings();
                    loadPackingStats();
                })
                .catch((error) => {
                    alert("Lỗi khi cập nhật: " + error.message);
                });
        }
        
        // Xác nhận xóa đơn đóng hàng
        function confirmDeletePacking(key) {
            if (confirm("Bạn có chắc chắn muốn xóa đơn đóng hàng này?")) {
                deletePacking(key);
            }
        }
        
        // Xóa đơn đóng hàng
        function deletePacking(key) {
            database.ref(`/packings/${key}`).remove()
                .then(() => {
                    alert("Xóa đơn đóng hàng thành công!");
                    loadTodayPackings();
                    loadPackingStats();
                })
                .catch((error) => {
                    alert("Lỗi khi xóa: " + error.message);
                });
        }
        
        // Chuyển đổi trạng thái giao hàng (có nhắc nhở khi chuyển sang 'Đã giao')
        function toggleDeliveryStatus(key, currentStatus) {
            const newStatus = !currentStatus;
            if (newStatus) {
                // Mở popup nhắc nhở trước khi chuyển sang 'đã giao' + chuẩn bị chuyển dữ liệu
                pendingTransfer = { key, targetStatus: newStatus };
                openTransferConfirmModal();
            } else {
                // Chuyển về 'chờ giao' như cũ
                proceedToggleDeliveryStatus(key, newStatus);
            }
        }
        
        function proceedToggleDeliveryStatus(key, newStatus) {
            const statusText = newStatus ? "đã giao" : "chờ giao";
            database.ref(`/packings/${key}/isDelivered`).set(newStatus)
                .then(() => {
                    alert(`Đã cập nhật trạng thái giao hàng sang '${statusText}'!`);
                    loadTodayPackings();
                    loadPackingStats();
                })
                .catch((error) => {
                    alert("Lỗi khi cập nhật: " + error.message);
                });
        }
        
        // ========== CHỨC NĂNG GIAO HÀNG ==========
        
        // Lưu thông tin giao hàng
        function saveDelivery() {
            const orderId = document.getElementById('orderId').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const delivererName = document.getElementById('delivererName').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert("Vui lòng điền đầy đủ thông tin!");
                return;
            }
            
            // Tạo key duy nhất cho mỗi đơn hàng
            const deliveryKey = database.ref().child('deliveries').push().key;
            
            // Tạo object dữ liệu (đã bỏ thời gian, thêm người giao)
            const deliveryData = {
                orderId: orderId,
                deliveryDate: deliveryDate,
                delivererName: delivererName,
                customerName: customerName,
                deliveryAddress: deliveryAddress,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Lưu dữ liệu lên Firebase
            const updates = {};
            updates[`/deliveries/${deliveryKey}`] = deliveryData;
            
            // Cập nhật thống kê
            const today = new Date().toISOString().split('T')[0];
            const week = getWeekNumber(new Date());
            const month = new Date().getMonth();
            
            updates[`/stats/daily/${today}/${deliveryKey}`] = true;
            updates[`/stats/weekly/${week}/${deliveryKey}`] = true;
            updates[`/stats/monthly/${month}/${deliveryKey}`] = true;
            
            database.ref().update(updates)
                .then(() => {
                    alert("Đã lưu thông tin giao hàng thành công!");
                    // Reset form (giữ ngày hôm nay cho tiện)
                    document.getElementById('orderId').value = '';
                    document.getElementById('delivererName').value = '';
                    document.getElementById('customerName').value = '';
                    document.getElementById('deliveryAddress').value = '';
                })
                .catch((error) => {
                    alert("Lỗi khi lưu thông tin: " + error.message);
                });
        }
        
        // Load thống kê giao hàng
        function loadStats() {
            const today = new Date().toISOString().split('T')[0];
            const week = getWeekNumber(new Date());
            const month = new Date().getMonth();
            
            // Đếm số đơn hàng hôm nay
            database.ref(`stats/daily/${today}`).once('value')
                .then((snapshot) => {
                    document.getElementById('todayCount').textContent = snapshot.numChildren();
                });
            
            // Đếm số đơn hàng tuần này
            database.ref(`stats/weekly/${week}`).once('value')
                .then((snapshot) => {
                    document.getElementById('weeklyCount').textContent = snapshot.numChildren();
                });
            
            // Đếm số đơn hàng tháng này
            database.ref(`stats/monthly/${month}`).once('value')
                .then((snapshot) => {
                    document.getElementById('monthlyCount').textContent = snapshot.numChildren();
                });
        }
        
        // Load danh sách giao hàng hôm nay
        function loadTodayDeliveries() {
            const today = new Date().toISOString().split('T')[0];
            
            database.ref('deliveries').orderByChild('deliveryDate').equalTo(today).once('value')
                .then((snapshot) => {
                    const tableBody = document.getElementById('deliveryTableBody');
                    tableBody.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Không có đơn hàng nào hôm nay</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach((childSnapshot) => {
                        const delivery = childSnapshot.val();
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${delivery.orderId}</td>
                            <td>${delivery.delivererName || '-'}</td>
                            <td>${delivery.customerName}</td>
                            <td>${delivery.deliveryAddress}</td>
                            <td class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="openEditModal('${childSnapshot.key}')">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmDeleteDelivery('${childSnapshot.key}')">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                });
        }
        
        // Xác nhận xóa đơn giao hàng
        function confirmDeleteDelivery(key) {
            if (confirm("Bạn có chắc chắn muốn xóa đơn giao hàng này?")) {
                deleteDelivery(key);
            }
        }
        
        // Xóa đơn giao hàng
        function deleteDelivery(key, fromManagement = false) {
            // Lấy ngày giao của đơn hàng để xóa khỏi thống kê đúng ngày/tuần/tháng
            database.ref(`deliveries/${key}`).once('value')
                .then((snap) => {
                    const delivery = snap.val();
                    if (!delivery) return;
                    
                    const deliveryDate = delivery.deliveryDate;
                    const deliveryDay = new Date(deliveryDate);
                    const deliveryWeek = getWeekNumber(deliveryDay);
                    const deliveryMonth = deliveryDay.getMonth();
                    
                    // Xóa đơn hàng và cập nhật thống kê
                    const updates = {};
                    updates[`/deliveries/${key}`] = null;
                    updates[`/stats/daily/${deliveryDate}/${key}`] = null;
                    updates[`/stats/weekly/${deliveryWeek}/${key}`] = null;
                    updates[`/stats/monthly/${deliveryMonth}/${key}`] = null;
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    alert("Xóa đơn hàng thành công!");
                    
                    if (fromManagement) {
                        searchOrders(); // Refresh kết quả tìm kiếm
                    } else {
                        loadTodayDeliveries(); // Refresh danh sách giao hàng hôm nay
                    }
                    
                    loadStats();
                })
                .catch((error) => {
                    alert("Lỗi khi xóa: " + error.message);
                });
        }
        
        // ========== CHỨC NĂNG QUẢN LÝ ==========
        
        // Mở modal chỉnh sửa
        function openEditModal(key) {
            currentEditKey = key;
            const modal = document.getElementById('editModal');
            
            database.ref(`deliveries/${key}`).once('value')
                .then((snapshot) => {
                    const delivery = snapshot.val();
                    
                    document.getElementById('editKey').value = key;
                    document.getElementById('editOrderId').value = delivery.orderId;
                    document.getElementById('editDeliveryDate').value = delivery.deliveryDate;
                    document.getElementById('editDelivererName').value = delivery.delivererName || '';
                    document.getElementById('editCustomerName').value = delivery.customerName;
                    document.getElementById('editDeliveryAddress').value = delivery.deliveryAddress;
                    
                    modal.style.display = 'block';
                });
        }
        
        // Cập nhật đơn hàng
        function updateDelivery() {
            const key = currentEditKey;
            const orderId = document.getElementById('editOrderId').value.trim();
            const deliveryDate = document.getElementById('editDeliveryDate').value;
            const delivererName = document.getElementById('editDelivererName').value.trim();
            const customerName = document.getElementById('editCustomerName').value.trim();
            const deliveryAddress = document.getElementById('editDeliveryAddress').value.trim();
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert("Vui lòng điền đầy đủ thông tin!");
                return;
            }
            
            const updatedData = {
                orderId: orderId,
                deliveryDate: deliveryDate,
                delivererName: delivererName,
                customerName: customerName,
                deliveryAddress: deliveryAddress,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`deliveries/${key}`).update(updatedData)
                .then(() => {
                    alert("Cập nhật thông tin thành công!");
                    closeModal();
                    loadTodayDeliveries();
                    loadStats();
                })
                .catch((error) => {
                    alert("Lỗi khi cập nhật: " + error.message);
                });
        }
        
        // Tìm kiếm đơn hàng
        function searchOrders() {
            const searchTerm = document.getElementById('searchOrder').value.trim().toLowerCase();
            
            if (searchTerm === '') {
                alert("Vui lòng nhập từ khóa tìm kiếm");
                return;
            }
            
            database.ref('deliveries').once('value')
                .then((snapshot) => {
                    const tableBody = document.getElementById('managementTableBody');
                    tableBody.innerHTML = '';
                    
                    let found = false;
                    
                    snapshot.forEach((childSnapshot) => {
                        const delivery = childSnapshot.val();
                        
                        if (delivery.orderId.toLowerCase().includes(searchTerm) || 
                            delivery.customerName.toLowerCase().includes(searchTerm)) {
                            found = true;
                            
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${delivery.orderId}</td>
                                <td>${delivery.deliveryDate}</td>
                                <td>${delivery.delivererName || '-'}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td class="action-btns">
                                    <button class="btn btn-primary btn-sm" onclick="openEditModal('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="confirmDeleteDeliveryFromManagement('${childSnapshot.key}')">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </td>
                            `;
                            
                            tableBody.appendChild(row);
                        }
                    });
                    
                    if (!found) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Không tìm thấy đơn hàng phù hợp</td></tr>';
                    }
                });
        }
        
        // Xác nhận xóa từ trang quản lý
        function confirmDeleteDeliveryFromManagement(key) {
            if (confirm("Bạn có chắc chắn muốn xóa đơn hàng này?")) {
                deleteDelivery(key, true);
            }
        }
        
        // ========== CHỨC NĂNG BÁO CÁO ==========
        
        // Hỗ trợ so sánh ngày dạng 'YYYY-MM-DD'
        function isDateInRange(isoDate, fromIso, toIso) {
            if (!isoDate) return false;
            if (!fromIso && !toIso) return true;
            const d = new Date(isoDate);
            if (fromIso) {
                const from = new Date(fromIso);
                if (d < from) return false;
            }
            if (toIso) {
                const to = new Date(toIso);
                // Bao gồm cả ngày 'to' nên cộng thêm 1 ngày - 1 ms
                to.setDate(to.getDate() + 1);
                if (d >= to) return false;
            }
            return true;
        }
        
        // Tạo báo cáo giao hàng (hỗ trợ theo loại + khoảng thời gian)
        function generateDeliveryReport() {
            const fromDate = document.getElementById('deliveryFromDate').value;
            const toDate = document.getElementById('deliveryToDate').value;
            
            const spinner = document.getElementById('reportSpinner');
            spinner.style.display = 'block';
            document.getElementById('reportTableBody').innerHTML = '';
            
            if (fromDate && toDate) {
                // Lọc theo khoảng thời gian tùy ý
                database.ref('deliveries').once('value')
                    .then((snapshot) => {
                        const list = [];
                        snapshot.forEach(child => {
                            const v = child.val();
                            if (isDateInRange(v.deliveryDate, fromDate, toDate)) list.push(v);
                        });
                        renderDeliveryReportRows(list);
                        spinner.style.display = 'none';
                    })
                    .catch(() => {
                        document.getElementById('reportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">Lỗi khi tải dữ liệu</td></tr>';
                        spinner.style.display = 'none';
                    });
                return;
            }
            
            // Nếu không có from/to -> dùng kiểu cũ: ngày/tuần/tháng
            const reportType = document.getElementById('reportType').value;
            let dateValue, refPath;
            
            if (reportType === 'daily') {
                dateValue = document.getElementById('reportDate').value;
                if (!dateValue) {
                    alert("Vui lòng chọn ngày báo cáo");
                    spinner.style.display = 'none';
                    return;
                }
                refPath = `stats/daily/${dateValue}`;
            } else if (reportType === 'weekly') {
                dateValue = document.getElementById('reportWeek').value;
                if (!dateValue) {
                    alert("Vui lòng chọn tuần báo cáo");
                    spinner.style.display = 'none';
                    return;
                }
                const year = dateValue.substring(0, 4);
                const week = dateValue.substring(6);
                refPath = `stats/weekly/${week}`; // Giữ logic tuần theo số tuần hiện tại
            } else if (reportType === 'monthly') {
                dateValue = document.getElementById('reportMonth').value;
                if (!dateValue) {
                    alert("Vui lòng chọn tháng báo cáo");
                    spinner.style.display = 'none';
                    return;
                }
                const month = new Date(dateValue).getMonth();
                refPath = `stats/monthly/${month}`;
            }
            
            database.ref(refPath).once('value')
                .then((snapshot) => {
                    const orderKeys = Object.keys(snapshot.val() || {});
                    if (orderKeys.length === 0) {
                        document.getElementById('reportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">Không có dữ liệu</td></tr>';
                        spinner.style.display = 'none';
                        return;
                    }
                    
                    // Lấy thông tin chi tiết các đơn hàng
                    const promises = orderKeys.map(key => 
                        database.ref(`deliveries/${key}`).once('value')
                    );
                    
                    return Promise.all(promises);
                })
                .then((snapshots) => {
                    if (!snapshots) return;
                    const list = [];
                    snapshots.forEach((childSnapshot) => {
                        if (!childSnapshot.exists()) return;
                        list.push(childSnapshot.val());
                    });
                    renderDeliveryReportRows(list);
                    spinner.style.display = 'none';
                })
                .catch((error) => {
                    console.error("Lỗi khi tạo báo cáo:", error);
                    document.getElementById('reportTableBody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center;">Lỗi khi tải dữ liệu</td></tr>';
                    spinner.style.display = 'none';
                });
        }
        
        function renderDeliveryReportRows(list) {
            const tableBody = document.getElementById('reportTableBody');
            tableBody.innerHTML = '';
            if (!list || list.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            // Sắp xếp theo ngày giao rồi theo mã đơn để ổn định
            list.sort((a, b) => (a.deliveryDate + ' ' + (a.orderId || '')).localeCompare(b.deliveryDate + ' ' + (b.orderId || '')));
            list.forEach((delivery, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${delivery.orderId}</td>
                    <td>${delivery.deliveryDate}</td>
                    <td>${delivery.delivererName || '-'}</td>
                    <td>${delivery.customerName}</td>
                    <td>${delivery.deliveryAddress}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Tạo báo cáo đóng hàng (hỗ trợ theo loại + khoảng thời gian)
        function generatePackingReport() {
            const fromDate = document.getElementById('packingFromDate').value;
            const toDate = document.getElementById('packingToDate').value;
            
            const spinner = document.getElementById('packingReportSpinner');
            spinner.style.display = 'block';
            document.getElementById('packingReportTableBody').innerHTML = '';
            
            database.ref('packings').once('value')
                .then((snapshot) => {
                    const allPackings = snapshot.val() || {};
                    const orderKeys = Object.keys(allPackings);
                    
                    if (orderKeys.length === 0) {
                        document.getElementById('packingReportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">Không có dữ liệu</td></tr>';
                        spinner.style.display = 'none';
                        return;
                    }
                    
                    let filteredKeys = orderKeys;
                    
                    // Nếu có from/to -> lọc theo khoảng
                    if (fromDate && toDate) {
                        filteredKeys = orderKeys.filter(key => {
                            const p = allPackings[key];
                            return isDateInRange(p.packingDate, fromDate, toDate);
                        });
                    } else {
                        // Nếu không có from/to -> dùng kiểu cũ: ngày/tuần/tháng
                        const reportType = document.getElementById('packingReportType').value;
                        if (reportType === 'daily') {
                            const dateValue = document.getElementById('packingReportDate').value;
                            if (!dateValue) {
                                alert("Vui lòng chọn ngày báo cáo");
                                spinner.style.display = 'none';
                                return;
                            }
                            filteredKeys = orderKeys.filter(key => allPackings[key].packingDate === dateValue);
                        } else if (reportType === 'weekly') {
                            const dateValue = document.getElementById('packingReportWeek').value;
                            if (!dateValue) {
                                alert("Vui lòng chọn tuần báo cáo");
                                spinner.style.display = 'none';
                                return;
                            }
                            const reportWeek = getWeekNumber(new Date(dateValue));
                            filteredKeys = orderKeys.filter(key => {
                                const packingDate = new Date(allPackings[key].packingDate);
                                return getWeekNumber(packingDate) === reportWeek &&
                                       packingDate.getFullYear() === new Date(dateValue).getFullYear();
                            });
                        } else if (reportType === 'monthly') {
                            const dateValue = document.getElementById('packingReportMonth').value;
                            if (!dateValue) {
                                alert("Vui lòng chọn tháng báo cáo");
                                spinner.style.display = 'none';
                                return;
                            }
                            filteredKeys = orderKeys.filter(key => {
                                const packingDate = new Date(allPackings[key].packingDate);
                                return packingDate.getMonth() === new Date(dateValue).getMonth() &&
                                       packingDate.getFullYear() === new Date(dateValue).getFullYear();
                            });
                        }
                    }
                    
                    if (filteredKeys.length === 0) {
                        document.getElementById('packingReportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">Không có dữ liệu</td></tr>';
                        spinner.style.display = 'none';
                        return;
                    }
                    
                    // Hiển thị kết quả
                    const tableBody = document.getElementById('packingReportTableBody');
                    tableBody.innerHTML = '';
                    
                    // Sắp xếp theo ngày đóng
                    filteredKeys.sort((a, b) => {
                        const pa = allPackings[a];
                        const pb = allPackings[b];
                        return (pa.packingDate + (pa.orderId || '')).localeCompare(pb.packingDate + (pb.orderId || ''));
                    });
                    
                    filteredKeys.forEach((key, index) => {
                        const packing = allPackings[key];
                        const status = packing.isDelivered ? "Đã giao" : "Chờ giao";
                        
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${packing.orderId}</td>
                            <td>${packing.packingDate}</td>
                            <td>${packing.customerName}</td>
                            <td>${packing.address}</td>
                            <td>${status}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    spinner.style.display = 'none';
                })
                .catch((error) => {
                    console.error("Lỗi khi tạo báo cáo:", error);
                    document.getElementById('packingReportTableBody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center;">Lỗi khi tải dữ liệu</td></tr>';
                    spinner.style.display = 'none';
                });
        }
        
        // Xóa báo cáo giao hàng
        function clearDeliveryReport() {
            document.getElementById('reportTableBody').innerHTML = '';
        }
        
        // Xóa báo cáo đóng hàng
        function clearPackingReport() {
            document.getElementById('packingReportTableBody').innerHTML = '';
        }
        
        // Xuất báo cáo giao hàng ra Excel
        function exportDeliveryToExcel() {
            const table = document.getElementById('reportTable');
            if (table.rows.length <= 1) {
                alert("Không có dữ liệu để xuất Excel");
                return;
            }
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoGiaoHang");
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            XLSX.writeFile(wb, `BaoCaoGiaoHang_${dateStr}.xlsx`);
        }
        
        // Xuất báo cáo đóng hàng ra Excel
        function exportPackingToExcel() {
            const table = document.getElementById('packingReportTable');
            if (table.rows.length <= 1) {
                alert("Không có dữ liệu để xuất Excel");
                return;
            }
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoDongHang");
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            XLSX.writeFile(wb, `BaoCaoDongHang_${dateStr}.xlsx`);
        }
    </script>
</body>
</html>
