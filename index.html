<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đóng hàng & Giao hàng - KPI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        h1, h2, h3 {
            margin: 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .section-divider {
            margin: 20px 0;
            border-top: 1px solid #ddd;
        }
        
        /* Trạng thái đóng gói */
        .packing-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .packed {
            background-color: var(--success-color);
            color: white;
        }
        
        .not-packed {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Địa chỉ với nút bản đồ */
        .address-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .address-group input {
            flex: 1;
        }
        
        .map-btn {
            padding: 10px 12px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-btn:hover {
            background-color: #2d8e47;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .address-group {
                flex-direction: column;
                gap: 5px;
            }
            
            .map-btn {
                width: 100%;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Help button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        /* Help content */
        .help-content {
            line-height: 1.8;
        }
        
        .help-content h3 {
            margin-top: 15px;
            color: var(--primary-color);
        }
        
        .help-content ul {
            padding-left: 20px;
        }
        
        /* Autocomplete */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        
        .autocomplete-active {
            background-color: var(--primary-color) !important;
            color: #ffffff;
        }
        
        /* File upload */
        .file-upload-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
        }
        
        .file-upload-container p {
            margin-bottom: 10px;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .file-upload-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .customer-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>Quản lý Đóng hàng & Giao hàng - KPI kho vận (IDECO)</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="packing">Đóng hàng</div>
            <div class="tab" data-tab="delivery">Giao hàng</div>
            <div class="tab" data-tab="reports">Báo cáo</div>
            <div class="tab" data-tab="management">Quản lý</div>
            <div class="tab" data-tab="customer-data">Dữ liệu KH</div>
        </div>
        
        <!-- Tab Đóng hàng -->
        <div class="tab-content active" id="packing-tab">
            <div class="card">
                <h2>Nhập thông tin đóng hàng</h2>
                <div class="form-group">
                    <label for="packingOrderId">Mã đơn hàng:</label>
                    <input type="text" id="packingOrderId" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="form-group autocomplete">
                    <label for="packingCustomerName">Tên khách hàng:</label>
                    <input type="text" id="packingCustomerName" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="packingAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="packingAddress" required>
                        <button class="map-btn" onclick="viewOnMap('packingAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="packingDate">Ngày đóng hàng:</label>
                    <input type="date" id="packingDate" required>
                </div>
                <button class="btn btn-primary" onclick="savePacking()">
                    <i class="fas fa-box"></i> Xác nhận đơn đã đóng hàng xong
                </button>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayPackedCount">0</div>
                    <p>đơn đã đóng hàng</p>
                </div>
                <div class="stat-card">
                    <h3>Chờ giao</h3>
                    <div class="stat-value" id="waitingDeliveryCount">0</div>
                    <p>đơn sẵn sàng giao</p>
                </div>
                <div class="stat-card">
                    <h3>Đã giao</h3>
                    <div class="stat-value" id="deliveredCount">0</div>
                    <p>đơn đã giao</p>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="card">
                <h2>Danh sách đơn hàng đã đóng hôm nay</h2>
                <table id="packingTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="packingTableBody">
                        <!-- Dữ liệu sẽ được thêm tự động -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Giao hàng -->
        <div class="tab-content" id="delivery-tab">
            <div class="card">
                <h2>Nhập thông tin giao hàng</h2>
                <div class="form-group">
                    <label for="orderId">Mã đơn hàng:</label>
                    <input type="text" id="orderId" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="form-group">
                    <label for="deliveryDate">Ngày giao hàng:</label>
                    <input type="date" id="deliveryDate" required>
                </div>
                <div class="form-group">
                    <label for="delivererName">Tên người giao:</label>
                    <input type="text" id="delivererName" placeholder="Ví dụ: Anh A, Chị B" required>
                </div>
                <div class="form-group autocomplete">
                    <label for="customerName">Tên khách hàng:</label>
                    <input type="text" id="customerName" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="deliveryAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="deliveryAddress" required>
                        <button class="map-btn" onclick="viewOnMap('deliveryAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveDelivery()">
                    <i class="fas fa-save"></i> Giao xong - hay phải giao mới bấm lưu dữ liệu
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tuần này</h3>
                    <div class="stat-value" id="weeklyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tháng này</h3>
                    <div class="stat-value" id="monthlyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
            </div>
            
            <div class="card">
                <h2>Danh sách giao hàng hôm nay</h2>
                <table id="deliveryTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryTableBody">
                        <!-- Dữ liệu sẽ được thêm tự động -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Báo cáo -->
        <div class="tab-content" id="reports-tab">
            <div class="card">
                <h2>Báo cáo giao hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="reportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="reportDate" class="form-control">
                        <input type="week" id="reportWeek" class="form-control" style="display: none;">
                        <input type="month" id="reportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="deliveryFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="deliveryToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generateDeliveryReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportDeliveryToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearDeliveryReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="reportSpinner"></div>
                
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Dữ liệu báo cáo sẽ được thêm ở đây -->
                    </tbody>
                </table>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h2>Báo cáo đóng hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="packingReportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="packingReportDate" class="form-control">
                        <input type="week" id="packingReportWeek" class="form-control" style="display: none;">
                        <input type="month" id="packingReportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="packingFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="packingToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generatePackingReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportPackingToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearPackingReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="packingReportSpinner"></div>
                
                <table id="packingReportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày đóng</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                            <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="packingReportTableBody">
                        <!-- Dữ liệu báo cáo sẽ được thêm ở đây -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Quản lý -->
        <div class="tab-content" id="management-tab">
            <div class="card">
                <h2>Quản lý đơn hàng</h2>
                
                <div class="form-group">
                    <label for="searchOrder">Tìm kiếm đơn hàng:</label>
                    <div style="display: flex;">
                        <input type="text" id="searchOrder" placeholder="Nhập mã đơn hoặc tên KH">
                        <button class="btn btn-primary" onclick="searchOrders()" style="margin-left: 10px;">
                            <i class="fas fa-search"></i> Tìm
                        </button>
                    </div>
                </div>
                
                <table id="managementTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="managementTableBody">
                        <!-- Dữ liệu quản lý sẽ được thêm ở đây -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Dữ liệu khách hàng -->
        <div class="tab-content" id="customer-data-tab">
            <div class="card">
                <h2>Quản lý dữ liệu khách hàng</h2>
                
                <div class="file-upload-container">
                    <p>Tải lên file Excel chứa dữ liệu khách hàng</p>
                    <p><small>File Excel cần có các cột: TênKhachHang, DiaChi (hoặc tên cột tương tự)</small></p>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls">
                    <label for="excelFile" class="file-upload-btn">
                        <i class="fas fa-upload"></i> Chọn file Excel
                    </label>
                    <button class="btn btn-primary" onclick="uploadExcel()" style="margin-left: 10px;">
                        <i class="fas fa-cloud-upload-alt"></i> Tải lên
                    </button>
                </div>
                
                <div class="customer-table-container">
                    <table id="customerTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên khách hàng</th>
                                <th>Địa chỉ</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <!-- Dữ liệu khách hàng sẽ được thêm ở đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal chỉnh sửa giao hàng -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Chỉnh sửa đơn hàng</h2>
            <input type="hidden" id="editKey">
            <div class="form-group">
                <label for="editOrderId">Mã đơn hàng:</label>
                <input type="text" id="editOrderId" required oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="form-group">
                <label for="editDeliveryDate">Ngày giao hàng:</label>
                <input type="date" id="editDeliveryDate" required>
            </div>
            <div class="form-group">
                <label for="editDelivererName">Tên người giao:</label>
                <input type="text" id="editDelivererName" required>
            </div>
            <div class="form-group autocomplete">
                <label for="editCustomerName">Tên khách hàng:</label>
                <input type="text" id="editCustomerName" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="editDeliveryAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editDeliveryAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editDeliveryAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="updateDelivery()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeleteDelivery(currentEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <!-- Modal chỉnh sửa đóng hàng -->
    <div id="editPackingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePackingModal()">&times;</span>
            <h2>Chỉnh sửa đơn đóng hàng</h2>
            <input type="hidden" id="editPackingKey">
            <div class="form-group">
                <label for="editPackingOrderId">Mã đơn hàng:</label>
                <input type="text" id="editPackingOrderId" required oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="form-group autocomplete">
                <label for="editPackingCustomerName">Tên khách hàng:</label>
                <input type="text" id="editPackingCustomerName" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="editPackingAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editPackingAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editPackingAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="editPackingDate">Ngày đóng hàng:</label>
                <input type="date" id="editPackingDate" required>
            </div>
            <div class="form-group">
                <label for="editPackingStatus">Trạng thái giao hàng:</label>
                <select id="editPackingStatus" class="form-control">
                    <option value="false">Chờ giao</option>
                    <option value="true">Đã giao</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="updatePacking()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeletePacking(currentPackingEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <!-- Modal nhắc nhở chuyển giao hàng -->
    <div id="transferConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeTransferConfirmModal()">&times;</span>
             <h2>EM NÊN ĐỌC NỘI DUNG SAU CẨN THẬN !</h2>
            <p style="margin-top:10px; white-space: pre-line;">
Em đã sẵn sàng mang đi giao hàng hay đơn vị giao đến nhận ngay chưa ? kiểm tra lại lộ trình chưa ?báo nhiêu kiện cho đơn này?
Khi giao hàng đảm bảo thùng hàng có tem nhãn ghi chính xác không? có hóa đơn, đơn hàng kèm  theo thùng chưa? phải đảm bảo đầy dủ
Nếu đã bấm chuyển giao hàng thì phải hoàn thành giao hàng ngay tránh đơn hàng khai báo bị trôi tin, sót đơn trên ứng dụng
Hàng giao phải xem lại thông tin giao, thanh toán. Dù bất cứ nhân viên nào đang thu lý giao phải khai thông tin giao mới được giao hàng.
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTransferConfirmModal()">Hủy</button>
                <button class="btn btn-primary" id="confirmTransferBtn">Đồng ý</button>
            </div>
        </div>
    </div>
    
    <!-- Modal hướng dẫn -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHelpModal()">&times;</span>
            <h2>Hướng dẫn sử dụng</h2>
            <div class="help-content">
                <h3>1. Phần này do: Điều phối kho đảm nhận khai báo - ngoài ra Quản lý kho vận cũng được tham gia </h3>
                <ul>
                    <li>Sau khi mọi đơn hàng đã được đóng xong sẵn sàng giao ra kho thì phải khai báo ngay trước khi ra khỏi kho</li>
                    <li>Mã đơn hàng từ đơn hàng ERP in ra và nhập đúng chính xác</li>
                    <li>Thông tin tên khách hàng- địa chỉ giao hàng phải điền đủ hay chỉnh lại đúng sau đó</li>
                    <li>Khi đóng hàng đơn hàng này thì xử lý xong rồi bấm đã xong đóng gói</li>
                    <li>Trạng thái báo: đang chờ màu đỏ tức là tình trạnh đơn chưa được giao đang tạm lưu kho</li>
                </ul>
                
                <h3>2. Giao hàng -Phần này do phụ trách điều phối vận chuyển- giao hàng hay người hỗ trợ giao hàng thực hiện</h3>
                <ul>
                    <li>Nhập: Mã đơn, ngày giao, <b>tên người giao</b>, tên khách hàng và địa chỉ</li>
                    <li>Nhấn nút bản đồ để kiểm tra địa chỉ giao hàng trên Google Maps</li>
                    <li>Chỉ nhấn "Giao xong" khi đơn hàng đã được giao thành công</li>
                    <li>Đảm bảo thông tin chính xác trước khi lưu</li>
                </ul>
                
                <h3>3. Báo cáo</h3>
                <ul>
                    <li>Chọn loại báo cáo (ngày/tuần/tháng) hoặc khoảng thời gian cụ thể</li>
                    <li>Nhấn "Tạo báo cáo" để xem dữ liệu</li>
                    <li>Xuất Excel để tải báo cáo về máy tính</li>
                    <li>Xóa báo cáo để xóa dữ liệu đã chọn</li>
                </ul>
                
                <h3>4. Quản lý</h3>
                <ul>
                    <li>Tìm kiếm đơn hàng theo mã đơn hoặc tên khách hàng</li>
                    <li>Chỉnh sửa hoặc xóa đơn hàng nếu có sai sót</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="help-btn" onclick="showHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <script>
          const firebaseConfig = { 
  apiKey : "AIzaSyA2Xa3zF8CCOccQhq7nvqooUTabnq5N4qM" , 
  authDomain : "quanlykho-21f95.firebaseapp.com" , 
  projectId : "quanlykho-21f95" , 
  storageBucket : "quanlykho-21f95.firebasestorage.app" , 
  messagingSenderId : "1082567127195" , 
  appId : "1:1082567127195:web:dfec69dab7d492c095563e" , 
  measurementId : "G-RCXEM8VP68" 
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Biến toàn cục
        let currentEditKey = null;
        let currentPackingEditKey = null;
        let customerData = [];
        
        // Khởi tạo khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            // Thiết lập ngày hiện tại cho các trường ngày
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').value = today;
            document.getElementById('packingDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('packingReportDate').value = today;
            
            // Tải dữ liệu giao hàng
            loadDeliveryData();
            loadPackingData();
            loadCustomerData();
            
            // Thiết lập sự kiện cho các tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Thiết lập sự kiện cho loại báo cáo
            document.getElementById('reportType').addEventListener('change', function() {
                toggleReportInputs(this.value, 'report');
            });
            
            document.getElementById('packingReportType').addEventListener('change', function() {
                toggleReportInputs(this.value, 'packingReport');
            });
            
            // Thiết lập autocomplete
            initAutocomplete();
        });
        
        // Chuyển đổi tab
        function switchTab(tabId) {
            // Ẩn tất cả các tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Hiển thị tab content được chọn
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Cập nhật tab active
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
        }
        
        // Tự động chuyển đổi mã đơn hàng thành chữ HOA
        function autoUppercaseOrderId() {
            const orderIdInput = document.getElementById('orderId');
            orderIdInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            const packingOrderIdInput = document.getElementById('packingOrderId');
            packingOrderIdInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }
        
        // Lưu dữ liệu giao hàng
        function saveDelivery() {
            const orderId = document.getElementById('orderId').value.toUpperCase();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const delivererName = document.getElementById('delivererName').value;
            const customerName = document.getElementById('customerName').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            // Hiển thị modal xác nhận
            showTransferConfirmModal(() => {
                const deliveryData = {
                    orderId: orderId,
                    deliveryDate: deliveryDate,
                    delivererName: delivererName,
                    customerName: customerName,
                    deliveryAddress: deliveryAddress,
                    timestamp: new Date().toISOString()
                };
                
                // Lưu dữ liệu vào Firebase
                const newDeliveryRef = database.ref('deliveries').push();
                newDeliveryRef.set(deliveryData)
                    .then(() => {
                        alert('Đã lưu thông tin giao hàng thành công!');
                        // Reset form
                        document.getElementById('orderId').value = '';
                        document.getElementById('customerName').value = '';
                        document.getElementById('deliveryAddress').value = '';
                        
                        // Cập nhật bảng dữ liệu
                        loadDeliveryData();
                    })
                    .catch(error => {
                        console.error('Lỗi khi lưu dữ liệu:', error);
                        alert('Có lỗi xảy ra khi lưu dữ liệu!');
                    });
            });
        }
        
        // Lưu dữ liệu đóng hàng
        function savePacking() {
            const orderId = document.getElementById('packingOrderId').value.toUpperCase();
            const customerName = document.getElementById('packingCustomerName').value;
            const address = document.getElementById('packingAddress').value;
            const packingDate = document.getElementById('packingDate').value;
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const packingData = {
                orderId: orderId,
                customerName: customerName,
                address: address,
                packingDate: packingDate,
                isDelivered: false,
                timestamp: new Date().toISOString()
            };
            
            // Lưu dữ liệu vào Firebase
            const newPackingRef = database.ref('packings').push();
            newPackingRef.set(packingData)
                .then(() => {
                    alert('Đã lưu thông tin đóng hàng thành công!');
                    // Reset form
                    document.getElementById('packingOrderId').value = '';
                    document.getElementById('packingCustomerName').value = '';
                    document.getElementById('packingAddress').value = '';
                    
                    // Cập nhật bảng dữ liệu
                    loadPackingData();
                })
                .catch(error => {
                    console.error('Lỗi khi lưu dữ liệu:', error);
                    alert('Có lỗi xảy ra khi lưu dữ liệu!');
                });
        }
        
        // Tải dữ liệu giao hàng
        function loadDeliveryData() {
            const today = new Date().toISOString().split('T')[0];
            const deliveryTableBody = document.getElementById('deliveryTableBody');
            deliveryTableBody.innerHTML = '';
            
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let todayCount = 0;
                    let weeklyCount = 0;
                    let monthlyCount = 0;
                    
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        const deliveryDate = new Date(delivery.deliveryDate);
                        
                        // Đếm số đơn hôm nay
                        if (delivery.deliveryDate === today) {
                            todayCount++;
                        }
                        
                        // Đếm số đơn tuần này
                        if (deliveryDate >= startOfWeek) {
                            weeklyCount++;
                        }
                        
                        // Đếm số đơn tháng này
                        if (deliveryDate >= startOfMonth) {
                            monthlyCount++;
                        }
                        
                        // Thêm vào bảng nếu là hôm nay
                        if (delivery.deliveryDate === today) {
                            const row = deliveryTableBody.insertRow();
                            row.innerHTML = `
                                <td>${delivery.orderId}</td>
                                <td>${delivery.delivererName}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td class="action-btns">
                                    <button class="btn btn-sm btn-warning" onclick="editDelivery('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                </td>
                            `;
                        }
                    });
                    
                    // Cập nhật số liệu thống kê
                    document.getElementById('todayCount').textContent = todayCount;
                    document.getElementById('weeklyCount').textContent = weeklyCount;
                    document.getElementById('monthlyCount').textContent = monthlyCount;
                })
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu:', error);
                });
        }
        
        // Tải dữ liệu đóng hàng
        function loadPackingData() {
            const today = new Date().toISOString().split('T')[0];
            const packingTableBody = document.getElementById('packingTableBody');
            packingTableBody.innerHTML = '';
            
            database.ref('packings').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let todayPackedCount = 0;
                    let waitingDeliveryCount = 0;
                    let deliveredCount = 0;
                    
                    snapshot.forEach(childSnapshot => {
                        const packing = childSnapshot.val();
                        
                        // Đếm số đơn đã đóng hôm nay
                        if (packing.packingDate === today) {
                            todayPackedCount++;
                        }
                        
                        // Đếm số đơn chờ giao
                        if (!packing.isDelivered) {
                            waitingDeliveryCount++;
                        } else {
                            deliveredCount++;
                        }
                        
                        // Thêm vào bảng nếu là hôm nay
                        if (packing.packingDate === today) {
                            const row = packingTableBody.insertRow();
                            row.innerHTML = `
                                <td>${packing.orderId}</td>
                                <td>${packing.customerName}</td>
                                <td>${packing.address}</td>
                                <td>
                                    <span class="packing-status ${packing.isDelivered ? 'packed' : 'not-packed'}">
                                        ${packing.isDelivered ? 'Đã giao' : 'Chờ giao'}
                                    </span>
                                </td>
                                <td class="action-btns">
                                    <button class="btn btn-sm btn-warning" onclick="editPacking('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                </td>
                            `;
                        }
                    });
                    
                    // Cập nhật số liệu thống kê
                    document.getElementById('todayPackedCount').textContent = todayPackedCount;
                    document.getElementById('waitingDeliveryCount').textContent = waitingDeliveryCount;
                    document.getElementById('deliveredCount').textContent = deliveredCount;
                })
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu:', error);
                });
        }
        
        // Chỉnh sửa giao hàng
        function editDelivery(key) {
            currentEditKey = key;
            database.ref('deliveries/' + key).once('value')
                .then(snapshot => {
                    const delivery = snapshot.val();
                    document.getElementById('editKey').value = key;
                    document.getElementById('editOrderId').value = delivery.orderId;
                    document.getElementById('editDeliveryDate').value = delivery.deliveryDate;
                    document.getElementById('editDelivererName').value = delivery.delivererName;
                    document.getElementById('editCustomerName').value = delivery.customerName;
                    document.getElementById('editDeliveryAddress').value = delivery.deliveryAddress;
                    
                    // Hiển thị modal
                    document.getElementById('editModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu chỉnh sửa:', error);
                });
        }
        
        // Chỉnh sửa đóng hàng
        function editPacking(key) {
            currentPackingEditKey = key;
            database.ref('packings/' + key).once('value')
                .then(snapshot => {
                    const packing = snapshot.val();
                    document.getElementById('editPackingKey').value = key;
                    document.getElementById('editPackingOrderId').value = packing.orderId;
                    document.getElementById('editPackingCustomerName').value = packing.customerName;
                    document.getElementById('editPackingAddress').value = packing.address;
                    document.getElementById('editPackingDate').value = packing.packingDate;
                    document.getElementById('editPackingStatus').value = packing.isDelivered;
                    
                    // Hiển thị modal
                    document.getElementById('editPackingModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu chỉnh sửa:', error);
                });
        }
        
        // Cập nhật giao hàng
        function updateDelivery() {
            const key = document.getElementById('editKey').value;
            const orderId = document.getElementById('editOrderId').value.toUpperCase();
            const deliveryDate = document.getElementById('editDeliveryDate').value;
            const delivererName = document.getElementById('editDelivererName').value;
            const customerName = document.getElementById('editCustomerName').value;
            const deliveryAddress = document.getElementById('editDeliveryAddress').value;
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const updatedData = {
                orderId: orderId,
                deliveryDate: deliveryDate,
                delivererName: delivererName,
                customerName: customerName,
                deliveryAddress: deliveryAddress,
                timestamp: new Date().toISOString()
            };
            
            database.ref('deliveries/' + key).update(updatedData)
                .then(() => {
                    alert('Đã cập nhật thông tin giao hàng thành công!');
                    closeModal();
                    loadDeliveryData();
                })
                .catch(error => {
                    console.error('Lỗi khi cập nhật dữ liệu:', error);
                    alert('Có lỗi xảy ra khi cập nhật dữ liệu!');
                });
        }
        
        // Cập nhật đóng hàng
        function updatePacking() {
            const key = document.getElementById('editPackingKey').value;
            const orderId = document.getElementById('editPackingOrderId').value.toUpperCase();
            const customerName = document.getElementById('editPackingCustomerName').value;
            const address = document.getElementById('editPackingAddress').value;
            const packingDate = document.getElementById('editPackingDate').value;
            const isDelivered = document.getElementById('editPackingStatus').value === 'true';
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const updatedData = {
                orderId: orderId,
                customerName: customerName,
                address: address,
                packingDate: packingDate,
                isDelivered: isDelivered,
                timestamp: new Date().toISOString()
            };
            
            database.ref('packings/' + key).update(updatedData)
                .then(() => {
                    alert('Đã cập nhật thông tin đóng hàng thành công!');
                    closePackingModal();
                    loadPackingData();
                })
                .catch(error => {
                    console.error('Lỗi khi cập nhật dữ liệu:', error);
                    alert('Có lỗi xảy ra khi cập nhật dữ liệu!');
                });
        }
        
        // Xác nhận xóa giao hàng
        function confirmDeleteDelivery(key) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) {
                deleteDelivery(key);
            }
        }
        
        // Xác nhận xóa đóng hàng
        function confirmDeletePacking(key) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) {
                deletePacking(key);
            }
        }
        
        // Xóa giao hàng
        function deleteDelivery(key) {
            database.ref('deliveries/' + key).remove()
                .then(() => {
                    alert('Đã xóa đơn hàng thành công!');
                    closeModal();
                    loadDeliveryData();
                })
                .catch(error => {
                    console.error('Lỗi khi xóa dữ liệu:', error);
                    alert('Có lỗi xảy ra khi xóa dữ liệu!');
                });
        }
        
        // Xóa đóng hàng
        function deletePacking(key) {
            database.ref('packings/' + key).remove()
                .then(() => {
                    alert('Đã xóa đơn hàng thành công!');
                    closePackingModal();
                    loadPackingData();
                })
                .catch(error => {
                    console.error('Lỗi khi xóa dữ liệu:', error);
                    alert('Có lỗi xảy ra khi xóa dữ liệu!');
                });
        }
        
        // Đóng modal
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // Đóng modal đóng hàng
        function closePackingModal() {
            document.getElementById('editPackingModal').style.display = 'none';
        }
        
        // Hiển thị modal xác nhận chuyển giao hàng
        function showTransferConfirmModal(confirmCallback) {
            const modal = document.getElementById('transferConfirmModal');
            modal.style.display = 'block';
            
            document.getElementById('confirmTransferBtn').onclick = function() {
                modal.style.display = 'none';
                confirmCallback();
            };
        }
        
        // Đóng modal xác nhận chuyển giao hàng
        function closeTransferConfirmModal() {
            document.getElementById('transferConfirmModal').style.display = 'none';
        }
        
        // Hiển thị modal hướng dẫn
        function showHelpModal() {
            document.getElementById('helpModal').style.display = 'block';
        }
        
        // Đóng modal hướng dẫn
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        // Xem địa chỉ trên bản đồ
        function viewOnMap(addressFieldId) {
            const address = document.getElementById(addressFieldId).value;
            if (!address) {
                alert('Vui lòng nhập địa chỉ trước!');
                return;
            }
            
            const encodedAddress = encodeURIComponent(address);
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
        }
        
        // Tạo báo cáo giao hàng
        function generateDeliveryReport() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('deliveryFromDate').value;
            const toDate = document.getElementById('deliveryToDate').value;
            
            let startDate, endDate;
            
            if (fromDate && toDate) {
                startDate = new Date(fromDate);
                endDate = new Date(toDate);
                endDate.setHours(23, 59, 59, 999);
            } else {
                // Xử lý theo loại báo cáo
                const now = new Date();
                
                switch (reportType) {
                    case 'daily':
                        const reportDate = new Date(document.getElementById('reportDate').value);
                        startDate = new Date(reportDate);
                        endDate = new Date(reportDate);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'weekly':
                        const reportWeek = document.getElementById('reportWeek').value;
                        startDate = new Date(reportWeek);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'monthly':
                        const reportMonth = document.getElementById('reportMonth').value;
                        startDate = new Date(reportMonth);
                        endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                }
            }
            
            // Hiển thị spinner
            document.getElementById('reportSpinner').style.display = 'block';
            
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const reportTableBody = document.getElementById('reportTableBody');
                    reportTableBody.innerHTML = '';
                    
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        const deliveryDate = new Date(delivery.deliveryDate);
                        
                        if (deliveryDate >= startDate && deliveryDate <= endDate) {
                            count++;
                            const row = reportTableBody.insertRow();
                            row.innerHTML = `
                                <td>${count}</td>
                                <td>${delivery.orderId}</td>
                                <td>${delivery.deliveryDate}</td>
                                <td>${delivery.delivererName}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteDelivery('${childSnapshot.key}')">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </td>
                            `;
                        }
                    });
                    
                    // Ẩn spinner
                    document.getElementById('reportSpinner').style.display = 'none';
                    
                    if (count === 0) {
                        reportTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Không có dữ liệu</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi tạo báo cáo:', error);
                    document.getElementById('reportSpinner').style.display = 'none';
                });
        }
        
        // Tạo báo cáo đóng hàng
        function generatePackingReport() {
            const reportType = document.getElementById('packingReportType').value;
            const fromDate = document.getElementById('packingFromDate').value;
            const toDate = document.getElementById('packingToDate').value;
            
            let startDate, endDate;
            
            if (fromDate && toDate) {
                startDate = new Date(fromDate);
                endDate = new Date(toDate);
                endDate.setHours(23, 59, 59, 999);
            } else {
                // Xử lý theo loại báo cáo
                const now = new Date();
                
                switch (reportType) {
                    case 'daily':
                        const reportDate = new Date(document.getElementById('packingReportDate').value);
                        startDate = new Date(reportDate);
                        endDate = new Date(reportDate);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'weekly':
                        const reportWeek = document.getElementById('packingReportWeek').value;
                        startDate = new Date(reportWeek);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'monthly':
                        const reportMonth = document.getElementById('packingReportMonth').value;
                        startDate = new Date(reportMonth);
                        endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                }
            }
            
            // Hiển thị spinner
            document.getElementById('packingReportSpinner').style.display = 'block';
            
            database.ref('packings').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const reportTableBody = document.getElementById('packingReportTableBody');
                    reportTableBody.innerHTML = '';
                    
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const packing = childSnapshot.val();
                        const packingDate = new Date(packing.packingDate);
                        
                        if (packingDate >= startDate && packingDate <= endDate) {
                            count++;
                            const row = reportTableBody.insertRow();
                            row.innerHTML = `
                                <td>${count}</td>
                                <td>${packing.orderId}</td>
                                <td>${packing.packingDate}</td>
                                <td>${packing.customerName}</td>
                                <td>${packing.address}</td>
                                <td>
                                    <span class="packing-status ${packing.isDelivered ? 'packed' : 'not-packed'}">
                                        ${packing.isDelivered ? 'Đã giao' : 'Chờ giao'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDeletePacking('${childSnapshot.key}')">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </td>
                            `;
                        }
                    });
                    
                    // Ẩn spinner
                    document.getElementById('packingReportSpinner').style.display = 'none';
                    
                    if (count === 0) {
                        reportTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Không có dữ liệu</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi tạo báo cáo:', error);
                    document.getElementById('packingReportSpinner').style.display = 'none';
                });
        }
        
        // Xóa báo cáo giao hàng
        function clearDeliveryReport() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu giao hàng?')) {
                database.ref('deliveries').remove()
                    .then(() => {
                        alert('Đã xóa tất cả dữ liệu giao hàng!');
                        loadDeliveryData();
                        document.getElementById('reportTableBody').innerHTML = '';
                    })
                    .catch(error => {
                        console.error('Lỗi khi xóa dữ liệu:', error);
                        alert('Có lỗi xảy ra khi xóa dữ liệu!');
                    });
            }
        }
        
        // Xóa báo cáo đóng hàng
        function clearPackingReport() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu đóng hàng?')) {
                database.ref('packings').remove()
                    .then(() => {
                        alert('Đã xóa tất cả dữ liệu đóng hàng!');
                        loadPackingData();
                        document.getElementById('packingReportTableBody').innerHTML = '';
                    })
                    .catch(error => {
                        console.error('Lỗi khi xóa dữ liệu:', error);
                        alert('Có lỗi xảy ra khi xóa dữ liệu!');
                    });
            }
        }
        
        // Xuất Excel giao hàng
        function exportDeliveryToExcel() {
            const table = document.getElementById('reportTable');
            if (table.rows.length <= 1) {
                alert('Không có dữ liệu để xuất!');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Báo cáo giao hàng');
            XLSX.writeFile(wb, 'bao_cao_giao_hang.xlsx');
        }
        
        // Xuất Excel đóng hàng
        function exportPackingToExcel() {
            const table = document.getElementById('packingReportTable');
            if (table.rows.length <= 1) {
                alert('Không có dữ liệu để xuất!');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Báo cáo đóng hàng');
            XLSX.writeFile(wb, 'bao_cao_dong_hang.xlsx');
        }
        
        // Tìm kiếm đơn hàng
        function searchOrders() {
            const searchTerm = document.getElementById('searchOrder').value.toLowerCase();
            const managementTableBody = document.getElementById('managementTableBody');
            managementTableBody.innerHTML = '';
            
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let found = false;
                    
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        
                        if (delivery.orderId.toLowerCase().includes(searchTerm) || 
                            delivery.customerName.toLowerCase().includes(searchTerm)) {
                            found = true;
                            const row = managementTableBody.insertRow();
                            row.innerHTML = `
                                <td>${delivery.orderId}</td>
                                <td>${delivery.deliveryDate}</td>
                                <td>${delivery.delivererName}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td class="action-btns">
                                    <button class="btn btn-sm btn-warning" onclick="editDelivery('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteDelivery('${childSnapshot.key}')">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </td>
                            `;
                        }
                    });
                    
                    if (!found) {
                        managementTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Không tìm thấy đơn hàng</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi tìm kiếm đơn hàng:', error);
                });
        }
        
        // Chuyển đổi hiển thị input báo cáo
        function toggleReportInputs(reportType, prefix) {
            const dateInput = document.getElementById(`${prefix}Date`);
            const weekInput = document.getElementById(`${prefix}Week`);
            const monthInput = document.getElementById(`${prefix}Month`);
            
            dateInput.style.display = 'none';
            weekInput.style.display = 'none';
            monthInput.style.display = 'none';
            
            if (reportType === 'daily') {
                dateInput.style.display = 'block';
            } else if (reportType === 'weekly') {
                weekInput.style.display = 'block';
            } else if (reportType === 'monthly') {
                monthInput.style.display = 'block';
            }
        }
        
        // Tải dữ liệu khách hàng
        function loadCustomerData() {
            database.ref('customers').once('value')
                .then(snapshot => {
                    customerData = [];
                    const customerTableBody = document.getElementById('customerTableBody');
                    customerTableBody.innerHTML = '';
                    
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const customer = childSnapshot.val();
                        customerData.push(customer);
                        
                        count++;
                        const row = customerTableBody.insertRow();
                        row.innerHTML = `
                            <td>${count}</td>
                            <td>${customer.name}</td>
                            <td>${customer.address}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${childSnapshot.key}')">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </td>
                        `;
                    });
                    
                    if (count === 0) {
                        customerTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Chưa có dữ liệu khách hàng</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu khách hàng:', error);
                });
        }
        
        // Xóa khách hàng
        function deleteCustomer(key) {
            if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                database.ref('customers/' + key).remove()
                    .then(() => {
                        alert('Đã xóa khách hàng thành công!');
                        loadCustomerData();
                    })
                    .catch(error => {
                        console.error('Lỗi khi xóa khách hàng:', error);
                        alert('Có lỗi xảy ra khi xóa khách hàng!');
                    });
            }
        }
        
        // Tải lên file Excel
        function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Vui lòng chọn file Excel!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Lấy sheet đầu tiên
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    alert('File Excel không có dữ liệu!');
                    return;
                }
                
                // Xác định cột chứa tên và địa chỉ
                const firstRow = jsonData[0];
                let nameKey = null;
                let addressKey = null;
                
                for (let key in firstRow) {
                    if (key.toLowerCase().includes('tên') || key.toLowerCase().includes('name')) {
                        nameKey = key;
                    } else if (key.toLowerCase().includes('địa chỉ') || key.toLowerCase().includes('address')) {
                        addressKey = key;
                    }
                }
                
                if (!nameKey || !addressKey) {
                    alert('Không tìm thấy cột Tên và Địa chỉ trong file Excel!');
                    return;
                }
                
                // Lưu dữ liệu vào Firebase
                let successCount = 0;
                let errorCount = 0;
                
                jsonData.forEach((row, index) => {
                    const customerName = row[nameKey];
                    const customerAddress = row[addressKey];
                    
                    if (customerName && customerAddress) {
                        const customerData = {
                            name: customerName,
                            address: customerAddress,
                            timestamp: new Date().toISOString()
                        };
                        
                        database.ref('customers').push(customerData)
                            .then(() => {
                                successCount++;
                            })
                            .catch(error => {
                                console.error('Lỗi khi lưu khách hàng:', error);
                                errorCount++;
                            })
                            .finally(() => {
                                if (index === jsonData.length - 1) {
                                    alert(`Đã tải lên ${successCount} khách hàng. ${errorCount > 0 ? `Có ${errorCount} lỗi xảy ra.` : ''}`);
                                    loadCustomerData();
                                }
                            });
                    } else {
                        errorCount++;
                    }
                });
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Khởi tạo autocomplete
        function initAutocomplete() {
            const customerInputs = [
                document.getElementById('customerName'),
                document.getElementById('packingCustomerName'),
                document.getElementById('editCustomerName'),
                document.getElementById('editPackingCustomerName')
            ];
            
            customerInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        const val = this.value;
                        closeAllLists();
                        
                        if (!val) return false;
                        
                        // Tạo container cho các gợi ý
                        const list = document.createElement('div');
                        list.setAttribute('id', this.id + '-autocomplete-list');
                        list.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(list);
                        
                        // Lọc dữ liệu khách hàng
                        const filteredCustomers = customerData.filter(customer => 
                            customer.name.toLowerCase().includes(val.toLowerCase())
                        );
                        
                        if (filteredCustomers.length === 0) {
                            list.innerHTML = '<div>Không tìm thấy khách hàng</div>';
                            return;
                        }
                        
                        // Hiển thị kết quả
                        filteredCustomers.forEach(customer => {
                            const item = document.createElement('div');
                            item.innerHTML = `<strong>${customer.name}</strong> - ${customer.address}`;
                            item.innerHTML += `<input type='hidden' value='${customer.name}'>`;
                            
                            item.addEventListener('click', function() {
                                input.value = this.getElementsByTagName('input')[0].value;
                                
                                // Tìm địa chỉ tương ứng
                                const customerInfo = customerData.find(c => c.name === customer.name);
                                if (customerInfo) {
                                    let addressField;
                                    
                                    if (input.id === 'customerName' || input.id === 'editCustomerName') {
                                        addressField = input.id === 'customerName' ? 
                                            document.getElementById('deliveryAddress') : 
                                            document.getElementById('editDeliveryAddress');
                                    } else {
                                        addressField = input.id === 'packingCustomerName' ? 
                                            document.getElementById('packingAddress') : 
                                            document.getElementById('editPackingAddress');
                                    }
                                    
                                    if (addressField) {
                                        addressField.value = customerInfo.address;
                                    }
                                }
                                
                                closeAllLists();
                            });
                            
                            list.appendChild(item);
                        });
                    });
                    
                    // Đóng danh sách khi click ra ngoài
                    document.addEventListener('click', function(e) {
                        closeAllLists(e.target);
                    });
                }
            });
        }
        
        // Đóng tất cả danh sách autocomplete
        function closeAllLists(elmnt) {
            const items = document.getElementsByClassName('autocomplete-items');
            for (let i = 0; i < items.length; i++) {
                if (elmnt !== items[i] && elmnt) {
                    items[i].parentNode.removeChild(items[i]);
                }
            }
        }
        
        // Gọi hàm autoUppercaseOrderId để kích hoạt tính năng
        autoUppercaseOrderId();
    </script>
</body>
</html>
