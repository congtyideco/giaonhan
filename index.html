<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đóng hàng & Giao hàng - KPI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        h1, h2, h3 {
            margin: 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .section-divider {
            margin: 20px 0;
            border-top: 1px solid #ddd;
        }
        
        /* Trạng thái đóng gói */
        .packing-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .packed {
            background-color: var(--success-color);
            color: white;
        }
        
        .not-packed {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Input groups */
        .address-group, .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .address-group input, .input-group input {
            flex: 1;
        }
        
        .map-btn, .add-btn {
            padding: 10px 12px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-btn {
            background-color: #34a853;
        }
        .map-btn:hover {
            background-color: #2d8e47;
        }
        .add-btn {
            background-color: var(--success-color);
        }
        .add-btn:hover {
             background-color: #27ae60;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .address-group {
                flex-direction: column;
                gap: 5px;
            }
            
            .map-btn, .add-btn {
                width: 100%;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Help button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        /* Help content */
        .help-content {
            line-height: 1.8;
        }
        
        .help-content h3 {
            margin-top: 15px;
            color: var(--primary-color);
        }
        
        .help-content ul {
            padding-left: 20px;
        }
        
        /* Autocomplete */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        
        .autocomplete-active {
            background-color: var(--primary-color) !important;
            color: #ffffff;
        }
        
        /* File upload */
        .file-upload-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
        }
        
        .file-upload-container p {
            margin-bottom: 10px;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .file-upload-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .customer-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        /* CSS cho canvas chữ ký */
        #signaturePad {
            width: 100%;
            height: 200px;
            cursor: crosshair;
        }
        
        /* Đảm bảo canvas có nền trắng */
        .modal-content canvas {
            background-color: #fff;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>Quản lý Đóng hàng & Giao hàng - KPI kho vận (IDECO)</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="packing">Đóng hàng</div>
            <div class="tab" data-tab="delivery">Giao hàng</div>
            <div class="tab" data-tab="reports">Báo cáo</div>
            <div class="tab" data-tab="management">Quản lý</div>
            <div class="tab" data-tab="customer-data">Dữ liệu KH</div>
        </div>
        
        <div class="tab-content active" id="packing-tab">
            <div class="card">
                <h2>Nhập thông tin đóng hàng</h2>
                <div class="form-group">
                    <label for="packingOrderId">Mã đơn hàng:</label>
                    <input type="text" id="packingOrderId" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="form-group autocomplete">
                    <label for="packingCustomerName">Tên khách hàng:</label>
                    <input type="text" id="packingCustomerName" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="packingAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="packingAddress" required>
                        <button class="map-btn" onclick="viewOnMap('packingAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="packingDate">Ngày đóng hàng:</label>
                    <input type="date" id="packingDate" required>
                </div>
                
                <div class="form-group">
                    <label for="packingNotes">Ghi chú đóng hàng:</label>
                    <textarea id="packingNotes" placeholder="Nhập ghi chú về quy cách đóng gói, số lượng thùng... (nếu có)"></textarea>
                </div>

                <button class="btn btn-primary" onclick="savePacking()">
                    <i class="fas fa-box"></i> Xác nhận đơn đã đóng hàng xong
                </button>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayPackedCount">0</div>
                    <p>đơn đã đóng hàng</p>
                </div>
                <div class="stat-card">
                    <h3>Chờ giao</h3>
                    <div class="stat-value" id="waitingDeliveryCount">0</div>
                    <p>đơn sẵn sàng giao</p>
                </div>
                <div class="stat-card">
                    <h3>Đã kết thúc</h3>
                    <div class="stat-value" id="deliveredCount">0</div>
                    <p>đơn đã giao xong</p>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="card">
                <h2>Danh sách đơn hàng đã đóng hôm nay</h2>
                <table id="packingTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="packingTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="delivery-tab">
            <div class="card">
                <h2>Nhập thông tin giao hàng</h2>
                
                <div class="form-group autocomplete">
                    <label for="customerName">Tên khách hàng (Gõ để chọn đơn "Chờ giao"):</label>
                    <input type="text" id="customerName" required autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="orderId">Mã đơn hàng:</label>
                    <input type="text" id="orderId" required oninput="this.value = this.value.toUpperCase()">
                </div>

                <div class="form-group autocomplete">
                    <label for="delivererName">Tên người giao:</label>
                    <div class="input-group">
                         <input type="text" id="delivererName" placeholder="Ví dụ: Anh A, Chị B" required autocomplete="off">
                         <button class="map-btn" onclick="showSignatureModal('delivererName')" title="Ký tên" style="background-color: #17a2b8;">
                            <i class="fas fa-signature"></i>
                        </button>
                         <button class="add-btn" onclick="showAddDelivererModal()" title="Thêm người giao mới">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <img id="delivererName_sig_preview" src="" alt="Chữ ký" style="display:none; max-height: 100px; border: 1px solid #ddd; margin-top: 10px; background: white;">
                    <input type="hidden" id="delivererName_sig_data">
                </div>

                <div class="form-group">
                    <label for="deliveryDate">Ngày giao hàng:</label>
                    <input type="date" id="deliveryDate" required>
                </div>

                <div class="form-group">
                    <label for="deliveryAddress">Địa chỉ giao:</label>
                    <div class="address-group">
                        <input type="text" id="deliveryAddress" required>
                        <button class="map-btn" onclick="viewOnMap('deliveryAddress')" title="Xem trên bản đồ">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="deliveryNotes">Ghi chú giao hàng:</label>
                    <textarea id="deliveryNotes" placeholder="Nhập ghi chú về quá trình giao hàng (nếu có)"></textarea>
                </div>

                <button class="btn btn-primary" onclick="saveDelivery()">
                    <i class="fas fa-save"></i> Giao xong - hay phải giao mới bấm lưu dữ liệu
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Hôm nay</h3>
                    <div class="stat-value" id="todayCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tuần này</h3>
                    <div class="stat-value"id="weeklyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tháng này</h3>
                    <div class="stat-value" id="monthlyCount">0</div>
                    <p>đơn hàng đã giao</p>
                </div>
            </div>
            
            <div class="card">
                <h2>Danh sách giao hàng hôm nay</h2>
                <table id="deliveryTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="reports-tab">
            <div class="card">
                <h2>Báo cáo giao hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="reportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="reportDate" class="form-control">
                        <input type="week" id="reportWeek" class="form-control" style="display: none;">
                        <input type="month" id="reportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="deliveryFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="deliveryToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generateDeliveryReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportDeliveryToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearDeliveryReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="reportSpinner"></div>
                
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Chữ ký</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Ghi chú</th>
                            <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        </tbody>
                </table>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h2>Báo cáo đóng hàng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Loại báo cáo</label>
                        <select id="packingReportType" class="form-control">
                            <option value="daily">Theo ngày</option>
                            <option value="weekly">Theo tuần</option>
                            <option value="monthly">Theo tháng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Chọn ngày / tuần / tháng</label>
                        <input type="date" id="packingReportDate" class="form-control">
                        <input type="week" id="packingReportWeek" class="form-control" style="display: none;">
                        <input type="month" id="packingReportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Từ ngày</label>
                        <input type="date" id="packingFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Đến ngày</label>
                        <input type="date" id="packingToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generatePackingReport()">
                            <i class="fas fa-search"></i> Tạo báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportPackingToExcel()">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearPackingReport()">
                            <i class="fas fa-trash"></i> Xóa báo cáo
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-info" onclick="syncAllPackingStatus()">
                            <i class="fas fa-sync"></i> Đồng bộ trạng thái
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="packingReportSpinner"></div>
                
                <table id="packingReportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn</th>
                            <th>Ngày đóng</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Trạng thái giao</th>
                            <th>Ghi chú</th> <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="packingReportTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="management-tab">
            <div class="card">
                <h2>Quản lý đơn hàng</h2>
                
                <div class="form-group">
                    <label for="searchOrder">Tìm kiếm đơn hàng:</label>
                    <div style="display: flex;">
                        <input type="text" id="searchOrder" placeholder="Nhập mã đơn hoặc tên KH">
                        <button class="btn btn-primary" onclick="searchOrders()" style="margin-left: 10px;">
                            <i class="fas fa-search"></i> Tìm
                        </button>
                    </div>
                </div>
                
                <table id="managementTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày giao</th>
                            <th>Người giao</th>
                            <th>Khách hàng</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="managementTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="customer-data-tab">
            <div class="card">
                <h2>Quản lý dữ liệu khách hàng</h2>
                
                <div class="file-upload-container">
                    <p>Tải lên file Excel chứa dữ liệu khách hàng</p>
                    <p><small>File Excel cần có các cột: TênKhachHang, DiaChi (hoặc tên cột tương tự)</small></p>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls">
                    <label for="excelFile" class="file-upload-btn">
                        <i class="fas fa-upload"></i> Chọn file Excel
                    </label>
                    <button class="btn btn-primary" onclick="uploadExcel()" style="margin-left: 10px;">
                        <i class="fas fa-cloud-upload-alt"></i> Tải lên
                    </button>
                </div>
                
                <div class="customer-table-container">
                    <table id="customerTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên khách hàng</th>
                                <th>Địa chỉ</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">×</span>
            <h2>Chỉnh sửa đơn hàng</h2>
            <input type="hidden" id="editKey">
            
            <div class="form-group autocomplete">
                <label for="editCustomerName">Tên khách hàng:</label>
                <input type="text" id="editCustomerName" required autocomplete="off">
            </div>

            <div class="form-group">
                <label for="editOrderId">Mã đơn hàng:</label>
                <input type="text" id="editOrderId" required oninput="this.value = this.value.toUpperCase()">
            </div>
            
            <div class="form-group autocomplete">
                <label for="editDelivererName">Tên người giao:</label>
                 <div class="input-group">
                    <input type="text" id="editDelivererName" required autocomplete="off">
                     <button type="button" class="map-btn" onclick="showSignatureModal('editDelivererName')" title="Ký tên" style="background-color: #17a2b8;">
                        <i class="fas fa-signature"></i>
                    </button>
                     <button type="button" class="add-btn" onclick="showAddDelivererModal()" title="Thêm người giao mới">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <img id="editDelivererName_sig_preview" src="" alt="Chữ ký" style="display:none; max-height: 100px; border: 1px solid #ddd; margin-top: 10px; background: white;">
                <input type="hidden" id="editDelivererName_sig_data">
            </div>
            
            <div class="form-group">
                <label for="editDeliveryDate">Ngày giao hàng:</label>
                <input type="date" id="editDeliveryDate" required>
            </div>
            
            <div class="form-group">
                <label for="editDeliveryAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editDeliveryAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editDeliveryAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="editDeliveryNotes">Ghi chú giao hàng:</label>
                <textarea id="editDeliveryNotes" placeholder="Nhập ghi chú về quá trình giao hàng (nếu có)"></textarea>
            </div>

            <button class="btn btn-primary" onclick="updateDelivery()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeleteDelivery(currentEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <div id="editPackingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePackingModal()">×</span>
            <h2>Chỉnh sửa đơn đóng hàng</h2>
            <input type="hidden" id="editPackingKey">
            <div class="form-group">
                <label for="editPackingOrderId">Mã đơn hàng:</label>
                <input type="text" id="editPackingOrderId" required oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="form-group autocomplete">
                <label for="editPackingCustomerName">Tên khách hàng:</label>
                <input type="text" id="editPackingCustomerName" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="editPackingAddress">Địa chỉ giao:</label>
                <div class="address-group">
                    <input type="text" id="editPackingAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editPackingAddress')" title="Xem trên bản đồ">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="editPackingDate">Ngày đóng hàng:</label>
                <input type="date" id="editPackingDate" required>
            </div>
            
            <div class="form-group">
                <label for="editPackingNotes">Ghi chú đóng hàng:</label>
                <textarea id="editPackingNotes" placeholder="Nhập ghi chú về quy cách đóng gói..."></textarea>
            </div>

            <div class="form-group">
                <label for="editPackingStatus">Trạng thái giao hàng:</label>
                <select id="editPackingStatus" class="form-control">
                    <option value="false">Chờ giao</option>
                    <option value="true">Đã kết thúc</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="updatePacking()">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <button class="btn btn-danger" onclick="confirmDeletePacking(currentPackingEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
    
    <div id="transferConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeTransferConfirmModal()">×</span>
             <h2>EM NÊN ĐỌC NỘI DUNG SAU CẨN THẬN !</h2>
            <p style="margin-top:10px; white-space: pre-line;">
Em đã sẵn sàng mang đi giao hàng hay đơn vị giao đến nhận ngay chưa ? kiểm tra lại lộ trình chưa ?báo nhiêu kiện cho đơn này?
Khi giao hàng đảm bảo thùng hàng có tem nhãn ghi chính xác không? có hóa đơn, đơn hàng kèm  theo thùng chưa? phải đảm bảo đầy_đủ
Nếu đã bấm chuyển giao hàng thì phải hoàn thành giao hàng ngay tránh đơn hàng khai báo bị trôi tin, sót đơn trên ứng dụng
Hàng giao phải xem lại thông tin giao, thanh toán. Dù bất cứ nhân viên nào đang thu lý giao phải khai thông tin giao mới được giao hàng.
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTransferConfirmModal()">Hủy</button>
                <button class="btn btn-primary" id="confirmTransferBtn">Đồng ý</button>
            </div>
        </div>
    </div>

    <div id="addDelivererModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddDelivererModal()">×</span>
            <h2>Thêm người giao hàng mới</h2>
            <div class="form-group">
                <label for="newDelivererName">Tên người giao:</label>
                <input type="text" id="newDelivererName" placeholder="Nhập tên người giao" required>
            </div>
            <div class="modal-actions">
                 <button class="btn" onclick="closeAddDelivererModal()" style="background-color: #ccc;">Hủy</button>
                <button class="btn btn-primary" onclick="saveDeliverer()">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>
    
    <div id="signatureModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-btn" onclick="closeSignatureModal()">×</span>
            <h2>Ký tên người giao</h2>
            <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden; width: 100%; touch-action: none;">
                <canvas id="signaturePad"></canvas>
            </div>
            <div class="modal-actions">
                 <button class="btn" onclick="clearSignature()" style="background-color: #ccc; margin-right: auto;">
                    <i class="fas fa-eraser"></i> Xóa
                 </button>
                 <button class="btn" onclick="closeSignatureModal()" style="background-color: var(--danger-color); color: white;">Hủy</button>
                <button class="btn btn-primary" id="saveSignatureBtn">
                    <i class="fas fa-save"></i> Lưu chữ ký
                </button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHelpModal()">×</span>
            <h2>Hướng dẫn sử dụng</h2>
            <div class="help-content">
                <h3>1. Phần này do: Điều phối kho đảm nhận khai báo - ngoài ra Quản lý kho vận cũng được tham gia </h3>
                <ul>
                    <li>Sau khi mọi đơn hàng đã được đóng xong sẵn sàng giao ra kho thì phải khai báo ngay trước khi ra khỏi kho</li>
                    <li>Mã đơn hàng từ đơn hàng ERP in ra và nhập đúng chính xác</li>
                    <li>Thông tin tên khách hàng- địa chỉ giao hàng phải điền đủ hay chỉnh lại đúng sau đó</li>
                    <li>Khi đóng hàng đơn hàng này thì xử lý xong rồi bấm đã xong đóng gói</li>
                    <li>Trạng thái báo: đang chờ màu đỏ tức là tình trạnh đơn chưa được giao đang tạm lưu kho</li>
                </ul>
                
                <h3>2. Giao hàng -Phần này do phụ trách điều phối vận chuyển- giao hàng hay người hỗ trợ giao hàng thực hiện</h3>
                <ul>
                    <li>Nhấp vào ô "Tên khách hàng" để chọn nhanh từ các đơn hàng "Chờ giao".</li>
                    <li>Mã đơn hàng và Địa chỉ sẽ được tự động điền.</li>
                    <li>Nhập/chọn "Tên người giao" và "Ngày giao".</li>
                    <li>Nhấn nút "Ký tên" (<i class="fas fa-signature"></i>) để ký tên bằng tay.</li>
                    <li>Nhập "Ghi chú giao hàng" nếu có thông tin cần lưu ý về quá trình giao hàng.</li>
                    <li>Chỉ nhấn "Giao xong" khi đơn hàng đã được giao thành công.</li>
                    <li>Khi "Giao xong", đơn hàng bên tab "Đóng hàng" sẽ tự động cập nhật là "Đã kết thúc".</li>
                </ul>
                
                <h3>3. Báo cáo</h3>
                <ul>
                    <li>Chọn loại báo cáo (ngày/tuần/tháng) hoặc khoảng thời gian cụ thể</li>
                    <li>Nhấn "Tạo báo cáo" để xem dữ liệu (bao gồm cả chữ ký và ghi chú)</li>
                    <li>Báo cáo đóng hàng sẽ tự động đối soát với báo cáo giao hàng để hiển thị trạng thái chính xác nhất.</li>
                    <li>Xuất Excel để tải báo cáo về máy tính (Lưu ý: Excel không xuất được ảnh chữ ký)</li>
                    <li>Xóa báo cáo để xóa dữ liệu đã chọn</li>
                    <li>Nhấn "Đồng bộ trạng thái" để cập nhật lại trạng thái đóng hàng theo dữ liệu giao hàng mới nhất</li>
                </ul>
                
                <h3>4. Quản lý</h3>
                <ul>
                    <li>Tìm kiếm đơn hàng theo mã đơn hoặc tên khách hàng</li>
                    <li>Chỉnh sửa hoặc xóa đơn hàng nếu có sai sót (có thể sửa cả chữ ký và ghi chú)</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="help-btn" onclick="showHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyA2Xa3zF8CCOccQhq7nvqooUTabnq5N4qM",
            authDomain: "quanlykho-21f95.firebaseapp.com",
            projectId: "quanlykho-21f95",
            storageBucket: "quanlykho-21f95.appspot.com",
            messagingSenderId: "1082567127195",
            appId: "1:1082567127195:web:dfec69dab7d492c095563e",
            measurementId: "G-RCXEM8VP68"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Biến toàn cục
        let currentEditKey = null;
        let currentPackingEditKey = null;
        let customerData = [];
        let delivererData = []; 
        let signaturePad = null; 
        let currentSignatureTarget = null; 
        let pendingPackingData = []; 
        let completedDeliveriesSet = new Set();
        
        // Khởi tạo khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').value = today;
            document.getElementById('packingDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('packingReportDate').value = today;
            
            loadDeliveryData();
            loadPackingData();
            loadCustomerData();
            loadDelivererData(); 
            loadPendingPackingData(); 
            loadCompletedDeliveries(); // Tải danh sách đã giao để đối soát

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            document.getElementById('reportType').addEventListener('change', function() {
                toggleReportInputs(this.value, 'report');
            });
            
            document.getElementById('packingReportType').addEventListener('change', function() {
                toggleReportInputs(this.value, 'packingReport');
            });
            
            initCustomerAutocomplete(); 
            initPendingPackingAutocomplete(); 
            initDelivererAutocomplete(); 
        });
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabId}-tab`).classList.add('active');
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) tab.classList.add('active');
            });
        }
        
        function autoUppercaseOrderId() {
            ['orderId', 'packingOrderId', 'editOrderId', 'editPackingOrderId'].forEach(id => {
                 const input = document.getElementById(id);
                 if(input) {
                    input.addEventListener('input', function() { this.value = this.value.toUpperCase(); });
                 }
            });
        }
        
        // Tải các đơn hàng "Chờ giao"
        function loadPendingPackingData() {
            pendingPackingData = [];
            database.ref('packings').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const packing = childSnapshot.val();
                        if (!packing.isDelivered) {
                            packing.key = childSnapshot.key; 
                            pendingPackingData.push(packing);
                        }
                    });
                    pendingPackingData.reverse();
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu chờ giao:', error));
        }

        // Tải toàn bộ danh sách đơn đã giao để đối soát báo cáo (chuyển sang async)
        async function loadCompletedDeliveries() {
            completedDeliveriesSet.clear();
            try {
                const snapshot = await database.ref('deliveries').once('value');
                snapshot.forEach(childSnapshot => {
                    const delivery = childSnapshot.val();
                    // Tạo một key tổng hợp để kiểm tra (Mã đơn + Tên KH)
                    const compositeKey = delivery.orderId + "||" + delivery.customerName;
                    completedDeliveriesSet.add(compositeKey);
                });
                console.log(`Đã tải ${completedDeliveriesSet.size} đơn hàng đã giao để đối soát.`);
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu giao hàng đã hoàn tất:', error);
            }
        }

        // Cập nhật trạng thái đóng hàng (kiểm tra chéo Mã đơn + Tên KH)
        function updatePackingStatus(orderId, customerName) {
            database.ref('packings').orderByChild('orderId').equalTo(orderId).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const packing = childSnapshot.val();
                            
                            if (packing.customerName === customerName) {
                                database.ref('packings/' + childSnapshot.key).update({ isDelivered: true })
                                    .then(() => {
                                        loadPackingData(); 
                                        loadPendingPackingData(); 
                                    })
                                    .catch(error => console.error('Lỗi khi cập nhật trạng thái đóng hàng:', error));
                            } else {
                                console.warn(`Mã đơn hàng ${orderId} khớp nhưng tên KH không khớp. Giao hàng: ${customerName}, Đóng gói: ${packing.customerName}`);
                            }
                        });
                    }
                })
                .catch(error => console.error('Lỗi khi tìm đơn hàng đóng gói:', error));
        }

        // Lưu dữ liệu giao hàng
        function saveDelivery() {
            const orderId = document.getElementById('orderId').value.toUpperCase();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const delivererName = document.getElementById('delivererName').value;
            const customerName = document.getElementById('customerName').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const deliveryNotes = document.getElementById('deliveryNotes').value;
            const delivererSignature = document.getElementById('delivererName_sig_data').value;
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            showTransferConfirmModal(() => {
                const deliveryData = {
                    orderId, deliveryDate, delivererName, customerName, deliveryAddress,
                    deliveryNotes: deliveryNotes || '',
                    delivererSignature: delivererSignature || null, 
                    timestamp: new Date().toISOString()
                };
                
                database.ref('deliveries').push().set(deliveryData)
                    .then(() => {
                        alert('Đã lưu thông tin giao hàng thành công!');
                        
                        updatePackingStatus(orderId, customerName);

                        const compositeKey = orderId + "||" + customerName;
                        completedDeliveriesSet.add(compositeKey);

                        // Reset form
                        document.getElementById('orderId').value = '';
                        document.getElementById('customerName').value = '';
                        document.getElementById('deliveryAddress').value = '';
                        document.getElementById('delivererName').value = '';
                        document.getElementById('deliveryNotes').value = '';
                        document.getElementById('delivererName_sig_data').value = '';
                        document.getElementById('delivererName_sig_preview').src = '';
                        document.getElementById('delivererName_sig_preview').style.display = 'none';
                        
                        loadDeliveryData(); 
                    })
                    .catch(error => alert('Có lỗi xảy ra khi lưu dữ liệu: ' + error.message));
            });
        }
        
        // Lưu dữ liệu đóng hàng
        function savePacking() {
            const orderId = document.getElementById('packingOrderId').value.toUpperCase();
            const customerName = document.getElementById('packingCustomerName').value;
            const address = document.getElementById('packingAddress').value;
            const packingDate = document.getElementById('packingDate').value;
            const notes = document.getElementById('packingNotes').value; // BỔ SUNG: Lấy dữ liệu ghi chú
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const packingData = {
                orderId, customerName, address, packingDate,
                notes: notes || '', // BỔ SUNG: Lưu ghi chú vào object
                isDelivered: false,
                timestamp: new Date().toISOString()
            };
            
            database.ref('packings').push().set(packingData)
                .then(() => {
                    alert('Đã lưu thông tin đóng hàng thành công!');
                    document.getElementById('packingOrderId').value = '';
                    document.getElementById('packingCustomerName').value = '';
                    document.getElementById('packingAddress').value = '';
                    document.getElementById('packingNotes').value = ''; // Reset ô ghi chú
                    loadPackingData();
                    loadPendingPackingData(); 
                })
                .catch(error => alert('Có lỗi xảy ra khi lưu dữ liệu: ' + error.message));
        }
        
        // Tải dữ liệu giao hàng
        function loadDeliveryData() {
            const today = new Date().toISOString().split('T')[0];
            const deliveryTableBody = document.getElementById('deliveryTableBody');
            deliveryTableBody.innerHTML = '';
            
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let todayCount = 0, weeklyCount = 0, monthlyCount = 0;
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                    startOfWeek.setHours(0,0,0,0);
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        const deliveryDate = new Date(delivery.deliveryDate);
                        
                        if (delivery.deliveryDate === today) todayCount++;
                        if (deliveryDate >= startOfWeek) weeklyCount++;
                        if (deliveryDate >= startOfMonth) monthlyCount++;
                        
                        if (delivery.deliveryDate === today) {
                            const row = deliveryTableBody.insertRow();
                            row.innerHTML = `
                                <td>${delivery.orderId}</td>
                                <td>${delivery.delivererName}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td class="action-btns">
                                    <button class="btn btn-sm btn-warning" onclick="editDelivery('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                </td>`;
                        }
                    });
                    
                    document.getElementById('todayCount').textContent = todayCount;
                    document.getElementById('weeklyCount').textContent = weeklyCount;
                    document.getElementById('monthlyCount').textContent = monthlyCount;
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu giao hàng:', error));
        }
        
        // Tải dữ liệu đóng hàng
        function loadPackingData() {
            const today = new Date().toISOString().split('T')[0];
            const packingTableBody = document.getElementById('packingTableBody');
            packingTableBody.innerHTML = '';
            
            database.ref('packings').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let todayPackedCount = 0, waitingDeliveryCount = 0, deliveredCount = 0;
                    
                    snapshot.forEach(childSnapshot => {
                        const packing = childSnapshot.val();
                        if (packing.packingDate === today) todayPackedCount++;
                        if (!packing.isDelivered) waitingDeliveryCount++; else deliveredCount++;
                        
                        if (packing.packingDate === today) {
                            const row = packingTableBody.insertRow();
                            const statusClass = packing.isDelivered ? 'packed' : 'not-packed';
                            const statusText = packing.isDelivered ? 'Đã kết thúc' : 'Chờ giao';
                            row.innerHTML = `
                                <td>${packing.orderId}</td>
                                <td>${packing.customerName}</td>
                                <td>${packing.address}</td>
                                <td><span class="packing-status ${statusClass}">${statusText}</span></td>
                                <td class="action-btns">
                                    <button class="btn btn-sm btn-warning" onclick="editPacking('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                </td>`;
                        }
                    });
                    
                    document.getElementById('todayPackedCount').textContent = todayPackedCount;
                    document.getElementById('waitingDeliveryCount').textContent = waitingDeliveryCount;
                    document.getElementById('deliveredCount').textContent = deliveredCount;
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu đóng hàng:', error));
        }

        // Tải dữ liệu người giao hàng
        function loadDelivererData() {
            database.ref('deliverers').once('value')
                .then(snapshot => {
                    delivererData = [];
                    snapshot.forEach(childSnapshot => {
                        delivererData.push(childSnapshot.val());
                    });
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu người giao:', error));
        }
        
        // Chỉnh sửa giao hàng
        function editDelivery(key) {
            currentEditKey = key;
            database.ref('deliveries/' + key).once('value')
                .then(snapshot => {
                    const delivery = snapshot.val();
                    document.getElementById('editKey').value = key;
                    document.getElementById('editCustomerName').value = delivery.customerName;
                    document.getElementById('editOrderId').value = delivery.orderId;
                    document.getElementById('editDelivererName').value = delivery.delivererName;
                    document.getElementById('editDeliveryDate').value = delivery.deliveryDate;
                    document.getElementById('editDeliveryAddress').value = delivery.deliveryAddress;
                    document.getElementById('editDeliveryNotes').value = delivery.deliveryNotes || '';
                    
                    const dataInput = document.getElementById('editDelivererName_sig_data');
                    const previewImg = document.getElementById('editDelivererName_sig_preview');
                    if (delivery.delivererSignature) {
                        dataInput.value = delivery.delivererSignature;
                        previewImg.src = delivery.delivererSignature;
                        previewImg.style.display = 'block';
                    } else {
                        dataInput.value = '';
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                    }

                    document.getElementById('editModal').style.display = 'block';
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu chỉnh sửa:', error));
        }
        
        // Chỉnh sửa đóng hàng
        function editPacking(key) {
            currentPackingEditKey = key;
            database.ref('packings/' + key).once('value')
                .then(snapshot => {
                    const packing = snapshot.val();
                    document.getElementById('editPackingKey').value = key;
                    document.getElementById('editPackingOrderId').value = packing.orderId;
                    document.getElementById('editPackingCustomerName').value = packing.customerName;
                    document.getElementById('editPackingAddress').value = packing.address;
                    document.getElementById('editPackingDate').value = packing.packingDate;
                    document.getElementById('editPackingStatus').value = packing.isDelivered;
                    document.getElementById('editPackingNotes').value = packing.notes || ''; // BỔ SUNG: Load ghi chú vào modal
                    document.getElementById('editPackingModal').style.display = 'block';
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu chỉnh sửa:', error));
        }
        
        // Cập nhật giao hàng
        function updateDelivery() {
            const key = document.getElementById('editKey').value;
            const customerName = document.getElementById('editCustomerName').value;
            const orderId = document.getElementById('editOrderId').value.toUpperCase();
            const delivererName = document.getElementById('editDelivererName').value;
            const deliveryDate = document.getElementById('editDeliveryDate').value;
            const deliveryAddress = document.getElementById('editDeliveryAddress').value;
            const deliveryNotes = document.getElementById('editDeliveryNotes').value;
            const delivererSignature = document.getElementById('editDelivererName_sig_data').value;
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const updatedData = {
                orderId, deliveryDate, delivererName, customerName, deliveryAddress,
                deliveryNotes: deliveryNotes || '',
                delivererSignature: delivererSignature || null, 
                timestamp: new Date().toISOString()
            };
            
            database.ref('deliveries/' + key).update(updatedData)
                .then(() => {
                    alert('Đã cập nhật thông tin giao hàng thành công!');
                    
                    updatePackingStatus(orderId, customerName);

                    const compositeKey = orderId + "||" + customerName;
                    completedDeliveriesSet.add(compositeKey);

                    closeModal();
                    loadDeliveryData();
                })
                .catch(error => alert('Có lỗi xảy ra khi cập nhật dữ liệu: ' + error.message));
        }
        
        // Cập nhật đóng hàng
        function updatePacking() {
            const key = document.getElementById('editPackingKey').value;
            const orderId = document.getElementById('editPackingOrderId').value.toUpperCase();
            const customerName = document.getElementById('editPackingCustomerName').value;
            const address = document.getElementById('editPackingAddress').value;
            const packingDate = document.getElementById('editPackingDate').value;
            const isDelivered = document.getElementById('editPackingStatus').value === 'true';
            const notes = document.getElementById('editPackingNotes').value; // BỔ SUNG: Lấy ghi chú từ modal
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const updatedData = {
                orderId, customerName, address, packingDate, isDelivered,
                notes: notes || '', // BỔ SUNG: Update ghi chú
                timestamp: new Date().toISOString()
            };
            
            database.ref('packings/' + key).update(updatedData)
                .then(() => {
                    alert('Đã cập nhật thông tin đóng hàng thành công!');
                    closePackingModal();
                    loadPackingData();
                    loadPendingPackingData(); 

                    if (isDelivered) {
                        const compositeKey = orderId + "||" + customerName;
                        completedDeliveriesSet.add(compositeKey);
                    }
                })
                .catch(error => alert('Có lỗi xảy ra khi cập nhật dữ liệu: ' + error.message));
        }
        
        // Xác nhận xóa & Xóa
        function confirmDeleteDelivery(key) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) deleteDelivery(key);
        }

        function deleteDelivery(key) {
            database.ref('deliveries/' + key).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const delivery = snapshot.val();
                    const compositeKey = delivery.orderId + "||" + delivery.customerName;
                    completedDeliveriesSet.delete(compositeKey);
                }
            }).then(() => {
                database.ref('deliveries/' + key).remove()
                    .then(() => { 
                        alert('Đã xóa đơn hàng thành công!'); 
                        closeModal(); 
                        loadDeliveryData(); 
                    })
                    .catch(error => alert('Có lỗi xảy ra khi xóa dữ liệu: ' + error.message));
            });
        }

        function confirmDeletePacking(key) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) deletePacking(key);
        }
        function deletePacking(key) {
            database.ref('packings/' + key).remove()
                .then(() => { 
                    alert('Đã xóa đơn hàng thành công!'); 
                    closePackingModal(); 
                    loadPackingData(); 
                    loadPendingPackingData(); 
                })
                .catch(error => alert('Có lỗi xảy ra khi xóa dữ liệu: ' + error.message));
        }
        
        // Modal controls
        function closeModal() { 
            document.getElementById('editModal').style.display = 'none'; 
            document.getElementById('editDelivererName_sig_data').value = '';
            document.getElementById('editDelivererName_sig_preview').src = '';
            document.getElementById('editDelivererName_sig_preview').style.display = 'none';
        }
        function closePackingModal() { document.getElementById('editPackingModal').style.display = 'none'; }
        function showTransferConfirmModal(callback) {
            const modal = document.getElementById('transferConfirmModal');
            modal.style.display = 'block';
            document.getElementById('confirmTransferBtn').onclick = () => { modal.style.display = 'none'; callback(); };
        }
        function closeTransferConfirmModal() { document.getElementById('transferConfirmModal').style.display = 'none'; }
        function showHelpModal() { document.getElementById('helpModal').style.display = 'block'; }
        function closeHelpModal() { document.getElementById('helpModal').style.display = 'none'; }
        
        function showAddDelivererModal() { document.getElementById('addDelivererModal').style.display = 'block'; }
        function closeAddDelivererModal() { document.getElementById('addDelivererModal').style.display = 'none'; }
        
        // Các hàm cho Modal Chữ ký
        function showSignatureModal(targetInputId) {
            currentSignatureTarget = targetInputId;
            const modal = document.getElementById('signatureModal');
            modal.style.display = 'block';

            const canvas = document.getElementById('signaturePad');
            
            function resizeCanvas() {
                const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }
            
            setTimeout(() => {
                if (!signaturePad) {
                    signaturePad = new SignaturePad(canvas, {
                        backgroundColor: 'rgb(255, 255, 255)' 
                    });
                }
                resizeCanvas();
                signaturePad.clear();
                
                const dataInput = document.getElementById(currentSignatureTarget + '_sig_data');
                if (dataInput && dataInput.value) {
                    signaturePad.fromDataURL(dataInput.value);
                }
                
                document.getElementById('saveSignatureBtn').onclick = saveSignature;
            }, 100); 

            window.addEventListener("resize", resizeCanvas);
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
            if(signaturePad) signaturePad.clear();
            window.removeEventListener("resize", () => signaturePad.resizeCanvas());
        }

        function clearSignature() {
            if(signaturePad) signaturePad.clear();
        }

        function saveSignature() {
            if (signaturePad.isEmpty()) {
                alert('Vui lòng ký tên trước khi lưu.');
                return;
            }

            const dataURL = signaturePad.toDataURL('image/png'); 
            const dataInput = document.getElementById(currentSignatureTarget + '_sig_data');
            if (dataInput) dataInput.value = dataURL;
            
            const previewImg = document.getElementById(currentSignatureTarget + '_sig_preview');
            if (previewImg) {
                previewImg.src = dataURL;
                previewImg.style.display = 'block';
            }
            
            closeSignatureModal();
        }

        // Save new deliverer
        function saveDeliverer() {
            const newNameInput = document.getElementById('newDelivererName');
            const newName = newNameInput.value.trim();

            if (!newName) {
                alert('Vui lòng nhập tên người giao!');
                return;
            }

            const isDuplicate = delivererData.some(d => d.name.toLowerCase() === newName.toLowerCase());
            if (isDuplicate) {
                alert('Tên người giao đã tồn tại!');
                return;
            }

            const deliverer = { name: newName, timestamp: new Date().toISOString() };
            database.ref('deliverers').push(deliverer)
                .then(() => {
                    alert('Đã thêm người giao mới thành công!');
                    newNameInput.value = '';
                    closeAddDelivererModal();
                    loadDelivererData();
                })
                .catch(error => alert('Lỗi khi lưu: ' + error.message));
        }

        // Xem địa chỉ trên bản đồ
        function viewOnMap(addressFieldId) {
            const address = document.getElementById(addressFieldId).value;
            if (!address) { alert('Vui lòng nhập địa chỉ trước!'); return; }
            window.open(`https://www.google.com/maps?q=${encodeURIComponent(address)}`, '_blank');
        }
        
        // Báo cáo Giao hàng
        function generateDeliveryReport() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('deliveryFromDate').value;
            const toDate = document.getElementById('deliveryToDate').value;
            let startDate, endDate;

            if (fromDate && toDate) {
                startDate = new Date(fromDate);
                endDate = new Date(toDate);
            } else {
                const now = new Date();
                switch (reportType) {
                    case 'daily': startDate = new Date(document.getElementById('reportDate').value); endDate = new Date(startDate); break;
                    case 'weekly': const weekVal = document.getElementById('reportWeek').value; startDate = new Date(weekVal); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); break;
                    case 'monthly': const monthVal = document.getElementById('reportMonth').value; startDate = new Date(monthVal); endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0); break;
                }
            }
             endDate.setHours(23, 59, 59, 999);

            document.getElementById('reportSpinner').style.display = 'block';
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const reportTableBody = document.getElementById('reportTableBody');
                    reportTableBody.innerHTML = '';
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        const deliveryDate = new Date(delivery.deliveryDate);
                        if (deliveryDate >= startDate && deliveryDate <= endDate) {
                            count++;
                            const signatureImg = delivery.delivererSignature 
                                ? `<img src="${delivery.delivererSignature}" alt="Chữ ký" style="max-height: 40px; border: 1px solid #eee; background: white;">` 
                                : 'Không có';
                            
                            const row = reportTableBody.insertRow();
                            row.innerHTML = `
                                <td>${count}</td>
                                <td>${delivery.orderId}</td>
                                <td>${delivery.deliveryDate}</td>
                                <td>${delivery.delivererName}</td>
                                <td>${signatureImg}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td>${delivery.deliveryNotes || ''}</td>
                                <td><button class="btn btn-sm btn-danger" onclick="confirmDeleteDelivery('${childSnapshot.key}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
                        }
                    });
                    if (count === 0) reportTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Không có dữ liệu</td></tr>';
                    document.getElementById('reportSpinner').style.display = 'none';
                })
                .catch(error => { console.error('Lỗi khi tạo báo cáo:', error); document.getElementById('reportSpinner').style.display = 'none'; });
        }
        
       // Báo cáo Đóng hàng (ĐÃ SỬA LỖI TRIỆT ĐỂ)
async function generatePackingReport() {
    const reportType = document.getElementById('packingReportType').value;
    const fromDate = document.getElementById('packingFromDate').value;
    const toDate = document.getElementById('packingToDate').value;
    let startDate, endDate;

    if (fromDate && toDate) {
        startDate = new Date(fromDate);
        endDate = new Date(toDate);
    } else {
        const now = new Date();
        switch (reportType) {
            case 'daily': 
                startDate = new Date(document.getElementById('packingReportDate').value); 
                endDate = new Date(startDate); 
                break;
            case 'weekly': 
                const weekVal = document.getElementById('packingReportWeek').value; 
                startDate = new Date(weekVal); 
                endDate = new Date(startDate); 
                endDate.setDate(startDate.getDate() + 6); 
                break;
            case 'monthly': 
                const monthVal = document.getElementById('packingReportMonth').value; 
                startDate = new Date(monthVal); 
                endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0); 
                break;
        }
    }
    endDate.setHours(23, 59, 59, 999);

    document.getElementById('packingReportSpinner').style.display = 'block';
    
    try {
        // QUAN TRỌNG: Tải và xử lý toàn bộ dữ liệu giao hàng trước
        console.log("Đang tải dữ liệu giao hàng để đối soát...");
        const deliveriesSnapshot = await database.ref('deliveries').once('value');
        const completedDeliveries = new Set();
        
        deliveriesSnapshot.forEach(childSnapshot => {
            const delivery = childSnapshot.val();
            // Tạo key đối soát: Mã đơn + Tên KH (chuẩn hóa)
            const compositeKey = (delivery.orderId + "||" + delivery.customerName).toLowerCase().trim();
            completedDeliveries.add(compositeKey);
            console.log(`Đã giao: ${delivery.orderId} - ${delivery.customerName}`);
        });
        
        console.log(`Tổng số đơn đã giao: ${completedDeliveries.size}`);

        // Tải dữ liệu đóng hàng
        console.log("Đang tải dữ liệu đóng hàng...");
        const packingsSnapshot = await database.ref('packings').orderByChild('timestamp').once('value');
        const reportTableBody = document.getElementById('packingReportTableBody');
        reportTableBody.innerHTML = '';
        let count = 0;
        let fixedCount = 0;
        
        packingsSnapshot.forEach(childSnapshot => {
            const packing = childSnapshot.val();
            const packingKey = childSnapshot.key;
            const packingDate = new Date(packing.packingDate);
            
            if (packingDate >= startDate && packingDate <= endDate) {
                count++;
                
                // ĐỐI SOÁT CHÉO: Kiểm tra xem đơn này đã được giao chưa
                const compositeKey = (packing.orderId + "||" + packing.customerName).toLowerCase().trim();
                const isActuallyDelivered = completedDeliveries.has(compositeKey);

                console.log(`Kiểm tra: ${packing.orderId} - ${packing.customerName} -> ${isActuallyDelivered ? 'ĐÃ GIAO' : 'CHỜ GIAO'}`);

                let statusClass, statusText;

                if (isActuallyDelivered) {
                    statusClass = 'packed';
                    statusText = 'Đã kết thúc';
                    
                    // TỰ ĐỘNG SỬA TRẠNG THÁI NẾU CHƯA ĐÚNG
                    if (!packing.isDelivered) {
                        console.log(`🚨 Tự động sửa trạng thái cho đơn: ${packing.orderId}`);
                        database.ref('packings/' + packingKey).update({ isDelivered: true });
                        fixedCount++;
                    }
                } else {
                    statusClass = 'not-packed';
                    statusText = 'Chờ giao';
                    
                    // ĐẢM BẢO TRẠNG THÁI ĐÚNG NẾU CHƯA GIAO
                    if (packing.isDelivered) {
                        console.log(`🚨 Tự động sửa trạng thái chờ giao cho đơn: ${packing.orderId}`);
                        database.ref('packings/' + packingKey).update({ isDelivered: false });
                        fixedCount++;
                    }
                }
                
                const row = reportTableBody.insertRow();
                // BỔ SUNG: Thêm cột Ghi chú vào bảng báo cáo
                row.innerHTML = `
                    <td>${count}</td>
                    <td>${packing.orderId}</td>
                    <td>${packing.packingDate}</td>
                    <td>${packing.customerName}</td>
                    <td>${packing.address}</td>
                    <td><span class="packing-status ${statusClass}">${statusText}</span></td>
                    <td>${packing.notes || ''}</td> 
                    <td><button class="btn btn-sm btn-danger" onclick="confirmDeletePacking('${packingKey}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
            }
        });
        
        if (count === 0) {
            reportTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu</td></tr>';
        }
        
        console.log(`Đã xử lý ${count} đơn đóng hàng, sửa ${fixedCount} trạng thái`);
        if (fixedCount > 0) {
            alert(`Đã tự động sửa ${fixedCount} trạng thái không khớp!`);
        }
    
    } catch (error) {
        console.error('Lỗi khi tạo báo cáo:', error);
        alert('Có lỗi xảy ra khi tạo báo cáo: ' + error.message);
    } finally {
        document.getElementById('packingReportSpinner').style.display = 'none';
    }
}
      // Hàm đồng bộ lại toàn bộ dữ liệu (dùng khi cần fix lỗi)
async function syncAllPackingStatus() {
    if (!confirm('Bạn có chắc muốn đồng bộ lại toàn bộ trạng thái đóng hàng với dữ liệu giao hàng?')) {
        return;
    }
    
    try {
        // Tải toàn bộ dữ liệu giao hàng
        const deliveriesSnapshot = await database.ref('deliveries').once('value');
        const completedDeliveries = new Set();
        
        deliveriesSnapshot.forEach(childSnapshot => {
            const delivery = childSnapshot.val();
            const compositeKey = (delivery.orderId + "||" + delivery.customerName).toLowerCase().trim();
            completedDeliveries.add(compositeKey);
        });

        // Tải toàn bộ dữ liệu đóng hàng
        const packingsSnapshot = await database.ref('packings').once('value');
        let updatedCount = 0;
        
        packingsSnapshot.forEach(childSnapshot => {
            const packing = childSnapshot.val();
            const packingKey = childSnapshot.key;
            
            // Kiểm tra trạng thái thực tế
            const compositeKey = (packing.orderId + "||" + packing.customerName).toLowerCase().trim();
            const isActuallyDelivered = completedDeliveries.has(compositeKey);
            
            // Cập nhật nếu không khớp
            if (packing.isDelivered !== isActuallyDelivered) {
                database.ref('packings/' + packingKey).update({ isDelivered: isActuallyDelivered });
                updatedCount++;
                console.log(`Đã sửa: ${packing.orderId} -> ${isActuallyDelivered ? 'Đã giao' : 'Chờ giao'}`);
            }
        });
        
        alert(`Đã đồng bộ ${updatedCount} đơn hàng!`);
        loadPackingData(); // Reload để hiển thị đúng
        
    } catch (error) {
        console.error('Lỗi khi đồng bộ:', error);
        alert('Có lỗi khi đồng bộ: ' + error.message);
    }
}
        
        // Xóa báo cáo
        function clearDeliveryReport() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu giao hàng?')) {
                database.ref('deliveries').remove().then(() => { 
                    alert('Đã xóa tất cả dữ liệu giao hàng!'); 
                    loadDeliveryData(); 
                    document.getElementById('reportTableBody').innerHTML = '';
                    completedDeliveriesSet.clear(); 
                });
            }
        }
        function clearPackingReport() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu đóng hàng?')) {
                database.ref('packings').remove().then(() => { 
                    alert('Đã xóa tất cả dữ liệu đóng hàng!'); 
                    loadPackingData(); 
                    document.getElementById('packingReportTableBody').innerHTML = ''; 
                    loadPendingPackingData(); 
                });
            }
        }
        
        // Xuất Excel
        function exportDeliveryToExcel() {
            const table = document.getElementById('reportTable');
            if (table.rows.length <= 1) { alert('Không có dữ liệu để xuất!'); return; }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.sheet_add_aoa(ws, [[""]], {origin: "E1"}); 
            for (let i = 1; i < table.rows.length; i++) {
                 XLSX.utils.sheet_add_aoa(ws, [["(Chữ ký - xem trên web)"]], {origin: `E${i+1}`});
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'Báo cáo giao hàng');
            XLSX.writeFile(wb, 'bao_cao_giao_hang.xlsx');
        }
        function exportPackingToExcel() {
            const table = document.getElementById('packingReportTable');
            if (table.rows.length <= 1) { alert('Không có dữ liệu để xuất!'); return; }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Báo cáo đóng hàng');
            XLSX.writeFile(wb, 'bao_cao_dong_hang.xlsx');
        }
        
        // Tìm kiếm đơn hàng
        function searchOrders() {
            const searchTerm = document.getElementById('searchOrder').value.toLowerCase();
            const managementTableBody = document.getElementById('managementTableBody');
            managementTableBody.innerHTML = '';
            
            database.ref('deliveries').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    let found = false;
                    snapshot.forEach(childSnapshot => {
                        const delivery = childSnapshot.val();
                        if (delivery.orderId.toLowerCase().includes(searchTerm) || delivery.customerName.toLowerCase().includes(searchTerm)) {
                            found = true;
                            const row = managementTableBody.insertRow();
                            row.innerHTML = `<td>${delivery.orderId}</td><td>${delivery.deliveryDate}</td><td>${delivery.delivererName}</td><td>${delivery.customerName}</td><td>${delivery.deliveryAddress}</td><td class="action-btns"><button class="btn btn-sm btn-warning" onclick="editDelivery('${childSnapshot.key}')"><i class="fas fa-edit"></i> Sửa</button><button class="btn btn-sm btn-danger" onclick="confirmDeleteDelivery('${childSnapshot.key}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
                        }
                    });
                    if (!found) managementTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Không tìm thấy đơn hàng</td></tr>';
                });
        }
        
        function toggleReportInputs(reportType, prefix) {
            document.getElementById(`${prefix}Date`).style.display = reportType === 'daily' ? 'block' : 'none';
            document.getElementById(`${prefix}Week`).style.display = reportType === 'weekly' ? 'block' : 'none';
            document.getElementById(`${prefix}Month`).style.display = reportType === 'monthly' ? 'block' : 'none';
        }
        
        // Dữ liệu khách hàng
        function loadCustomerData() {
            database.ref('customers').once('value')
                .then(snapshot => {
                    customerData = [];
                    const customerTableBody = document.getElementById('customerTableBody');
                    customerTableBody.innerHTML = '';
                    let count = 0;
                    snapshot.forEach(childSnapshot => {
                        const customer = childSnapshot.val();
                        customerData.push(customer);
                        count++;
                        const row = customerTableBody.insertRow();
                        row.innerHTML = `<td>${count}</td><td>${customer.name}</td><td>${customer.address}</td><td><button class="btn btn-sm btn-danger" onclick="deleteCustomer('${childSnapshot.key}')"><i class="fas fa-trash"></i> Xóa</button></td>`;
                    });
                     if (count === 0) customerTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Chưa có dữ liệu khách hàng</td></tr>';
                });
        }
        
        function deleteCustomer(key) {
            if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                database.ref('customers/' + key).remove().then(() => { alert('Đã xóa khách hàng thành công!'); loadCustomerData(); });
            }
        }
        
        function uploadExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) { alert('Vui lòng chọn file Excel!'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length === 0) { alert('File Excel không có dữ liệu!'); return; }

                let nameKey, addressKey;
                for (let key in jsonData[0]) {
                    if (key.toLowerCase().includes('tên') || key.toLowerCase().includes('name')) nameKey = key;
                    if (key.toLowerCase().includes('địa chỉ') || key.toLowerCase().includes('address')) addressKey = key;
                }
                if (!nameKey || !addressKey) { alert('Không tìm thấy cột Tên và Địa chỉ trong file Excel!'); return; }
                
                let successCount = 0;
                jsonData.forEach((row, index) => {
                    if (row[nameKey] && row[addressKey]) {
                        database.ref('customers').push({ name: row[nameKey], address: row[addressKey], timestamp: new Date().toISOString() })
                            .then(() => successCount++)
                            .finally(() => {
                                if (index === jsonData.length - 1) {
                                    alert(`Đã tải lên ${successCount} khách hàng.`);
                                    loadCustomerData();
                                }
                            });
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Autocomplete
        function initCustomerAutocomplete() {
            const inputs = [
                document.getElementById('packingCustomerName'),
                document.getElementById('editPackingCustomerName')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        const val = this.value;
                        closeAllLists();
                        if (!val) return false;

                        const list = document.createElement('div');
                        list.setAttribute('id', this.id + '-autocomplete-list');
                        list.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(list);
                        
                        customerData
                            .filter(c => c.name.toLowerCase().includes(val.toLowerCase()))
                            .forEach(customer => {
                                const item = document.createElement('div');
                                item.innerHTML = `<strong>${customer.name}</strong> - ${customer.address}<input type='hidden' value='${customer.name}'>`;
                                item.addEventListener('click', function() {
                                    input.value = this.getElementsByTagName('input')[0].value;
                                    const customerInfo = customerData.find(c => c.name === input.value);
                                    if(customerInfo) {
                                        let addressField = document.getElementById(input.id.replace('CustomerName', 'Address'));
                                        if(addressField) addressField.value = customerInfo.address;
                                    }
                                    closeAllLists();
                                });
                                list.appendChild(item);
                            });
                    });
                }
            });
        }

        function initPendingPackingAutocomplete() {
            const inputs = [
                document.getElementById('customerName'),
                document.getElementById('editCustomerName')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.addEventListener('click', function() { this.dispatchEvent(new Event('input')); });

                    input.addEventListener('input', function() {
                        const val = this.value;
                        closeAllLists();
                        
                        const list = document.createElement('div');
                        list.setAttribute('id', this.id + '-autocomplete-list');
                        list.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(list);
                        
                        const filteredData = pendingPackingData
                            .filter(p => p.customerName.toLowerCase().includes(val.toLowerCase()));

                        if(filteredData.length === 0 && val) {
                            const item = document.createElement('div');
                            item.innerHTML = 'Không tìm thấy đơn hàng "Chờ giao"';
                            list.appendChild(item);
                        }
                        
                        filteredData.forEach(packing => {
                                const item = document.createElement('div');
                                item.innerHTML = `<strong>${packing.customerName}</strong> (Đơn: ${packing.orderId})<br><small>${packing.address}</small>`;
                                
                                item.addEventListener('click', function() {
                                    const isEdit = input.id.includes('edit');
                                    const orderIdEl = isEdit ? 'editOrderId' : 'orderId';
                                    const addressEl = isEdit ? 'editDeliveryAddress' : 'deliveryAddress';

                                    input.value = packing.customerName;
                                    document.getElementById(orderIdEl).value = packing.orderId;
                                    document.getElementById(addressEl).value = packing.address;
                                    
                                    closeAllLists();
                                });
                                list.appendChild(item);
                            });
                    });
                }
            });
        }

        function initDelivererAutocomplete() {
            const inputs = [
                document.getElementById('delivererName'),
                document.getElementById('editDelivererName')
            ];

            inputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        const val = this.value;
                        closeAllLists();
                        if (!val) return false;

                        const list = document.createElement('div');
                        list.setAttribute('id', this.id + '-autocomplete-list');
                        list.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(list);

                        delivererData
                            .filter(d => d.name.toLowerCase().includes(val.toLowerCase()))
                            .forEach(deliverer => {
                                const item = document.createElement('div');
                                item.innerHTML = `<strong>${deliverer.name}</strong><input type='hidden' value='${deliverer.name}'>`;
                                item.addEventListener('click', function() {
                                    input.value = this.getElementsByTagName('input')[0].value;
                                    closeAllLists();

                                });
                                list.appendChild(item);
                            });
                    });
                }
            });
        }
        
        function closeAllLists(elmnt) {
            const items = document.getElementsByClassName('autocomplete-items');
            for (let i = 0; i < items.length; i++) {
                if (elmnt !== items[i] && elmnt !== items[i].parentNode.getElementsByTagName('input')[0]) {
                    items[i].parentNode.removeChild(items[i]);
                }
            }
        }
        document.addEventListener('click', (e) => closeAllLists(e.target));
        
        autoUppercaseOrderId();
    </script>
</body>
</html>
