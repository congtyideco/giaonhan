<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê√≥ng h√†ng & Giao h√†ng - KPI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        
        h1, h2, h3 {
            margin: 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .section-divider {
            margin: 20px 0;
            border-top: 1px solid #ddd;
        }
        
        /* Tr·∫°ng th√°i ƒë√≥ng g√≥i */
        .packing-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .packed {
            background-color: var(--success-color);
            color: white;
        }
        
        .not-packed {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* ƒê·ªãa ch·ªâ v·ªõi n√∫t b·∫£n ƒë·ªì */
        .address-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .address-group input {
            flex: 1;
        }
        
        .map-btn {
            padding: 10px 12px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-btn:hover {
            background-color: #2d8e47;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .address-group {
                flex-direction: column;
                gap: 5px;
            }
            
            .map-btn {
                width: 100%;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Help button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        /* Help content */
        .help-content {
            line-height: 1.8;
        }
        
        .help-content h3 {
            margin-top: 15px;
            color: var(--primary-color);
        }
        
        .help-content ul {
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>Qu·∫£n l√Ω ƒê√≥ng h√†ng & Giao h√†ng - KPI kho v·∫≠n (IDECO)</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="packing">ƒê√≥ng h√†ng</div>
            <div class="tab" data-tab="delivery">Giao h√†ng</div>
            <div class="tab" data-tab="reports">B√°o c√°o</div>
            <div class="tab" data-tab="management">Qu·∫£n l√Ω</div>
        </div>
        
        <!-- Tab ƒê√≥ng h√†ng -->
        <div class="tab-content active" id="packing-tab">
            <div class="card">
                <h2>Nh·∫≠p th√¥ng tin ƒë√≥ng h√†ng</h2>
                <div class="form-group">
                    <label for="packingOrderId">M√£ ƒë∆°n h√†ng:</label>
                    <input type="text" id="packingOrderId" required>
                </div>
                <div class="form-group">
                    <label for="packingCustomerName">T√™n kh√°ch h√†ng:</label>
                    <input type="text" id="packingCustomerName" required>
                </div>
                <div class="form-group">
                    <label for="packingAddress">ƒê·ªãa ch·ªâ giao:</label>
                    <div class="address-group">
                        <input type="text" id="packingAddress" required>
                        <button class="map-btn" onclick="viewOnMap('packingAddress')" title="Xem tr√™n b·∫£n ƒë·ªì">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="packingDate">Ng√†y ƒë√≥ng h√†ng:</label>
                    <input type="date" id="packingDate" required>
                </div>
                <button class="btn btn-primary" onclick="savePacking()">
                    <i class="fas fa-box"></i> X√°c nh·∫≠n ƒë∆°n ƒë√£ ƒë√≥ng h√†ng xong
                </button>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>H√¥m nay</h3>
                    <div class="stat-value" id="todayPackedCount">0</div>
                    <p>ƒë∆°n ƒë√£ ƒë√≥ng h√†ng</p>
                </div>
                <div class="stat-card">
                    <h3>Ch·ªù giao</h3>
                    <div class="stat-value" id="waitingDeliveryCount">0</div>
                    <p>ƒë∆°n s·∫µn s√†ng giao</p>
                </div>
                <div class="stat-card">
                    <h3>ƒê√£ giao</h3>
                    <div class="stat-value" id="deliveredCount">0</div>
                    <p>ƒë∆°n ƒë√£ giao</p>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="card">
                <h2>Danh s√°ch ƒë∆°n h√†ng ƒë√£ ƒë√≥ng h√¥m nay</h2>
                <table id="packingTable">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>Tr·∫°ng th√°i giao</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="packingTableBody">
                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Giao h√†ng -->
        <div class="tab-content" id="delivery-tab">
            <div class="card">
                <h2>Nh·∫≠p th√¥ng tin giao h√†ng</h2>
                <div class="form-group">
                    <label for="orderId">M√£ ƒë∆°n h√†ng:</label>
                    <input type="text" id="orderId" required>
                </div>
                <div class="form-group">
                    <label for="deliveryDate">Ng√†y giao h√†ng:</label>
                    <input type="date" id="deliveryDate" required>
                </div>
                <div class="form-group">
                    <label for="delivererName">T√™n ng∆∞·ªùi giao:</label>
                    <input type="text" id="delivererName" placeholder="V√≠ d·ª•: Anh A, Ch·ªã B" required>
                </div>
                <div class="form-group">
                    <label for="customerName">T√™n kh√°ch h√†ng:</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="deliveryAddress">ƒê·ªãa ch·ªâ giao:</label>
                    <div class="address-group">
                        <input type="text" id="deliveryAddress" required>
                        <button class="map-btn" onclick="viewOnMap('deliveryAddress')" title="Xem tr√™n b·∫£n ƒë·ªì">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveDelivery()">
                    <i class="fas fa-save"></i> Giao xong - hay ph·∫£i giao m·ªõi b·∫•m l∆∞u d·ªØ li·ªáu
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>H√¥m nay</h3>
                    <div class="stat-value" id="todayCount">0</div>
                    <p>ƒë∆°n h√†ng ƒë√£ giao</p>
                </div>
                <div class="stat-card">
                    <h3>Tu·∫ßn n√†y</h3>
                    <div class="stat-value" id="weeklyCount">0</div>
                    <p>ƒë∆°n h√†ng ƒë√£ giao</p>
                </div>
                <div class="stat-card">
                    <h3>Th√°ng n√†y</h3>
                    <div class="stat-value" id="monthlyCount">0</div>
                    <p>ƒë∆°n h√†ng ƒë√£ giao</p>
                </div>
            </div>
            
            <div class="card">
                <h2>Danh s√°ch giao h√†ng h√¥m nay</h2>
                <table id="deliveryTable">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Ng∆∞·ªùi giao</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryTableBody">
                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab B√°o c√°o -->
        <div class="tab-content" id="reports-tab">
            <div class="card">
                <h2>B√°o c√°o giao h√†ng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Lo·∫°i b√°o c√°o</label>
                        <select id="reportType" class="form-control">
                            <option value="daily">Theo ng√†y</option>
                            <option value="weekly">Theo tu·∫ßn</option>
                            <option value="monthly">Theo th√°ng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Ch·ªçn ng√†y / tu·∫ßn / th√°ng</label>
                        <input type="date" id="reportDate" class="form-control">
                        <input type="week" id="reportWeek" class="form-control" style="display: none;">
                        <input type="month" id="reportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>T·ª´ ng√†y</label>
                        <input type="date" id="deliveryFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>ƒê·∫øn ng√†y</label>
                        <input type="date" id="deliveryToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generateDeliveryReport()">
                            <i class="fas fa-search"></i> T·∫°o b√°o c√°o
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportDeliveryToExcel()">
                            <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearDeliveryReport()">
                            <i class="fas fa-trash"></i> X√≥a b√°o c√°o
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="reportSpinner"></div>
                
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√£ ƒë∆°n</th>
                            <th>Ng√†y giao</th>
                            <th>Ng∆∞·ªùi giao</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                       <th>X√≥a</th> <th>X√≥a</th></tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- D·ªØ li·ªáu b√°o c√°o s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                    </tbody>
                </table>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h2>B√°o c√°o ƒë√≥ng h√†ng</h2>
                
                <div class="report-controls">
                    <div style="min-width:180px;">
                        <label>Lo·∫°i b√°o c√°o</label>
                        <select id="packingReportType" class="form-control">
                            <option value="daily">Theo ng√†y</option>
                            <option value="weekly">Theo tu·∫ßn</option>
                            <option value="monthly">Theo th√°ng</option>
                        </select>
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>Ch·ªçn ng√†y / tu·∫ßn / th√°ng</label>
                        <input type="date" id="packingReportDate" class="form-control">
                        <input type="week" id="packingReportWeek" class="form-control" style="display: none;">
                        <input type="month" id="packingReportMonth" class="form-control" style="display: none;">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>T·ª´ ng√†y</label>
                        <input type="date" id="packingFromDate" class="form-control">
                    </div>
                    
                    <div style="min-width:180px;">
                        <label>ƒê·∫øn ng√†y</label>
                        <input type="date" id="packingToDate" class="form-control">
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="generatePackingReport()">
                            <i class="fas fa-search"></i> T·∫°o b√°o c√°o
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportPackingToExcel()">
                            <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearPackingReport()">
                            <i class="fas fa-trash"></i> X√≥a b√°o c√°o
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="packingReportSpinner"></div>
                
                <table id="packingReportTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√£ ƒë∆°n</th>
                            <th>Ng√†y ƒë√≥ng</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>Tr·∫°ng th√°i giao</th>
                        </tr>
                    </thead>
                    <tbody id="packingReportTableBody">
                        <!-- D·ªØ li·ªáu b√°o c√°o s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Qu·∫£n l√Ω -->
        

<!-- ===== (IDECO) L·ªãch s·ª≠ x√≥a b√°o c√°o ===== -->
<section id="auditLogsSection" style="margin:16px 0; padding:12px; border:1px solid #e5e7eb; border-radius:12px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
    <h2 style="margin:0;">üìí L·ªãch s·ª≠ x√≥a b√°o c√°o</h2>
    <div style="display:flex; gap:8px;">
      <button id="refreshAuditLogsBtn">T·∫£i l·∫°i</button><button id="deleteSelectedAuditBtn" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px;">X√≥a ƒë√£ ch·ªçn</button>
      <label style="display:flex; align-items:center; gap:6px; font-size:14px;">
        Hi·ªÉn th·ªã t·ªëi ƒëa:
        <input type="number" id="auditLimitInput" value="200" min="10" max="1000" step="10" style="width:90px;">
      </label>
    </div>
  </div>
  <div style="overflow:auto; margin-top:10px;">
    <table style="width:100%; border-collapse: collapse;">
      <thead>
        <tr style="background:#f3f4f6;">
          <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb; width:48px;"><input type="checkbox" id="auditSelectAll"></th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Th·ªùi gian</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Lo·∫°i b√°o c√°o</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">T√™n ng∆∞·ªùi x√≥a</th>
        </tr>
      </thead>
      <tbody id="auditLogsTableBody">
        <tr><td colspan="3" style="padding:10px; color:#6b7280;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>
  </div>
</section>
<div class="tab-content" id="management-tab">
            <div class="card">
                <h2>Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>
                
                <div class="form-group">
                    <label for="searchOrder">T√¨m ki·∫øm ƒë∆°n h√†ng:</label>
                    <div style="display: flex;">
                        <input type="text" id="searchOrder" placeholder="Nh·∫≠p m√£ ƒë∆°n ho·∫∑c t√™n KH">
                        <button class="btn btn-primary" onclick="searchOrders()" style="margin-left: 10px;">
                            <i class="fas fa-search"></i> T√¨m
                        </button>
                    </div>
                </div>
                
                <table id="managementTable">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Ng√†y giao</th>
                            <th>Ng∆∞·ªùi giao</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="managementTableBody">
                        <!-- D·ªØ li·ªáu qu·∫£n l√Ω s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal ch·ªânh s·ª≠a giao h√†ng -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Ch·ªânh s·ª≠a ƒë∆°n h√†ng</h2>
            <input type="hidden" id="editKey">
            <div class="form-group">
                <label for="editOrderId">M√£ ƒë∆°n h√†ng:</label>
                <input type="text" id="editOrderId" required>
            </div>
            <div class="form-group">
                <label for="editDeliveryDate">Ng√†y giao h√†ng:</label>
                <input type="date" id="editDeliveryDate" required>
            </div>
            <div class="form-group">
                <label for="editDelivererName">T√™n ng∆∞·ªùi giao:</label>
                <input type="text" id="editDelivererName" required>
            </div>
            <div class="form-group">
                <label for="editCustomerName">T√™n kh√°ch h√†ng:</label>
                <input type="text" id="editCustomerName" required>
            </div>
            <div class="form-group">
                <label for="editDeliveryAddress">ƒê·ªãa ch·ªâ giao:</label>
                <div class="address-group">
                    <input type="text" id="editDeliveryAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editDeliveryAddress')" title="Xem tr√™n b·∫£n ƒë·ªì">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="updateDelivery()">
                <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
            </button>
            <button class="btn btn-danger" onclick="confirmDeleteDelivery(currentEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> X√≥a
            </button>
        </div>
    </div>
    
    <!-- Modal ch·ªânh s·ª≠a ƒë√≥ng h√†ng -->
    <div id="editPackingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePackingModal()">&times;</span>
            <h2>Ch·ªânh s·ª≠a ƒë∆°n ƒë√≥ng h√†ng</h2>
            <input type="hidden" id="editPackingKey">
            <div class="form-group">
                <label for="editPackingOrderId">M√£ ƒë∆°n h√†ng:</label>
                <input type="text" id="editPackingOrderId" required>
            </div>
            <div class="form-group">
                <label for="editPackingCustomerName">T√™n kh√°ch h√†ng:</label>
                <input type="text" id="editPackingCustomerName" required>
            </div>
            <div class="form-group">
                <label for="editPackingAddress">ƒê·ªãa ch·ªâ giao:</label>
                <div class="address-group">
                    <input type="text" id="editPackingAddress" required>
                    <button class="map-btn" onclick="viewOnMap('editPackingAddress')" title="Xem tr√™n b·∫£n ƒë·ªì">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="editPackingDate">Ng√†y ƒë√≥ng h√†ng:</label>
                <input type="date" id="editPackingDate" required>
            </div>
            <div class="form-group">
                <label for="editPackingStatus">Tr·∫°ng th√°i giao h√†ng:</label>
                <select id="editPackingStatus" class="form-control">
                    <option value="false">Ch·ªù giao</option>
                    <option value="true">ƒê√£ giao</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="updatePacking()">
                <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
            </button>
            <button class="btn btn-danger" onclick="confirmDeletePacking(currentPackingEditKey)" style="margin-left: 10px;">
                <i class="fas fa-trash"></i> X√≥a
            </button>
        </div>
    </div>
    
    <!-- Modal nh·∫Øc nh·ªü chuy·ªÉn giao h√†ng -->
    <div id="transferConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeTransferConfirmModal()">&times;</span>
             <h2>EM N√äN ƒê·ªåC N·ªòI DUNG SAU C·∫®N TH·∫¨N !</h2>
            <p style="margin-top:10px; white-space: pre-line;">
Em ƒë√£ s·∫µn s√†ng mang ƒëi giao h√†ng hay ƒë∆°n v·ªã giao ƒë·∫øn nh·∫≠n ngay ch∆∞a ? ki·ªÉm tra l·∫°i l·ªô tr√¨nh ch∆∞a ?b√°o nhi√™u ki·ªán cho ƒë∆°n n√†y?
Khi giao h√†ng ƒë·∫£m b·∫£o th√πng h√†ng c√≥ tem nh√£n ghi ch√≠nh x√°c kh√¥ng? c√≥ h√≥a ƒë∆°n, ƒë∆°n h√†ng k√®m  theo th√πng ch∆∞a? ph·∫£i ƒë·∫£m b·∫£o ƒë·∫ßy d·ªß
N·∫øu ƒë√£ b·∫•m chuy·ªÉn giao h√†ng th√¨ ph·∫£i ho√†n th√†nh giao h√†ng ngay tr√°nh ƒë∆°n h√†ng khai b√°o b·ªã tr√¥i tin, s√≥t ƒë∆°n tr√™n ·ª©ng d·ª•ng
H√†ng giao ph·∫£i xem l·∫°i th√¥ng tin giao, thanh to√°n. D√π b·∫•t c·ª© nh√¢n vi√™n n√†o ƒëang thu l√Ω giao ph·∫£i khai th√¥ng tin giao m·ªõi ƒë∆∞·ª£c giao h√†ng.
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTransferConfirmModal()">H·ªßy</button>
                <button class="btn btn-primary" id="confirmTransferBtn">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>
    
    <!-- Modal h∆∞·ªõng d·∫´n -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHelpModal()">&times;</span>
            <h2>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
            <div class="help-content">
                <h3>1. Ph·∫ßn n√†y do: ƒêi·ªÅu ph·ªëi kho ƒë·∫£m nh·∫≠n khai b√°o - ngo√†i ra Qu·∫£n l√Ω kho v·∫≠n c≈©ng ƒë∆∞·ª£c tham gia </h3>
                <ul>
                    <li>Sau khi m·ªçi ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë√≥ng xong s·∫µn s√†ng giao ra kho th√¨ ph·∫£i khai b√°o ngay tr∆∞·ªõc khi ra kh·ªèi kho</li>
                    <li>M√£ ƒë∆°n h√†ng t·ª´ ƒë∆°n h√†ng ERP in ra v√† nh·∫≠p ƒë√∫ng ch√≠nh x√°c</li>
                    <li>Th√¥ng tin t√™n kh√°ch h√†ng- ƒë·ªãa ch·ªâ giao h√†ng ph·∫£i ƒëi·ªÅn ƒë·ªß hay ch·ªânh l·∫°i ƒë√∫ng sau ƒë√≥</li>
                    <li>Khi ƒë√≥ng h√†ng ƒë∆°n h√†ng n√†y th√¨ x·ª≠ l√Ω xong r·ªìi b·∫•m ƒë√£ xong ƒë√≥ng g√≥i</li>
                    <li>Tr·∫°ng th√°i b√°o: ƒëang ch·ªù m√†u ƒë·ªè t·ª©c l√† t√¨nh tr·∫°nh ƒë∆°n ch∆∞a ƒë∆∞·ª£c giao ƒëang t·∫°m l∆∞u kho</li>
                </ul>
                
                <h3>2. Giao h√†ng -Ph·∫ßn n√†y do ph·ª• tr√°ch ƒëi·ªÅu ph·ªëi v·∫≠n chuy·ªÉn- giao h√†ng hay ng∆∞·ªùi h·ªó tr·ª£ giao h√†ng th·ª±c hi·ªán</h3>
                <ul>
                    <li>Nh·∫≠p: M√£ ƒë∆°n, ng√†y giao, <b>t√™n ng∆∞·ªùi giao</b>, t√™n kh√°ch h√†ng v√† ƒë·ªãa ch·ªâ</li>
                    <li>Nh·∫•n n√∫t b·∫£n ƒë·ªì ƒë·ªÉ ki·ªÉm tra ƒë·ªãa ch·ªâ tr√™n Google Maps</li>
                    <li>Nh·∫•n "L∆∞u th√¥ng tin" ƒë·ªÉ ghi nh·∫≠n ƒë∆°n giao h√†ng</li>
                    <li>Khi chuy·ªÉn t·ª´ tab ƒê√≥ng h√†ng sang, h·ªá th·ªëng s·∫Ω <b>t·ª± ƒëi·ªÅn</b> M√£ ƒë∆°n, T√™n KH, ƒê·ªãa ch·ªâ</li>
                </ul>
                
                <h3>3. B√°o c√°o</h3>
                <ul>
                    <li>Ch·ªçn lo·∫°i b√°o c√°o: Theo ng√†y, tu·∫ßn ho·∫∑c th√°ng</li>
                    <li>HO·∫∂C d√πng b·ªô l·ªçc <b>T·ª´ ng√†y</b> v√† <b>ƒê·∫øn ng√†y</b> ƒë·ªÉ xem d·ªØ li·ªáu trong m·ªôt kho·∫£ng th·ªùi gian b·∫•t k·ª≥</li>
                    <li>Nh·∫•n "T·∫°o b√°o c√°o" ƒë·ªÉ xem d·ªØ li·ªáu, "Xu·∫•t Excel" ƒë·ªÉ t·∫£i</li>
                    <li>C√≥ 2 lo·∫°i b√°o c√°o: B√°o c√°o giao h√†ng v√† b√°o c√°o ƒë√≥ng h√†ng</li>
                </ul>
                
                <h3>4. Qu·∫£n l√Ω</h3>
                <ul>
                    <li>T√¨m ki·∫øm ƒë∆°n h√†ng theo m√£ ƒë∆°n ho·∫∑c t√™n kh√°ch h√†ng</li>
                    <li>C√≥ th·ªÉ ch·ªânh s·ª≠a ho·∫∑c x√≥a ƒë∆°n h√†ng t·ª´ k·∫øt qu·∫£ t√¨m ki·∫øm</li>
                </ul>
                
                <h3>Th·ªëng k√™</h3>
                <ul>
                    <li>H·ªá th·ªëng t·ª± ƒë·ªông c·∫≠p nh·∫≠t c√°c th·ªëng k√™ quan tr·ªçng ·ªü m·ªói tab</li>
                    <li>Th·ªëng k√™ ƒë∆∞·ª£c reset h√†ng ng√†y v√†o l√∫c 00:00</li>
                </ul>
				 <h3>X√≥a b√°o c√°o </h3>
                <ul>
                    <li>Nh·∫≠p t√™n ng∆∞·ªùi xoa - password:ideco@2025</li>
                    <li>H√£y xem x√©t c·∫©n th·∫≠n tr∆∞·ªõc khi x√≥a</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- N√∫t tr·ª£ gi√∫p -->
    <div class="help-btn" onclick="openHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <script>
        // C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEAbXHjh2OP-QaZxVA6p3UFl959CK0fHU",
            authDomain: "giaonhan-3d317.firebaseapp.com",
            projectId: "giaonhan-3d317",
            storageBucket: "giaonhan-3d317.firebasestorage.app",
            messagingSenderId: "148651915634",
            appId: "1:148651915634:web:0bca5d3b22c95caa62c5eb",
            measurementId: "G-GYX91BJ9TJ"
        };
        
        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        







// ==== X√≥a 1 d√≤ng trong B√°o c√°o giao h√†ng ====
function handleDeleteFromReport(btn){
    try{
        const key = btn.getAttribute('data-key') || '';
        const orderId = btn.getAttribute('data-order-id') || '';
        confirmDeleteDeliveryFromReport(key, orderId);
    }catch(e){
        alert("Kh√¥ng th·ªÉ x·ª≠ l√Ω x√≥a: " + e.message);
    }
}

function confirmDeleteDeliveryFromReport(key, orderId){
    function proceed(realKey){
        const pass = prompt("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√≥a ƒë∆°n giao h√†ng n√†y:");
        if(pass !== "minhtriet1973"){ alert("Sai m·∫≠t kh·∫©u."); return; }
        deleteDelivery(realKey, false);
        setTimeout(generateDeliveryReport, 300);
    }

    if (key) { proceed(key); return; }
    if (!orderId){
        alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c kh√≥a ho·∫∑c m√£ ƒë∆°n ƒë·ªÉ x√≥a.");
        return;
    }
    try{
        database.ref('deliveries').orderByChild('orderId').equalTo(orderId).once('value')
            .then((snap) => {
                let found = null;
                snap.forEach(child => { if(!found){ found = child.key; } });
                if (!found){
                    alert("Kh√¥ng t√¨m th·∫•y ƒë∆°n ƒë·ªÉ x√≥a (theo M√£ ƒë∆°n).");
                    return;
                }
                proceed(found);
            })
            .catch(err => alert("L·ªói t√¨m kh√≥a theo M√£ ƒë∆°n: " + err.message));
    }catch(e){
        alert("L·ªói truy v·∫•n Firebase: " + e.message);
    }
}

// ===== (IDECO) CH·ªåN & X√ìA L·ªäCH S·ª¨ X√ìA B√ÅO C√ÅO =====
function getSelectedAuditIds(){
    const boxes = document.querySelectorAll('input.auditRowCbx[type="checkbox"]:checked');
    return Array.from(boxes).map(b => b.value);
}


async function deleteSelectedAuditLogs(){
    const ids = getSelectedAuditIds();
    if(ids.length === 0){
        alert("Ch∆∞a ch·ªçn b·∫£n ghi n√†o.");
        return;
    }
    const name = prompt("Nh·∫≠p t√™n ng∆∞·ªùi th·ª±c hi·ªán x√≥a l·ªãch s·ª≠:");
    if(!name){ alert("B·∫°n ch∆∞a nh·∫≠p t√™n."); return; }
    const pass = prompt("Nh·∫≠p m·∫≠t kh·∫©u x√≥a l·ªãch s·ª≠:");
    if(pass !== "minhtriet1973"){
        alert("Sai m·∫≠t kh·∫©u.");
        return;
    }
    if(!confirm(`X√≥a ${ids.length} d√≤ng l·ªãch s·ª≠?`)) return;

    try {
        // X√≥a t·ª´ng b·∫£n ghi
        const tasks = ids.map(id => database.ref(`/auditLogs/reportClears/${id}`).remove());
        await Promise.all(tasks);
        // Ghi log ng∆∞·ªùi x√≥a
        await database.ref('/auditLogs/auditLogDeletes').push({
            deleterName: name,
            deletedCount: ids.length,
            deletedIds: ids,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        alert("ƒê√£ x√≥a l·ªãch s·ª≠ ƒë√£ ch·ªçn.");
        const limitInput = document.getElementById('auditLimitInput');
        loadAuditLogs(limitInput ? limitInput.value : 200);
    } catch(e){
        alert("L·ªói khi x√≥a l·ªãch s·ª≠: " + e.message);
        console.error(e);
    }
}
// Hook n√∫t x√≥a

(function(){
    const btn = document.getElementById('deleteSelectedAuditBtn');
    if(btn){
        btn.addEventListener('click', deleteSelectedAuditLogs);
    }
    // Hook ch·ªçn t·∫•t c·∫£
    const cbAll = document.getElementById('auditSelectAll');
    if(cbAll){
        cbAll.addEventListener('change', function(){
            document.querySelectorAll('input.auditRowCbx[type="checkbox"]').forEach(cb => cb.checked = cbAll.checked);
        });
    }
})();

// ===== (IDECO) HI·ªÇN TH·ªä L·ªäCH S·ª¨ X√ìA B√ÅO C√ÅO =====
function formatVNTime(ts){
    try{
        const d = new Date(ts);
        // Fallback if server value comes as number or string
        return d.toLocaleString('vi-VN');
    }catch(e){ return String(ts); }
}

let auditListener = null;
function loadAuditLogs(limitCount){
    const tbody = document.getElementById('auditLogsTableBody');
    if(!tbody) return;
    tbody.innerHTML = `<tr><td colspan="3" style="padding:10px; color:#6b7280;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>`;

    // detach previous listener if any
    if (auditListener) {
        auditListener.off && auditListener.off();
        auditListener = null;
    }
    const ref = database.ref('/auditLogs/reportClears').orderByChild('timestamp').limitToLast(Number(limitCount)||200);
    ref.on('value', snap => {
        const rows = [];
        const data = snap.val() || {};
        // Convert to array and sort desc by timestamp
        const arr = Object.entries(data).map(([k,v]) => ({id:k, ...v}))
            .sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        if(arr.length === 0){
            tbody.innerHTML = `<tr><td colspan="3" style="padding:10px; color:#6b7280;">Ch∆∞a c√≥ log x√≥a n√†o.</td></tr>`;
            return;
        }
        tbody.innerHTML = '';
        arr.forEach(item => {
            const when = item.timestamp ? formatVNTime(item.timestamp) : '-';
            const typ = item.type === 'delivery' ? 'Giao h√†ng' : (item.type === 'packing' ? 'ƒê√≥ng h√†ng' : (item.type||'-'));
            const who = item.deleterName || '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:8px; border-bottom:1px solid #e5e7eb; text-align:center;"><input class="auditRowCbx" type="checkbox" value="${item.id}"></td>
                <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${when}</td>
                <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${typ}</td>
                <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${who}</td>
            `;
            tbody.appendChild(tr);
        });
    });
    // store to detach later
    auditListener = ref;
}

// Hook controls
(function(){
    const btn = document.getElementById('refreshAuditLogsBtn');
    const input = document.getElementById('auditLimitInput');
    if(btn){
        btn.addEventListener('click', () => loadAuditLogs(input ? input.value : 200));
    }
    // Auto-load on start (give DOM a tick)
    setTimeout(() => loadAuditLogs(input ? input.value : 200), 300);
})();

// ===== (IDECO) B·ªî SUNG T√çNH NƒÇNG THEO Y√äU C·∫¶U =====

// 1) T·ª± ƒë·ªông UPPERCASE khi nh·∫≠p m√£ ƒë∆°n h√†ng
function attachUppercaseHandler(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', function(){
        const s = this.selectionStart;
        const e = this.selectionEnd;
        this.value = this.value.toUpperCase();
        this.setSelectionRange(s, e);
    });
}
// G·∫Øn khi DOM s·∫µn s√†ng (an to√†n n·∫øu g·ªçi nhi·ªÅu l·∫ßn)
(function(){
    const ids = ['packingOrderId','orderId','editOrderId','editPackingOrderId'];
    ids.forEach(attachUppercaseHandler);
})();

// 2) H√†m x√°c th·ª±c x√≥a b√°o c√°o (m·∫≠t kh·∫©u + l∆∞u t√™n ng∆∞·ªùi x√≥a)
function requestDeletionAuth(reportType){
    const name = prompt("Nh·∫≠p t√™n ng∆∞·ªùi x√≥a b√°o c√°o:");
    if(!name){ alert("B·∫°n ch∆∞a nh·∫≠p t√™n."); return null; }
    const pass = prompt("Nh·∫≠p m·∫≠t kh·∫©u x√≥a b√°o c√°o:");
    if(pass !== "ideco@2025"){ alert("Sai m·∫≠t kh·∫©u."); return null; }
    // L∆∞u log ng∆∞·ªùi x√≥a
    try {
        database.ref('/auditLogs/reportClears').push({
            type: reportType,
            deleterName: name,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    } catch(e){ /* noop */ }
    return {name};
}

// 3) Ki·ªÉm tra tr√πng m√£ ƒë∆°n khi L∆ØU GIAO H√ÄNG
async function isDuplicateOrderId(orderId){
    const snap = await database.ref('deliveries').orderByChild('orderId').equalTo(orderId).once('value');
    return snap.exists();
}

// Bi·∫øn to√†n c·ª•c
        let currentEditKey = null;
        let currentPackingEditKey = null;
        
        // Popup c·∫£nh b√°o m·∫•t th·ªëng k√™ khi x√≥a (GLOBAL)
        function confirmStatsLoss() {
            return confirm("B·∫°n c√¢n nh·∫Øc k·ªπ khi x√≥a nh√© v√¨ s·∫Ω m·∫•t d·ªØ li·ªáu th·ªëng k√™. N·∫øu kh√¥ng mu·ªën sai , b·∫°n ph·∫£i khai l·∫°i ƒë√∫ng nh√©");
        }

        
        // Bi·∫øn ƒë·ªÉ x·ª≠ l√Ω x√°c nh·∫≠n chuy·ªÉn giao
        let pendingTransfer = { key: null, targetStatus: null };
        
        // H√†m kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', function() {
            // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('packingDate').value = today;
            const editPackingDateEl = document.getElementById('editPackingDate');
            if (editPackingDateEl) editPackingDateEl.value = today;
            document.getElementById('packingReportDate').value = today;
            document.getElementById('deliveryFromDate').value = today;
            document.getElementById('deliveryToDate').value = today;
            document.getElementById('packingFromDate').value = today;
            document.getElementById('packingToDate').value = today;
            
            // Load d·ªØ li·ªáu ban ƒë·∫ßu
            loadStats();
            loadTodayDeliveries();
            loadPackingStats();
            loadTodayPackings();
            
            // Thi·∫øt l·∫≠p s·ª± ki·ªán tab
            setupTabs();
            
            // Thi·∫øt l·∫≠p s·ª± ki·ªán thay ƒë·ªïi lo·∫°i b√°o c√°o giao h√†ng
            document.getElementById('reportType').addEventListener('change', function() {
                const reportType = this.value;
                document.getElementById('reportDate').style.display = 'none';
                document.getElementById('reportWeek').style.display = 'none';
                document.getElementById('reportMonth').style.display = 'none';
                
                if (reportType === 'daily') {
                    document.getElementById('reportDate').style.display = 'block';
                } else if (reportType === 'weekly') {
                    document.getElementById('reportWeek').style.display = 'block';
                } else if (reportType === 'monthly') {
                    document.getElementById('reportMonth').style.display = 'block';
                }
            });
            
            // Thi·∫øt l·∫≠p s·ª± ki·ªán thay ƒë·ªïi lo·∫°i b√°o c√°o ƒë√≥ng h√†ng
            document.getElementById('packingReportType').addEventListener('change', function() {
                const reportType = this.value;
                document.getElementById('packingReportDate').style.display = 'none';
                document.getElementById('packingReportWeek').style.display = 'none';
                document.getElementById('packingReportMonth').style.display = 'none';
                
                if (reportType === 'daily') {
                    document.getElementById('packingReportDate').style.display = 'block';
                } else if (reportType === 'weekly') {
                    document.getElementById('packingReportWeek').style.display = 'block';
                } else if (reportType === 'monthly') {
                    document.getElementById('packingReportMonth').style.display = 'block';
                }
            });
            
            // Ki·ªÉm tra reset th·ªëng k√™ h√†ng ng√†y
            checkDailyReset();
            
            // T·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ªØ li·ªáu khi c√≥ thay ƒë·ªïi
            database.ref('deliveries').on('value', () => {
                loadTodayDeliveries();
                loadStats();
            });
            
            database.ref('packings').on('value', () => {
                loadTodayPackings();
                loadPackingStats();
            });
            
            database.ref('packingStats').on('value', () => {
                loadPackingStats();
            });
            
            // G·∫Øn s·ª± ki·ªán cho n√∫t x√°c nh·∫≠n chuy·ªÉn giao
            const confirmBtn = document.getElementById('confirmTransferBtn');
            confirmBtn.addEventListener('click', function() {
                if (!pendingTransfer.key) return;
                // 1) C·∫≠p nh·∫≠t tr·∫°ng th√°i packings nh∆∞ tr∆∞·ªõc
                proceedToggleDeliveryStatus(pendingTransfer.key, pendingTransfer.targetStatus);
                // 2) Chuy·ªÉn d·ªØ li·ªáu sang form giao h√†ng
                prefillDeliveryFormFromPacking(pendingTransfer.key);
                // 3) ƒê√≥ng popup & reset
                closeTransferConfirmModal();
                pendingTransfer = { key: null, targetStatus: null };
            });
        });
        
        // ========== C√ÅC H√ÄM CHUNG ==========
        
        // Xem ƒë·ªãa ch·ªâ tr√™n b·∫£n ƒë·ªì
        function viewOnMap(addressFieldId) {
            const address = document.getElementById(addressFieldId).value.trim();
            if (!address) {
                alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ tr∆∞·ªõc khi xem b·∫£n ƒë·ªì");
                return;
            }
            
            // M·ªü Google Maps trong tab m·ªõi
            const encodedAddress = encodeURIComponent(address);
            window.open(`https://www.google.com/maps?q=${encodedAddress}`, '_blank');
        }
        
        // Thi·∫øt l·∫≠p tab
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    activateTab(this.getAttribute('data-tab'));
                });
            });
        }
        
        // K√≠ch ho·∫°t tab theo id ("packing" | "delivery" | "reports" | "management")
        function activateTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            const targetTabButton = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (targetTabButton) targetTabButton.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById(`${tabId}-tab`);
            if (targetContent) targetContent.classList.add('active');
        }
        
        // L·∫•y s·ªë tu·∫ßn trong nƒÉm
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        // Ki·ªÉm tra reset th·ªëng k√™ h√†ng ng√†y
        function checkDailyReset() {
            const now = new Date();
            const lastReset = localStorage.getItem('lastReset');
            const today = now.toISOString().split('T')[0];
            
            if (lastReset !== today && now.getHours() === 0 && now.getMinutes() < 1) {
                localStorage.setItem('lastReset', today);
                loadStats();
                loadTodayDeliveries();
                loadPackingStats();
                loadTodayPackings();
            }
            
            // Ki·ªÉm tra m·ªói ph√∫t
            setTimeout(checkDailyReset, 60000);
        }
        
        // ƒê√≥ng modal giao h√†ng
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditKey = null;
        }
        
        // ƒê√≥ng modal ƒë√≥ng h√†ng
        function closePackingModal() {
            document.getElementById('editPackingModal').style.display = 'none';
            currentPackingEditKey = null;
        }
        
        // M·ªü modal h∆∞·ªõng d·∫´n
        function openHelpModal() {
            document.getElementById('helpModal').style.display = 'block';
        }
        
        // ƒê√≥ng modal h∆∞·ªõng d·∫´n
        function closeHelpModal() {

            document.getElementById('helpModal').style.display = 'none';
        }
        
        // ƒê√≥ng/M·ªü modal nh·∫Øc nh·ªü chuy·ªÉn giao
        function openTransferConfirmModal() {
            document.getElementById('transferConfirmModal').style.display = 'block';
        }
        function closeTransferConfirmModal() {
            document.getElementById('transferConfirmModal').style.display = 'none';
        }
        
        // ========== C√ÅC H√ÄM B·ªî TR·ª¢ M·ªöI ==========
        // L·∫•y d·ªØ li·ªáu ƒë√≥ng h√†ng v√† t·ª± ƒëi·ªÅn sang form giao h√†ng
        function prefillDeliveryFormFromPacking(packingKey) {
            database.ref(`packings/${packingKey}`).once('value')
                .then((snapshot) => {
                    const p = snapshot.val();
                    if (!p) return;
                    document.getElementById('orderId').value = p.orderId || '';
                    document.getElementById('customerName').value = p.customerName || '';
                    document.getElementById('deliveryAddress').value = p.address || '';
                    // Ng√†y giao m·∫∑c ƒë·ªãnh h√¥m nay
                    document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
                    // Chuy·ªÉn sang tab Giao h√†ng
                    activateTab('delivery');
                    alert("ƒê√£ chuy·ªÉn th√¥ng tin sang tab Giao h√†ng.\nVui l√≤ng nh·∫≠p T√™n ng∆∞·ªùi giao v√† nh·∫•n L∆∞u.");
                });
        }
        
        // ========== CH·ª®C NƒÇNG ƒê√ìNG H√ÄNG ==========
        
        // L∆∞u th√¥ng tin ƒë√≥ng h√†ng
        function savePacking() {
            let orderId = document.getElementById('packingOrderId').value.trim().toUpperCase();
            document.getElementById('packingOrderId').value = orderId;
            const customerName = document.getElementById('packingCustomerName').value.trim();
            const address = document.getElementById('packingAddress').value.trim();
            const packingDate = document.getElementById('packingDate').value;
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            
            const packingKey = database.ref().child('packings').push().key;
            
            const packingData = {
                orderId: orderId,
                customerName: customerName,
                address: address,
                packingDate: packingDate,
                isDelivered: false,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`/packings/${packingKey}`).set(packingData)
                .then(() => {
                    alert("ƒê√£ x√°c nh·∫≠n ƒë√≥ng h√†ng th√†nh c√¥ng!");
                    // Reset form
                    document.getElementById('packingOrderId').value = '';
                    document.getElementById('packingCustomerName').value = '';
                    document.getElementById('packingAddress').value = '';
                })
                .catch((error) => {
                    alert("L·ªói khi l∆∞u th√¥ng tin: " + error.message);
                });
        }
        
        // Load th·ªëng k√™ ƒë√≥ng h√†ng (t·∫•t c·∫£ ƒë·ªÅu t√≠nh theo *h√¥m nay* ƒë·ªÉ kh·ªõp v·ªõi b·∫£ng hi·ªÉn th·ªã)
        function loadPackingStats() {
            const today = new Date().toISOString().split('T')[0];
            database.ref('packings').orderByChild('packingDate').equalTo(today).once('value')
                .then((snapshot) => {
                    let todayTotal = 0, todayWaiting = 0, todayDelivered = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const v = child.val() || {};
                            todayTotal += 1;
                            if (v.isDelivered) todayDelivered += 1;
                            else todayWaiting += 1;
                        });
                    }
                    document.getElementById('todayPackedCount').textContent = todayTotal;
                    document.getElementById('waitingDeliveryCount').textContent = todayWaiting;
                    document.getElementById('deliveredCount').textContent = todayDelivered;
                })
                .catch((error) => {
                    console.error('L·ªói khi t·∫£i th·ªëng k√™ ƒë√≥ng h√†ng h√¥m nay:', error);
                    document.getElementById('todayPackedCount').textContent = '‚Äî';
                    document.getElementById('waitingDeliveryCount').textContent = '‚Äî';
                    document.getElementById('deliveredCount').textContent = '‚Äî';
                });
        }
        
        // Load danh s√°ch ƒë√≥ng h√†ng h√¥m nay
        function loadTodayPackings() {
            const today = new Date().toISOString().split('T')[0];
            
            database.ref('packings').orderByChild('packingDate').equalTo(today).once('value')
                .then((snapshot) => {
                    const tableBody = document.getElementById('packingTableBody');
                    tableBody.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o h√¥m nay</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach((childSnapshot) => {
                        const packing = childSnapshot.val();
                        const row = document.createElement('tr');
                        
                        const status = packing.isDelivered ? 
                            '<span class="packing-status packed">ƒê√£ giao</span>' : 
                            '<span class="packing-status not-packed">Ch·ªù giao</span>';
                        
                        const buttonText = packing.isDelivered ? 
                            '<i class="fas fa-undo"></i> Chuy·ªÉn v·ªÅ ch·ªù giao' : 
                            '<i class="fas fa-truck"></i> Chuy·ªÉn giao h√†ng';
                        
                        const buttonClass = packing.isDelivered ? 'btn-warning' : 'btn-primary';
                        
                        row.innerHTML = `
                            <td>${packing.orderId}</td>
                            <td>${packing.customerName}</td>
                            <td>${packing.address}</td>
                            <td>${status}</td>
                            <td class="action-btns">
                                <button class="btn ${buttonClass} btn-sm" onclick="toggleDeliveryStatus('${childSnapshot.key}', ${packing.isDelivered})">
                                    ${buttonText}
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openEditPackingModal('${childSnapshot.key}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmDeletePacking('${childSnapshot.key}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                });
        }
        
        // M·ªü modal ch·ªânh s·ª≠a ƒë√≥ng h√†ng
        function openEditPackingModal(key) {
            currentPackingEditKey = key;
            const modal = document.getElementById('editPackingModal');
            
            database.ref(`packings/${key}`).once('value')
                .then((snapshot) => {
                    const packing = snapshot.val();
                    
                    document.getElementById('editPackingKey').value = key;
                    document.getElementById('editPackingOrderId').value = packing.orderId;
                    document.getElementById('editPackingCustomerName').value = packing.customerName;
                    document.getElementById('editPackingAddress').value = packing.address;
                    document.getElementById('editPackingDate').value = packing.packingDate;
                    document.getElementById('editPackingStatus').value = packing.isDelivered;
                    
                    modal.style.display = 'block';
                });
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin ƒë√≥ng h√†ng
        function updatePacking() {
            const key = currentPackingEditKey;
            let orderId = document.getElementById('editPackingOrderId').value.trim().toUpperCase();
            document.getElementById('editPackingOrderId').value = orderId;
            const customerName = document.getElementById('editPackingCustomerName').value.trim();
            const address = document.getElementById('editPackingAddress').value.trim();
            const packingDate = document.getElementById('editPackingDate').value;
            const isDelivered = document.getElementById('editPackingStatus').value === 'true';
            
            if (!orderId || !customerName || !address || !packingDate) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            
            const updatedData = {
                orderId: orderId,
                customerName: customerName,
                address: address,
                packingDate: packingDate,
                isDelivered: isDelivered,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`/packings/${key}`).update(updatedData)
                .then(() => {
                    alert("C·∫≠p nh·∫≠t th√¥ng tin ƒë√≥ng h√†ng th√†nh c√¥ng!");
                    closePackingModal();
                    loadTodayPackings();
                    loadPackingStats();
                })
                .catch((error) => {
                    alert("L·ªói khi c·∫≠p nh·∫≠t: " + error.message);
                });
        }
        
        // X√°c nh·∫≠n x√≥a ƒë∆°n ƒë√≥ng h√†ng
        function confirmDeletePacking(key) {
            if (confirmStatsLoss()) {
                deletePacking(key);
            }
        }
        
        // X√≥a ƒë∆°n ƒë√≥ng h√†ng
        function deletePacking(key) {
            database.ref(`/packings/${key}`).remove()
                .then(() => {
                    alert("X√≥a ƒë∆°n ƒë√≥ng h√†ng th√†nh c√¥ng!");
                    loadTodayPackings();
                    loadPackingStats();
                })
                .catch((error) => {
                    alert("L·ªói khi x√≥a: " + error.message);
                });
        }
        
        // Chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i giao h√†ng (c√≥ nh·∫Øc nh·ªü khi chuy·ªÉn sang 'ƒê√£ giao')
        function toggleDeliveryStatus(key, currentStatus) {
            const newStatus = !currentStatus;
            if (newStatus) {
                // M·ªü popup nh·∫Øc nh·ªü tr∆∞·ªõc khi chuy·ªÉn sang 'ƒë√£ giao' + chu·∫©n b·ªã chuy·ªÉn d·ªØ li·ªáu
                pendingTransfer = { key, targetStatus: newStatus };
                openTransferConfirmModal();
            } else {
                // Chuy·ªÉn v·ªÅ 'ch·ªù giao' nh∆∞ c≈©
                proceedToggleDeliveryStatus(key, newStatus);
            }
        }
        
        function proceedToggleDeliveryStatus(key, newStatus) {
            const statusText = newStatus ? "ƒë√£ giao" : "ch·ªù giao";
            database.ref(`/packings/${key}/isDelivered`).set(newStatus)
                .then(() => {
                    alert(`ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng sang '${statusText}'!`);
                    loadTodayPackings();
                    loadPackingStats();
                })
                .catch((error) => {
                    alert("L·ªói khi c·∫≠p nh·∫≠t: " + error.message);
                });
        }
        
        // ========== CH·ª®C NƒÇNG GIAO H√ÄNG ==========
        
        // L∆∞u th√¥ng tin giao h√†ng
        function saveDelivery() {
            const orderId = document.getElementById('orderId').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const delivererName = document.getElementById('delivererName').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            
            // T·∫°o key duy nh·∫•t cho m·ªói ƒë∆°n h√†ng
            const deliveryKey = database.ref().child('deliveries').push().key;
            
            // T·∫°o object d·ªØ li·ªáu (ƒë√£ b·ªè th·ªùi gian, th√™m ng∆∞·ªùi giao)
            const deliveryData = {
                orderId: orderId,
                deliveryDate: deliveryDate,
                delivererName: delivererName,
                customerName: customerName,
                deliveryAddress: deliveryAddress,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // L∆∞u d·ªØ li·ªáu l√™n Firebase
            const updates = {};
            updates[`/deliveries/${deliveryKey}`] = deliveryData;
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            const today = new Date().toISOString().split('T')[0];
            const week = getWeekNumber(new Date());
            const month = new Date().getMonth();
            
            updates[`/stats/daily/${today}/${deliveryKey}`] = true;
            updates[`/stats/weekly/${week}/${deliveryKey}`] = true;
            updates[`/stats/monthly/${month}/${deliveryKey}`] = true;
            
            database.ref().update(updates)
                .then(() => {
                    alert("ƒê√£ l∆∞u th√¥ng tin giao h√†ng th√†nh c√¥ng!");
                    // Reset form (gi·ªØ ng√†y h√¥m nay cho ti·ªán)
                    document.getElementById('orderId').value = '';
                    document.getElementById('delivererName').value = '';
                    document.getElementById('customerName').value = '';
                    document.getElementById('deliveryAddress').value = '';
                })
                .catch((error) => {
                    alert("L·ªói khi l∆∞u th√¥ng tin: " + error.message);
                });
        }
        
        // Load th·ªëng k√™ giao h√†ng
        function loadStats() {
            const today = new Date().toISOString().split('T')[0];
            const week = getWeekNumber(new Date());
            const month = new Date().getMonth();
            
            // ƒê·∫øm s·ªë ƒë∆°n h√†ng h√¥m nay
            database.ref(`stats/daily/${today}`).once('value')
                .then((snapshot) => {
                    document.getElementById('todayCount').textContent = snapshot.numChildren();
                });
            
            // ƒê·∫øm s·ªë ƒë∆°n h√†ng tu·∫ßn n√†y
            database.ref(`stats/weekly/${week}`).once('value')
                .then((snapshot) => {
                    document.getElementById('weeklyCount').textContent = snapshot.numChildren();
                });
            
            // ƒê·∫øm s·ªë ƒë∆°n h√†ng th√°ng n√†y
            database.ref(`stats/monthly/${month}`).once('value')
                .then((snapshot) => {
                    document.getElementById('monthlyCount').textContent = snapshot.numChildren();
                });
        }
        
        // Load danh s√°ch giao h√†ng h√¥m nay
        function loadTodayDeliveries() {
            const today = new Date().toISOString().split('T')[0];
            
            database.ref('deliveries').orderByChild('deliveryDate').equalTo(today).once('value')
                .then((snapshot) => {
                    const tableBody = document.getElementById('deliveryTableBody');
                    tableBody.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o h√¥m nay</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach((childSnapshot) => {
                        const delivery = childSnapshot.val();
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${delivery.orderId}</td>
                            <td>${delivery.delivererName || '-'}</td>
                            <td>${delivery.customerName}</td>
                            <td>${delivery.deliveryAddress}</td>
                            <td class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="openEditModal('${childSnapshot.key}')">
                                    <i class="fas fa-edit"></i> S·ª≠a
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmDeleteDelivery('${childSnapshot.key}')">
                                    <i class="fas fa-trash"></i> X√≥a
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                });
        }
        
        // X√°c nh·∫≠n x√≥a ƒë∆°n giao h√†ng
        function confirmDeleteDelivery(key) {
            if (confirmStatsLoss()) {
                deleteDelivery(key);
            }
        }
        
        // X√≥a ƒë∆°n giao h√†ng
        function deleteDelivery(key, fromManagement = false) {
            // L·∫•y ng√†y giao c·ªßa ƒë∆°n h√†ng ƒë·ªÉ x√≥a kh·ªèi th·ªëng k√™ ƒë√∫ng ng√†y/tu·∫ßn/th√°ng
            database.ref(`deliveries/${key}`).once('value')
                .then((snap) => {
                    const delivery = snap.val();
                    if (!delivery) return;
                    
                    const deliveryDate = delivery.deliveryDate;
                    const deliveryDay = new Date(deliveryDate);
                    const deliveryWeek = getWeekNumber(deliveryDay);
                    const deliveryMonth = deliveryDay.getMonth();
                    
                    // X√≥a ƒë∆°n h√†ng v√† c·∫≠p nh·∫≠t th·ªëng k√™
                    const updates = {};
                    updates[`/deliveries/${key}`] = null;
                    updates[`/stats/daily/${deliveryDate}/${key}`] = null;
                    updates[`/stats/weekly/${deliveryWeek}/${key}`] = null;
                    updates[`/stats/monthly/${deliveryMonth}/${key}`] = null;
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    alert("X√≥a ƒë∆°n h√†ng th√†nh c√¥ng!");
                    
                    if (fromManagement) {
                        searchOrders(); // Refresh k·∫øt qu·∫£ t√¨m ki·∫øm
                    } else {
                        loadTodayDeliveries(); // Refresh danh s√°ch giao h√†ng h√¥m nay
                    }
                    
                    loadStats();
                })
                .catch((error) => {
                    alert("L·ªói khi x√≥a: " + error.message);
                });
        }
        
        // ========== CH·ª®C NƒÇNG QU·∫¢N L√ù ==========
        
        // M·ªü modal ch·ªânh s·ª≠a
        function openEditModal(key) {
            currentEditKey = key;
            const modal = document.getElementById('editModal');
            
            database.ref(`deliveries/${key}`).once('value')
                .then((snapshot) => {
                    const delivery = snapshot.val();
                    
                    document.getElementById('editKey').value = key;
                    document.getElementById('editOrderId').value = delivery.orderId;
                    document.getElementById('editDeliveryDate').value = delivery.deliveryDate;
                    document.getElementById('editDelivererName').value = delivery.delivererName || '';
                    document.getElementById('editCustomerName').value = delivery.customerName;
                    document.getElementById('editDeliveryAddress').value = delivery.deliveryAddress;
                    
                    modal.style.display = 'block';
                });
        }
        
        // C·∫≠p nh·∫≠t ƒë∆°n h√†ng
        function updateDelivery() {
            const key = currentEditKey;
            let orderId = document.getElementById('editOrderId').value.trim().toUpperCase();
            document.getElementById('editOrderId').value = orderId;
            const deliveryDate = document.getElementById('editDeliveryDate').value;
            const delivererName = document.getElementById('editDelivererName').value.trim();
            const customerName = document.getElementById('editCustomerName').value.trim();
            const deliveryAddress = document.getElementById('editDeliveryAddress').value.trim();
            
            if (!orderId || !deliveryDate || !delivererName || !customerName || !deliveryAddress) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            
            const updatedData = {
                orderId: orderId,
                deliveryDate: deliveryDate,
                delivererName: delivererName,
                customerName: customerName,
                deliveryAddress: deliveryAddress,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`deliveries/${key}`).update(updatedData)
                .then(() => {
                    alert("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!");
                    closeModal();
                    loadTodayDeliveries();
                    loadStats();
                })
                .catch((error) => {
                    alert("L·ªói khi c·∫≠p nh·∫≠t: " + error.message);
                });
        }
        
        // T√¨m ki·∫øm ƒë∆°n h√†ng
        function searchOrders() {
            const searchTerm = document.getElementById('searchOrder').value.trim().toLowerCase();
            
            if (searchTerm === '') {
                alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm");
                return;
            }
            
            database.ref('deliveries').once('value')
                .then((snapshot) => {
                    const tableBody = document.getElementById('managementTableBody');
                    tableBody.innerHTML = '';
                    
                    let found = false;
                    
                    snapshot.forEach((childSnapshot) => {
                        const delivery = childSnapshot.val();
                        
                        if (delivery.orderId.toLowerCase().includes(searchTerm) || 
                            delivery.customerName.toLowerCase().includes(searchTerm)) {
                            found = true;
                            
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${delivery.orderId}</td>
                                <td>${delivery.deliveryDate}</td>
                                <td>${delivery.delivererName || '-'}</td>
                                <td>${delivery.customerName}</td>
                                <td>${delivery.deliveryAddress}</td>
                                <td class="action-btns">
                                    <button class="btn btn-primary btn-sm" onclick="openEditModal('${childSnapshot.key}')">
                                        <i class="fas fa-edit"></i> S·ª≠a
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="confirmDeleteDeliveryFromManagement('${childSnapshot.key}')">
                                        <i class="fas fa-trash"></i> X√≥a
                                    </button>
                                </td>
                            `;
                            
                            tableBody.appendChild(row);
                        }
                    });
                    
                    if (!found) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ph√π h·ª£p</td></tr>';
                    }
                });
        }
        
        // X√°c nh·∫≠n x√≥a t·ª´ trang qu·∫£n l√Ω
        function confirmDeleteDeliveryFromManagement(key) {
            if (confirmStatsLoss()) {
                deleteDelivery(key, true);
            }
        }
        
        // ========== CH·ª®C NƒÇNG B√ÅO C√ÅO ==========
        
        // H·ªó tr·ª£ so s√°nh ng√†y d·∫°ng 'YYYY-MM-DD'
        function isDateInRange(isoDate, fromIso, toIso) {
            if (!isoDate) return false;
            if (!fromIso && !toIso) return true;
            const d = new Date(isoDate);
            if (fromIso) {
                const from = new Date(fromIso);
                if (d < from) return false;
            }
            if (toIso) {
                const to = new Date(toIso);
                // Bao g·ªìm c·∫£ ng√†y 'to' n√™n c·ªông th√™m 1 ng√†y - 1 ms
                to.setDate(to.getDate() + 1);
                if (d >= to) return false;
            }
            return true;
        }
        
        // T·∫°o b√°o c√°o giao h√†ng (h·ªó tr·ª£ theo lo·∫°i + kho·∫£ng th·ªùi gian)
        function generateDeliveryReport() {
            const fromDate = document.getElementById('deliveryFromDate').value;
            const toDate = document.getElementById('deliveryToDate').value;
            
            const spinner = document.getElementById('reportSpinner');
            spinner.style.display = 'block';
            document.getElementById('reportTableBody').innerHTML = '';
            
            if (fromDate && toDate) {
                // L·ªçc theo kho·∫£ng th·ªùi gian t√πy √Ω
                database.ref('deliveries').once('value')
                    .then((snapshot) => {
                        const list = [];
                        snapshot.forEach(child => {
                            const v = child.val();
                            v.__key = child.key; if (isDateInRange(v.deliveryDate, fromDate, toDate)) list.push(v);
                        });
                        renderDeliveryReportRows(list);
                        spinner.style.display = 'none';
                    })
                    .catch(() => {
                        document.getElementById('reportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
                        spinner.style.display = 'none';
                    });
                return;
            }
            
            // N·∫øu kh√¥ng c√≥ from/to -> d√πng ki·ªÉu c≈©: ng√†y/tu·∫ßn/th√°ng
            const reportType = document.getElementById('reportType').value;
            let dateValue, refPath;
            
            if (reportType === 'daily') {
                dateValue = document.getElementById('reportDate').value;
                if (!dateValue) {
                    alert("Vui l√≤ng ch·ªçn ng√†y b√°o c√°o");
                    spinner.style.display = 'none';
                    return;
                }
                refPath = `stats/daily/${dateValue}`;
            } else if (reportType === 'weekly') {
                dateValue = document.getElementById('reportWeek').value;
                if (!dateValue) {
                    alert("Vui l√≤ng ch·ªçn tu·∫ßn b√°o c√°o");
                    spinner.style.display = 'none';
                    return;
                }
                const year = dateValue.substring(0, 4);
                const week = dateValue.substring(6);
                refPath = `stats/weekly/${week}`; // Gi·ªØ logic tu·∫ßn theo s·ªë tu·∫ßn hi·ªán t·∫°i
            } else if (reportType === 'monthly') {
                dateValue = document.getElementById('reportMonth').value;
                if (!dateValue) {
                    alert("Vui l√≤ng ch·ªçn th√°ng b√°o c√°o");
                    spinner.style.display = 'none';
                    return;
                }
                const month = new Date(dateValue).getMonth();
                refPath = `stats/monthly/${month}`;
            }
            
            database.ref(refPath).once('value')
                .then((snapshot) => {
                    const orderKeys = Object.keys(snapshot.val() || {});
                    if (orderKeys.length === 0) {
                        document.getElementById('reportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        spinner.style.display = 'none';
                        return;
                    }
                    
                    // L·∫•y th√¥ng tin chi ti·∫øt c√°c ƒë∆°n h√†ng
                    const promises = orderKeys.map(key => 
                        database.ref(`deliveries/${key}`).once('value')
                    );
                    
                    return Promise.all(promises);
                })
                .then((snapshots) => {
                    if (!snapshots) return;
                    const list = [];
                    snapshots.forEach((childSnapshot) => {
                        if (!childSnapshot.exists()) return;
                        const data = childSnapshot.val(); data.__key = childSnapshot.key; list.push(data);
                    });
                    renderDeliveryReportRows(list);
                    spinner.style.display = 'none';
                })
                .catch((error) => {
                    console.error("L·ªói khi t·∫°o b√°o c√°o:", error);
                    document.getElementById('reportTableBody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
                    spinner.style.display = 'none';
                });
        }
        
        function renderDeliveryReportRows(list) {
            const tableBody = document.getElementById('reportTableBody');
            tableBody.innerHTML = '';
            if (!list || list.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }
            // S·∫Øp x·∫øp theo ng√†y giao r·ªìi theo m√£ ƒë∆°n ƒë·ªÉ ·ªïn ƒë·ªãnh
            list.sort((a, b) => (a.deliveryDate + ' ' + (a.orderId || '')).localeCompare(b.deliveryDate + ' ' + (b.orderId || '')));
            list.forEach((delivery, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${delivery.orderId}</td>
                    <td>${delivery.deliveryDate}</td>
                    <td>${delivery.delivererName || '-'}</td>
                    <td>${delivery.customerName}</td>
                    <td>${delivery.deliveryAddress}</td>
                <td><button class="btn btn-danger btn-sm" data-key="${delivery.__key || ''}" data-order-id="${delivery.orderId || ''}" onclick="handleDeleteFromReport(this)" >${delivery.__key ? '<i class="fas fa-trash"></i>' : ''}</button></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // T·∫°o b√°o c√°o ƒë√≥ng h√†ng (h·ªó tr·ª£ theo lo·∫°i + kho·∫£ng th·ªùi gian)
        function generatePackingReport() {
            const fromDate = document.getElementById('packingFromDate').value;
            const toDate = document.getElementById('packingToDate').value;
            
            const spinner = document.getElementById('packingReportSpinner');
            spinner.style.display = 'block';
            document.getElementById('packingReportTableBody').innerHTML = '';
            
            database.ref('packings').once('value')
                .then((snapshot) => {
                    const allPackings = snapshot.val() || {};
                    const orderKeys = Object.keys(allPackings);
                    
                    if (orderKeys.length === 0) {
                        document.getElementById('packingReportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        spinner.style.display = 'none';
                        return;
                    }
                    
                    let filteredKeys = orderKeys;
                    
                    // N·∫øu c√≥ from/to -> l·ªçc theo kho·∫£ng
                    if (fromDate && toDate) {
                        filteredKeys = orderKeys.filter(key => {
                            const p = allPackings[key];
                            return isDateInRange(p.packingDate, fromDate, toDate);
                        });
                    } else {
                        // N·∫øu kh√¥ng c√≥ from/to -> d√πng ki·ªÉu c≈©: ng√†y/tu·∫ßn/th√°ng
                        const reportType = document.getElementById('packingReportType').value;
                        if (reportType === 'daily') {
                            const dateValue = document.getElementById('packingReportDate').value;
                            if (!dateValue) {
                                alert("Vui l√≤ng ch·ªçn ng√†y b√°o c√°o");
                                spinner.style.display = 'none';
                                return;
                            }
                            filteredKeys = orderKeys.filter(key => allPackings[key].packingDate === dateValue);
                        } else if (reportType === 'weekly') {
                            const dateValue = document.getElementById('packingReportWeek').value;
                            if (!dateValue) {
                                alert("Vui l√≤ng ch·ªçn tu·∫ßn b√°o c√°o");
                                spinner.style.display = 'none';
                                return;
                            }
                            const reportWeek = getWeekNumber(new Date(dateValue));
                            filteredKeys = orderKeys.filter(key => {
                                const packingDate = new Date(allPackings[key].packingDate);
                                return getWeekNumber(packingDate) === reportWeek &&
                                       packingDate.getFullYear() === new Date(dateValue).getFullYear();
                            });
                        } else if (reportType === 'monthly') {
                            const dateValue = document.getElementById('packingReportMonth').value;
                            if (!dateValue) {
                                alert("Vui l√≤ng ch·ªçn th√°ng b√°o c√°o");
                                spinner.style.display = 'none';
                                return;
                            }
                            filteredKeys = orderKeys.filter(key => {
                                const packingDate = new Date(allPackings[key].packingDate);
                                return packingDate.getMonth() === new Date(dateValue).getMonth() &&
                                       packingDate.getFullYear() === new Date(dateValue).getFullYear();
                            });
                        }
                    }
                    
                    if (filteredKeys.length === 0) {
                        document.getElementById('packingReportTableBody').innerHTML = 
                            '<tr><td colspan="6" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        spinner.style.display = 'none';
                        return;
                    }
                    
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    const tableBody = document.getElementById('packingReportTableBody');
                    tableBody.innerHTML = '';
                    
                    // S·∫Øp x·∫øp theo ng√†y ƒë√≥ng
                    filteredKeys.sort((a, b) => {
                        const pa = allPackings[a];
                        const pb = allPackings[b];
                        return (pa.packingDate + (pa.orderId || '')).localeCompare(pb.packingDate + (pb.orderId || ''));
                    });
                    
                    filteredKeys.forEach((key, index) => {
                        const packing = allPackings[key];
                        const status = packing.isDelivered ? "ƒê√£ giao" : "Ch·ªù giao";
                        
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${packing.orderId}</td>
                            <td>${packing.packingDate}</td>
                            <td>${packing.customerName}</td>
                            <td>${packing.address}</td>
                            <td>${status}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    spinner.style.display = 'none';
                })
                .catch((error) => {
                    console.error("L·ªói khi t·∫°o b√°o c√°o:", error);
                    document.getElementById('packingReportTableBody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
                    spinner.style.display = 'none';
                });
        }
        
        // X√≥a b√°o c√°o giao h√†ng
        function clearDeliveryReport(){
            const ok = requestDeletionAuth('delivery');
            if(!ok) return;
            document.getElementById('reportTableBody').innerHTML = '';
        }
        
        // X√≥a b√°o c√°o ƒë√≥ng h√†ng
        function clearPackingReport(){
            const ok = requestDeletionAuth('packing');
            if(!ok) return;
            document.getElementById('packingReportTableBody').innerHTML = '';
        }
        
        // Xu·∫•t b√°o c√°o giao h√†ng ra Excel
        function exportDeliveryToExcel() {
            const table = document.getElementById('reportTable');
            if (table.rows.length <= 1) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t Excel");
                return;
            }
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoGiaoHang");
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            XLSX.writeFile(wb, `BaoCaoGiaoHang_${dateStr}.xlsx`);
        }
        
        // Xu·∫•t b√°o c√°o ƒë√≥ng h√†ng ra Excel
        function exportPackingToExcel() {
            const table = document.getElementById('packingReportTable');
            if (table.rows.length <= 1) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t Excel");
                return;
            }
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoDongHang");
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            XLSX.writeFile(wb, `BaoCaoDongHang_${dateStr}.xlsx`);
        }
    </script>




<!-- Modal c·∫£nh b√°o tr√πng m√£ ƒë∆°n -->
<div id="duplicateModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close-btn" onclick="closeDuplicateModal()">&times;</span>
    <h2 style="color:#e74c3c;">C·∫¢NH B√ÅO TR√ôNG M√É</h2>
    <p style="white-space: pre-line; margin-top:10px;">
M√É N√ÄY B·ªä TR√ôNG - XEM L·∫†I ƒê√É GIAO CH∆ØA HAY KH√îNG
M√£: <strong id="dupCode">‚Äî</strong>
    </p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDuplicateModal()">H·ªßy</button>
      <button class="btn btn-danger" id="dupProceedBtn">V·∫´n l∆∞u</button>
    </div>
  </div>
</div>


<script>
// ==== DUPLICATE CODE WARNING (uses existing modal styles) ====
(function(){
  if (window.__dupWarnInjected__) return;
  window.__dupWarnInjected__ = true;

  let dupProceedHandler = null;
  window.openDuplicateModal = function(code, onProceed){
    var codeEl = document.getElementById('dupCode');
    var modal = document.getElementById('duplicateModal');
    if (!modal) { console.warn('duplicateModal not found'); return; }
    if (codeEl) codeEl.textContent = code || '‚Äî';
    dupProceedHandler = (typeof onProceed === 'function') ? onProceed : null;
    modal.style.display = 'block';
  };
  window.closeDuplicateModal = function(){
    var modal = document.getElementById('duplicateModal');
    if (modal) modal.style.display = 'none';
    dupProceedHandler = null;
  };
  // Hook proceed button once DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('dupProceedBtn');
    if (btn) {
      btn.addEventListener('click', function(){
        if (typeof dupProceedHandler === 'function') { try { dupProceedHandler(); } catch(e) { console.error(e); } }
        window.closeDuplicateModal();
      });
    }
    // blur check on #orderId if exists
    var ord = document.getElementById('orderId');
    if (ord) {
      ord.addEventListener('blur', async function(){
        var v = (ord.value || '').trim().toUpperCase();
        ord.value = v;
        if (!v) return;
        try {
          if (typeof isDuplicateOrderId === 'function') {
            var dup = await isDuplicateOrderId(v);
            if (dup) openDuplicateModal(v, null);
          }
        } catch (e) { console.error('Duplicate check (blur) error:', e); }
      });
    }
  });

  // wrap original saveDelivery to add duplicate check but preserve core behavior
  (function(){
    var orig = window.saveDelivery;
    if (typeof orig !== 'function') return; // nothing to wrap
    window.saveDelivery = async function(){
      // read common fields
      var orderIdInput = document.getElementById('orderId');
      if (orderIdInput) {
        orderIdInput.value = (orderIdInput.value || '').trim().toUpperCase();
      }
      var code = orderIdInput ? orderIdInput.value : '';

      // if fields missing, let original handle validation too
      try {
        if (code && typeof isDuplicateOrderId === 'function') {
          var dup = await isDuplicateOrderId(code);
          if (dup) {
            // ask user to proceed
            return openDuplicateModal(code, function(){ try { orig(); } catch(e){ console.error(e); } });
          }
        }
      } catch(e) {
        console.error('Duplicate check (save) error:', e);
      }
      // no duplicate -> continue original flow
      return orig();
    };
  })();
})();
</script>


<!-- ===== Modal x√°c nh·∫≠n ho√†n t·∫•t ƒê√ìNG H√ÄNG (B·ªî SUNG, KH√îNG ƒê·ªîI GIAO DI·ªÜN KH√ÅC) ===== -->
<div id="packingConfirmModal" class="modal" aria-hidden="true" style="display:none">
  <div class="modal-content" role="dialog" aria-labelledby="packingConfirmTitle" aria-modal="true">
    <span class="close-btn" onclick="(function(){var m=document.getElementById('packingConfirmModal'); if(m) m.style.display='none';})()" aria-label="ƒê√≥ng">&times;</span>
    <h2 id="packingConfirmTitle">X√ÅC NH·∫¨N HO√ÄN T·∫§T ƒê√ìNG H√ÄNG</h2>
    <p style="margin-top:10px; white-space:pre-line;">
B·∫°n ƒë√£ ch·∫Øc ch·∫Øn ki·ªÉm tra s·ªë l√¥, date t·ª´ng s·∫£n ph·∫©m,
phi·∫øu xu·∫•t kho v√† ƒë∆°n h√†ng ƒë·∫ßy ƒë·ªß ch∆∞a?
Vui l√≤ng ƒë·∫£m b·∫£o ƒë√∫ng th·ªß t·ª•c tr∆∞·ªõc khi x√°c nh·∫≠n ho√†n th√†nh ƒë√≥ng h√†ng.
    </p>
    <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
      <input type="checkbox" id="packingChecklistOk"> T√¥i ƒë√£ ki·ªÉm tra ƒë·ªß c√°c m·ª•c tr√™n
    </label>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="(function(){var m=document.getElementById('packingConfirmModal'); if(m) m.style.display='none';})()">H·ªßy</button>
      <button class="btn btn-primary" id="confirmPackingBtn" disabled>ƒê·ªìng √Ω</button>
    </div>
  </div>
</div>

<script>
// ===== Monkey-patch savePacking ƒë·ªÉ th√™m modal x√°c nh·∫≠n (KH√îNG ƒê·ªîI N√öT & UI G·ªêC) =====
(function(){
  // B·∫≠t/t·∫Øt n√∫t ƒê·ªìng √Ω theo checkbox
  function bindModalControls(){
    var cb = document.getElementById('packingChecklistOk');
    var ok = document.getElementById('confirmPackingBtn');
    if(!cb || !ok) return;
    cb.addEventListener('change', function(){ ok.disabled = !this.checked; });
    ok.addEventListener('click', function(){
      var modal = document.getElementById('packingConfirmModal');
      if(modal) modal.style.display = 'none';
      if (typeof window._savePackingOriginal === 'function') {
        window._savePackingOriginal();
      }
    });
  }

  function openPackingConfirmModal(){
    // ti·ªÅn ki·ªÉm nh·∫π ƒë·ªÉ kh·ªèi m·ªü modal khi thi·∫øu form
    try{
      var orderId = (document.getElementById('packingOrderId')||{}).value||'';
      var customer = (document.getElementById('packingCustomerName')||{}).value||'';
      var addr = (document.getElementById('packingAddress')||{}).value||'';
      var date = (document.getElementById('packingDate')||{}).value||'';
      if(!orderId.trim() || !customer.trim() || !addr.trim() || !date){
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß: M√£ ƒë∆°n, T√™n kh√°ch h√†ng, ƒê·ªãa ch·ªâ, Ng√†y ƒë√≥ng h√†ng tr∆∞·ªõc khi x√°c nh·∫≠n.");
        return;
      }
    }catch(e){ /* ignore precheck errors */ }
    var cb = document.getElementById('packingChecklistOk');
    var ok = document.getElementById('confirmPackingBtn');
    if(cb) cb.checked = false;
    if(ok) ok.disabled = true;
    var modal = document.getElementById('packingConfirmModal');
    if(modal){
      modal.style.display = 'block';
      // ESC ƒë·ªÉ ƒë√≥ng
      var escHandler = function(ev){ if(ev.key==='Escape'){ modal.style.display='none'; document.removeEventListener('keydown', escHandler); } };
      document.addEventListener('keydown', escHandler, { once:true });
    } else {
      // fallback: n·∫øu v√¨ l√Ω do g√¨ ƒë√≥ modal kh√¥ng c√≥ th√¨ g·ªçi h√†m g·ªëc
      if (typeof window._savePackingOriginal === 'function') window._savePackingOriginal();
    }
  }

  // Ch·ªâ patch n·∫øu c√≥ h√†m g·ªëc
  if (typeof window.savePacking === 'function') {
    // L∆∞u b·∫£n g·ªëc
    window._savePackingOriginal = window.savePacking;
    // Thay b·∫±ng phi√™n b·∫£n c√≥ modal
    window.savePacking = function(){
      openPackingConfirmModal();
    };
    // Bind sau khi DOM s·∫µn s√†ng
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bindModalControls);
    } else {
      bindModalControls();
    }
  } else {
    // N·∫øu trang load ch∆∞a khai b√°o savePacking, ƒë·ª£i ƒë·∫øn khi DOM s·∫µn s√†ng r·ªìi patch
    document.addEventListener('DOMContentLoaded', function(){
      if (typeof window.savePacking === 'function') {
        window._savePackingOriginal = window.savePacking;
        window.savePacking = function(){ openPackingConfirmModal(); };
        bindModalControls();
      }
    });
  }
})();
</script>

</body>
</html>
